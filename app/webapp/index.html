<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ä–∞—Å—Ç–∞–º–æ–∂–∫–∏ –∞–≤—Ç–æ</title>
    <!-- PWA –º–∞–Ω–∏—Ñ–µ—Å—Ç (absolute path to work under /web/) -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2481cc">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="–†–∞—Å—Ç–∞–º–æ–∂–∫–∞">
    <!-- Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Relative stylesheet path for both desktop and Telegram WebApp -->
    <link rel="stylesheet" href="styles.css">
    <noscript>–î–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω—É–∂–µ–Ω JavaScript</noscript>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöó –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ä–∞—Å—Ç–∞–º–æ–∂–∫–∏</h1>
            <p>–†–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ –ø–æ–ª–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—è —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö —Å–±–æ—Ä–æ–≤</p>
        </div>

        <form id="calculatorForm">
            <div class="form-card">
                <div class="form-group">
                    <label>–°—Ç—Ä–∞–Ω–∞ –ø–æ–∫—É–ø–∫–∏ <span class="required">*</span></label>
                    <div class="country-grid">
                        <div class="country-btn" data-country="japan">
                            <span class="flag">üáØüáµ</span>–Ø–ø–æ–Ω–∏—è
                        </div>
                        <div class="country-btn" data-country="korea">
                            <span class="flag">üá∞üá∑</span>–ö–æ—Ä–µ—è
                        </div>
                        <div class="country-btn" data-country="uae">
                            <span class="flag">üá¶üá™</span>–û–ê–≠
                        </div>
                        <div class="country-btn" data-country="china">
                            <span class="flag">üá®üá≥</span>–ö–∏—Ç–∞–π
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="year">–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞ <span class="required">*</span></label>
                    <input type="number" id="year" name="year" min="1990" max="2025" required>
                </div>

                <div class="form-group">
                    <label for="engineCc">–û–±—ä–µ–º –¥–≤–∏–≥–∞—Ç–µ–ª—è (—Å–º¬≥) <span class="required">*</span></label>
                    <input type="number" id="engineCc" name="engineCc" min="500" max="10000" step="50" required>
                </div>

                <div class="form-group">
                    <label>–¶–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏ <span class="required">*</span></label>
                    <div class="input-group">
                        <input type="number" id="purchasePrice" name="purchasePrice" min="1" step="0.01" required>
                        <select id="currency" name="currency" class="currency-select" required>
                            <option value="JPY">JPY</option>
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                            <option value="CNY">CNY</option>
                            <option value="AED">AED</option>
                        </select>
                    </div>
                </div>

                <div class="form-group freight-options" id="freightOptions">
                    <label>–¢–∏–ø —Ñ—Ä–∞—Ö—Ç–∞</label>
                    <div class="freight-grid" id="freightGrid">
                        <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è -->
                    </div>
                </div>
            </div>

            <button type="submit" class="calculate-btn" id="calculateBtn">
                –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å
            </button>
        </form>

        <div class="result-card" id="resultCard">
            <div class="result-total">
                <div class="amount" id="totalAmount">0 ‚ÇΩ</div>
                <div class="label">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</div>
            </div>

            <div id="breakdown">
                <!-- –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤ -->
            </div>

            <div class="meta-info" id="metaInfo">
                <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            </div>

            <button class="share-btn" id="shareBtn" style="display: none;">
                üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
            </button>
        </div>

        <div class="loading" id="loading" style="display: none;">
            –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å...
        </div>

        <div class="error" id="error" style="display: none;"></div>
    </div>

    <script>
        // =====================================================================
        // Enhanced API and Security Layer with ngrok bypass
        // =====================================================================
        class SecureAPI {
            constructor() {
                this.baseURL = this.resolveBaseURL();
                this.retryAttempts = 3;
                this.retryDelay = 1000;
                this.timeout = 10000;
                this.csrfToken = null;
                this.initCSRF();
            }

            resolveBaseURL() {
                try {
                    const params = new URLSearchParams(location.search);
                    const override = params.get('api_base');
                    if (override) return override.replace(/\/$/, '');

                    // Fix for Telegram WebApp: when served from external domain (ngrok),
                    // API should also use the same domain, not localhost
                    if (location.protocol === 'https:' || location.protocol === 'http:') {
                        const currentHost = location.host;

                        // If we're on ngrok or external domain, use same host for API
                        if (currentHost.includes('ngrok') || !currentHost.includes('localhost')) {
                            return `${location.protocol}//${currentHost}`;
                        }

                        // For localhost development, use localhost
                        return `${location.protocol}//${location.host}`;
                    }

                    // Fallback for file:// or other protocols
                    return window.location.hostname ? `https://${window.location.hostname}` : '';
                } catch (error) {
                    console.warn('Failed to resolve base URL:', error);
                    return '';
                }
            }

            async initCSRF() {
                try {
                    // In real app, fetch CSRF token from server
                    this.csrfToken = this.generateCSRFToken();
                } catch (error) {
                    console.warn('CSRF initialization failed:', error);
                }
            }

            generateCSRFToken() {
                return 'csrf_' + Math.random().toString(36).substr(2, 15);
            }

            getURL(path) {
                if (path.startsWith('http')) return path;
                if (this.baseURL) return this.baseURL + path;
                return path;
            }

            async fetchWithRetry(url, options = {}) {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), this.timeout);

                const fetchOptions = {
                    ...options,
                    signal: controller.signal,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        // Enhanced ngrok bypass headers for Telegram WebApp
                        'ngrok-skip-browser-warning': 'true',
                        'User-Agent': 'Mozilla/5.0 (compatible; TelegramWebApp)',
                        'Accept': 'application/json, text/plain, */*',
                        'Cache-Control': 'no-cache',
                        ...(this.csrfToken && { 'X-CSRF-Token': this.csrfToken }),
                        ...options.headers
                    }
                };

                let lastError;

                for (let attempt = 0; attempt < this.retryAttempts; attempt++) {
                    try {
                        const response = await fetch(url, fetchOptions);
                        clearTimeout(timeoutId);

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        return response;
                    } catch (error) {
                        lastError = error;
                        console.warn(`Request attempt ${attempt + 1} failed:`, error.message);

                        if (attempt < this.retryAttempts - 1) {
                            await this.delay(this.retryDelay * Math.pow(2, attempt));
                        }
                    }
                }

                clearTimeout(timeoutId);
                throw lastError;
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            async get(path) {
                const response = await this.fetchWithRetry(this.getURL(path));
                return response.json();
            }

            async post(path, data) {
                const response = await this.fetchWithRetry(this.getURL(path), {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                return response.json();
            }
        }

        // =====================================================================
        // Enhanced Telegram Integration
        // =====================================================================
        class TelegramWebAppHelper {
            constructor() {
                this.tg = window.Telegram?.WebApp;
                this.isValid = false;
                this.init();
            }

            init() {
                if (!this.tg) {
                    console.warn('Telegram WebApp API not available');
                    return;
                }

                try {
                    this.tg.ready();
                    this.tg.expand();
                    this.applyTheme();
                    this.setupEventListeners();
                    this.isValid = true;

                    console.log('Telegram WebApp initialized successfully');
                } catch (error) {
                    console.error('Telegram WebApp initialization failed:', error);
                }
            }

            applyTheme() {
                const themeParams = this.tg.themeParams;
                if (!themeParams) return;

                const root = document.documentElement;
                const cssVariables = {
                    '--tg-bg-color': themeParams.bg_color || '#ffffff',
                    '--tg-text-color': themeParams.text_color || '#000000',
                    '--tg-hint-color': themeParams.hint_color || '#707579',
                    '--tg-link-color': themeParams.link_color || '#2481cc',
                    '--tg-button-color': themeParams.button_color || '#2481cc',
                    '--tg-button-text-color': themeParams.button_text_color || '#ffffff',
                    '--tg-secondary-bg-color': themeParams.secondary_bg_color || '#f1f1f1'
                };

                Object.entries(cssVariables).forEach(([property, value]) => {
                    if (value) root.style.setProperty(property, value);
                });

                // Update CSS variables to use Telegram theme
                root.style.setProperty('--bg-color', themeParams.bg_color || '#ffffff');
                root.style.setProperty('--text-color', themeParams.text_color || '#000000');
                root.style.setProperty('--hint-color', themeParams.hint_color || '#999999');
                root.style.setProperty('--link-color', themeParams.link_color || '#2481cc');
                root.style.setProperty('--button-color', themeParams.button_color || '#2481cc');
                root.style.setProperty('--button-text-color', themeParams.button_text_color || '#ffffff');
                root.style.setProperty('--secondary-bg-color', themeParams.secondary_bg_color || '#f1f1f1');
            }

            setupEventListeners() {
                // Handle main button
                this.tg.MainButton.setText('–†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å');
                this.tg.MainButton.onClick(() => {
                    const event = new Event('submit', { bubbles: true, cancelable: true });
                    document.getElementById('calculatorForm').dispatchEvent(event);
                });

                // Handle back button
                this.tg.BackButton.onClick(() => {
                    const resultCard = document.getElementById('resultCard');
                    if (resultCard.classList.contains('show')) {
                        hideResult();
                        this.hideBackButton();
                        this.showMainButton();
                    } else {
                        this.tg.close();
                    }
                });

                // Handle theme changes
                this.tg.onEvent('themeChanged', () => {
                    this.applyTheme();
                });
            }

            showMainButton(text = '–†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å') {
                if (!this.isValid) return;
                this.tg.MainButton.setText(text);
                this.tg.MainButton.show();
                this.tg.MainButton.enable();
            }

            hideMainButton() {
                if (!this.isValid) return;
                this.tg.MainButton.hide();
            }

            showBackButton() {
                if (!this.isValid) return;
                this.tg.BackButton.show();
            }

            hideBackButton() {
                if (!this.isValid) return;
                this.tg.BackButton.hide();
            }

            setMainButtonLoading(loading = true) {
                if (!this.isValid) return;

                if (loading) {
                    this.tg.MainButton.showProgress();
                    this.tg.MainButton.disable();
                } else {
                    this.tg.MainButton.hideProgress();
                    this.tg.MainButton.enable();
                }
            }

            sendData(data) {
                if (!this.isValid) return;

                try {
                    this.tg.sendData(JSON.stringify(data));
                } catch (error) {
                    console.error('Failed to send data to Telegram:', error);
                    this.showAlert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                }
            }

            showAlert(message) {
                if (!this.isValid) return;
                this.tg.showAlert(message);
            }

            hapticFeedback(type = 'light') {
                if (!this.isValid || !this.tg.HapticFeedback) return;

                try {
                    if (type === 'light') {
                        this.tg.HapticFeedback.impactOccurred('light');
                    } else if (type === 'medium') {
                        this.tg.HapticFeedback.impactOccurred('medium');
                    } else if (type === 'heavy') {
                        this.tg.HapticFeedback.impactOccurred('heavy');
                    }
                } catch (error) {
                    console.warn('Haptic feedback failed:', error);
                }
            }

            close() {
                if (!this.isValid) return;
                this.tg.close();
            }

            isInTelegram() {
                return this.isValid;
            }
        }

        // Initialize API and Telegram integration
        const api = new SecureAPI();
        const telegram = new TelegramWebAppHelper();

        // Country to currency mapping
        const countryCurrency = {
            japan: 'JPY',
            korea: 'USD',
            uae: 'AED',
            china: 'CNY'
        };

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let selectedCountry = null;
        let selectedFreightType = null;
        let metaData = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            loadMetaData();
            setupEventListeners();
            setCurrentYear();

            // Show main button in Telegram
            if (telegram.isInTelegram()) {
                telegram.showMainButton();
            }
        });

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker –¥–ª—è PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('SW registered: ', registration);
                    })
                    .catch(function(registrationError) {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –æ —Å—Ç—Ä–∞–Ω–∞—Ö –∏ —Ç–∏–ø–∞—Ö —Ñ—Ä–∞—Ö—Ç–∞
        async function loadMetaData() {
            try {
                const response = await api.get('/api/meta');
                metaData = response;
                console.log('Meta data loaded:', metaData);
            } catch (error) {
                console.error('Failed to load meta data:', error);
                // Fallback data for offline usage
                metaData = {
                    countries: [
                        { code: 'japan', label: '–Ø–ø–æ–Ω–∏—è', emoji: 'üáØüáµ', purchase_currency: 'JPY', freight_types: ['standard'] },
                        { code: 'korea', label: '–ö–æ—Ä–µ—è', emoji: 'üá∞üá∑', purchase_currency: 'USD', freight_types: ['standard'] },
                        { code: 'uae', label: '–û–ê–≠', emoji: 'üá¶üá™', purchase_currency: 'AED', freight_types: ['open', 'container'] },
                        { code: 'china', label: '–ö–∏—Ç–∞–π', emoji: 'üá®üá≥', purchase_currency: 'CNY', freight_types: ['open'] }
                    ],
                    freight_type_labels: {
                        standard: '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π',
                        open: '–û—Ç–∫—Ä—ã—Ç—ã–π',
                        container: '–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä'
                    }
                };
            }
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –≥–æ–¥–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        function setCurrentYear() {
            const yearInput = document.getElementById('year');
            yearInput.value = new Date().getFullYear();
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function setupEventListeners() {
            // –í—ã–±–æ—Ä —Å—Ç—Ä–∞–Ω—ã
            document.querySelectorAll('.country-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    selectCountry(this.dataset.country);
                    telegram.hapticFeedback('light');
                });
            });

            // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
            document.getElementById('calculatorForm').addEventListener('submit', function(e) {
                e.preventDefault();
                calculateCost();
            });

            // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω—ã - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∞–ª—é—Ç—ã
            document.addEventListener('countryChanged', updateCurrencyAndFreight);

            // –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
            document.getElementById('shareBtn').addEventListener('click', function() {
                shareResult();
            });
        }

        // –í—ã–±–æ—Ä —Å—Ç—Ä–∞–Ω—ã
        function selectCountry(country) {
            selectedCountry = country;

            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            document.querySelectorAll('.country-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-country="${country}"]`).classList.add('active');

            // –¢—Ä–∏–≥–≥–µ—Ä–∏–º —Å–æ–±—ã—Ç–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω—ã
            document.dispatchEvent(new CustomEvent('countryChanged', { detail: country }));

            // Update main button state
            updateMainButtonState();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∞–ª—é—Ç—ã –∏ –æ–ø—Ü–∏–π —Ñ—Ä–∞—Ö—Ç–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Å—Ç—Ä–∞–Ω—ã
        function updateCurrencyAndFreight() {
            if (!metaData || !selectedCountry) return;

            const countryData = metaData.countries.find(c => c.code === selectedCountry);
            if (!countryData) return;

            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∞–ª—é—Ç—É
            const currencySelect = document.getElementById('currency');
            if (countryData.purchase_currency) {
                currencySelect.value = countryData.purchase_currency;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–ø—Ü–∏–∏ —Ñ—Ä–∞—Ö—Ç–∞
            updateFreightOptions(countryData.freight_types);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–ø—Ü–∏–π —Ñ—Ä–∞—Ö—Ç–∞
        function updateFreightOptions(freightTypes) {
            const freightOptions = document.getElementById('freightOptions');
            const freightGrid = document.getElementById('freightGrid');

            if (!freightTypes || freightTypes.length === 0) {
                freightOptions.classList.remove('show');
                return;
            }

            freightOptions.classList.add('show');
            freightGrid.innerHTML = '';

            const freightLabels = metaData.freight_type_labels || {};

            freightTypes.forEach(type => {
                const btn = document.createElement('div');
                btn.className = 'freight-btn';
                btn.dataset.freight = type;
                btn.textContent = freightLabels[type] || type;

                btn.addEventListener('click', function() {
                    selectFreightType(type);
                    telegram.hapticFeedback('light');
                });

                freightGrid.appendChild(btn);
            });

            // –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π —Ç–∏–ø –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            if (freightTypes.length > 0) {
                selectFreightType(freightTypes[0]);
            }
        }

        // –í—ã–±–æ—Ä —Ç–∏–ø–∞ —Ñ—Ä–∞—Ö—Ç–∞
        function selectFreightType(type) {
            selectedFreightType = type;
            document.querySelectorAll('.freight-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`[data-freight="${type}"]`);
            if (activeBtn) activeBtn.classList.add('active');
        }

        // Update main button state based on form validity
        function updateMainButtonState() {
            if (!telegram.isInTelegram()) return;
            if (!selectedCountry) { telegram.hideMainButton(); return; }
            const formData = new FormData(document.getElementById('calculatorForm'));
            const isValid = formData.get('year') && formData.get('engineCc') && formData.get('purchasePrice');
            if (isValid) telegram.showMainButton('–†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å'); else telegram.hideMainButton();
        }

        document.getElementById('calculatorForm').addEventListener('input', updateMainButtonState);
        document.addEventListener('countryChanged', updateMainButtonState);

        function validateForm() {
            const year = parseInt(document.getElementById('year').value);
            const currentYear = new Date().getFullYear();
            if (year > currentYear) { showError('–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ —Ç–µ–∫—É—â–µ–≥–æ'); return false; }
            if (year < 1990) { showError('–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 1990'); return false; }
            const engineCc = parseInt(document.getElementById('engineCc').value);
            if (engineCc < 500 || engineCc > 10000) { showError('–û–±—ä–µ–º –¥–≤–∏–≥–∞—Ç–µ–ª—è –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 500 –¥–æ 10000 —Å–º¬≥'); return false; }
            const price = parseFloat(document.getElementById('purchasePrice').value);
            if (price <= 0) { showError('–¶–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0'); return false; }
            return true;
        }

        async function calculateCost() {
            if (!selectedCountry) { showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É –ø–æ–∫—É–ø–∫–∏'); return; }
            if (!validateForm()) return;
            const formData = new FormData(document.getElementById('calculatorForm'));
            const requestData = {
                country: selectedCountry,
                year: parseInt(formData.get('year')),
                engine_cc: parseInt(formData.get('engineCc')),
                purchase_price: parseFloat(formData.get('purchasePrice')),
                currency: formData.get('currency'),
                freight_type: selectedFreightType
            };
            showLoading(true); hideError(); hideResult();
            try {
                telegram.setMainButtonLoading(true);
                const result = await api.post('/api/calculate', requestData);
                displayResult(result);
                if (telegram.isInTelegram()) { telegram.hapticFeedback('medium'); telegram.hideMainButton(); telegram.showBackButton(); }
            } catch (error) {
                console.error('Calculation error:', error); showError('–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞: ' + error.message); telegram.hapticFeedback('heavy');
            } finally { showLoading(false); telegram.setMainButtonLoading(false); }
        }

        function displayResult(result) {
            const { breakdown, meta } = result;
            document.getElementById('totalAmount').textContent = formatNumber(breakdown.total_rub) + ' ‚ÇΩ';
            const breakdownDiv = document.getElementById('breakdown');
            breakdownDiv.innerHTML = '';
            const items = [
                { label: '–¶–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏', amount: breakdown.purchase_price_rub },
                { label: '–¢–∞–º–æ–∂–µ–Ω–Ω–∞—è –ø–æ—à–ª–∏–Ω–∞', amount: breakdown.duties_rub },
                { label: '–£—Ç–∏–ª–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–π —Å–±–æ—Ä', amount: breakdown.utilization_fee_rub },
                { label: '–¢–∞–º–æ–∂–µ–Ω–Ω–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ', amount: breakdown.customs_services_rub },
                { label: '–≠—Ä–∞-–ì–ª–æ–Ω–∞—Å—Å', amount: breakdown.era_glonass_rub },
                { label: '–§—Ä–∞—Ö—Ç', amount: breakdown.freight_rub },
                { label: '–†–∞—Å—Ö–æ–¥—ã –≤ —Å—Ç—Ä–∞–Ω–µ', amount: breakdown.country_expenses_rub },
                { label: '–ö–æ–º–∏—Å—Å–∏—è –∫–æ–º–ø–∞–Ω–∏–∏', amount: breakdown.company_commission_rub }
            ];
            items.forEach(item => { if (item.amount > 0) { const div = document.createElement('div'); div.className='breakdown-item'; div.innerHTML=`<span class="breakdown-label">${item.label}</span><span class="breakdown-amount">${formatNumber(item.amount)} ‚ÇΩ</span>`; breakdownDiv.appendChild(div);} });
            const totalDiv = document.createElement('div'); totalDiv.className='breakdown-item'; totalDiv.innerHTML=`<span class="breakdown-label">–ò–¢–û–ì–û</span><span class="breakdown-amount">${formatNumber(breakdown.total_rub)} ‚ÇΩ</span>`; breakdownDiv.appendChild(totalDiv);
            const metaDiv = document.getElementById('metaInfo');
            metaDiv.innerHTML = `
                <div>–í–æ–∑—Ä–∞—Å—Ç –∞–≤—Ç–æ: ${meta.age_years} –ª–µ—Ç (${getAgeCategory(meta.age_category)})</div>
                <div>–û–±—ä–µ–º –¥–≤–∏–≥–∞—Ç–µ–ª—è: ${meta.volume_band}</div>
                ${meta.warnings && meta.warnings.length ? '<div style="color:#e74c3c;margin-top:8px;">‚ö†Ô∏è ' + meta.warnings.map(w=>w.message).join('<br>‚ö†Ô∏è ') + '</div>' : ''}
            `;
            document.getElementById('resultCard').classList.add('show');
            document.getElementById('shareBtn').style.display='block';
            window.lastCalculationResult = result;
        }

        function shareResult() {
            if (!window.lastCalculationResult) return;
            const result = document.getElementById('totalAmount').textContent;
            const shareText = `üöó –†–∞—Å—á–µ—Ç —Ä–∞—Å—Ç–∞–º–æ–∂–∫–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –∏–∑ ${getCountryName(selectedCountry)}: ${result}`;
            if (telegram.isInTelegram()) {
                telegram.sendData({ action: 'share_result', text: shareText, total: window.lastCalculationResult.breakdown.total_rub, country: selectedCountry });
                showToast('–†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —á–∞—Ç','success');
            } else if (navigator.share) {
                navigator.share({ title: '–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ä–∞—Å—Ç–∞–º–æ–∂–∫–∏', text: shareText, url: location.href });
            } else {
                navigator.clipboard.writeText(shareText).then(()=>showToast('–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω','success'));
            }
        }

        function getCountryName(country) { return { japan:'–Ø–ø–æ–Ω–∏–∏', korea:'–ö–æ—Ä–µ–∏', uae:'–û–ê–≠', china:'–ö–∏—Ç–∞—è' }[country] || country; }
        function formatNumber(n){ return new Intl.NumberFormat('ru-RU').format(n); }
        function getAgeCategory(c){ return { lt3:'–¥–æ 3 –ª–µ—Ç', '3_5':'3-5 –ª–µ—Ç (–ø—Ä–æ—Ö–æ–¥–Ω—ã–µ)', gt5:'—Å–≤—ã—à–µ 5 –ª–µ—Ç' }[c] || c; }
        function showLoading(show){ document.getElementById('loading').style.display = show?'block':'none'; document.getElementById('calculateBtn').disabled=show; }
        function showError(msg){ const e=document.getElementById('error'); e.textContent=msg; e.style.display='block'; }
        function hideError(){ document.getElementById('error').style.display='none'; }
        function hideResult(){ document.getElementById('resultCard').classList.remove('show'); document.getElementById('shareBtn').style.display='none'; }
        function showToast(message,type='info'){ const t=document.createElement('div'); t.className=`toast ${type}`; t.textContent=message; t.style.cssText=`position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:${type==='success'?'#10b981':type==='error'?'#ef4444':'#3b82f6'};color:#fff;padding:12px 24px;border-radius:8px;z-index:1000;animation:slideUp .3s ease-out;`; document.body.appendChild(t); setTimeout(()=>t.remove(),3000); }
    </script>
</body>
</html>
