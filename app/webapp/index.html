<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Калькулятор растаможки авто</title>
    <!-- PWA манифест (absolute path to work under /web/) -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2481cc">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Растаможка">
    <!-- Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #ffffff);
            --text-color: var(--tg-theme-text-color, #000000);
            --hint-color: var(--tg-theme-hint-color, #999999);
            --link-color: var(--tg-theme-link-color, #2481cc);
            --button-color: var(--tg-theme-button-color, #2481cc);
            --button-text-color: var(--tg-theme-button-text-color, #ffffff);
            --secondary-bg-color: var(--tg-theme-secondary-bg-color, #f1f1f1);
            --border-radius: 12px;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 16px;
            min-height: 100vh;
            -webkit-user-select: none;
            user-select: none;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            color: var(--hint-color);
            font-size: 14px;
        }

        .form-card {
            background: var(--secondary-bg-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 6px;
            font-size: 14px;
        }

        .required {
            color: #e74c3c;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid transparent;
            border-radius: 8px;
            background: var(--bg-color);
            color: var(--text-color);
            font-size: 16px;
            transition: border-color 0.3s;
            -webkit-appearance: none;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--link-color);
        }

        .input-group {
            display: flex;
            gap: 8px;
        }

        .input-group input {
            flex: 1;
        }

        .currency-select {
            width: 100px;
            flex-shrink: 0;
        }

        /* Новый компактный дизайн выбора страны */
        .country-selector {
            position: relative;
        }

        .country-dropdown {
            width: 100%;
            padding: 12px 40px 12px 12px;
            border: 2px solid var(--hint-color);
            border-radius: 8px;
            background: var(--bg-color);
            color: var(--text-color);
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            -webkit-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23999" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
        }

        .country-dropdown:focus {
            border-color: var(--link-color);
            outline: none;
        }

        .country-dropdown.active {
            border-color: var(--link-color);
        }

        .country-option {
            padding: 8px 12px;
            font-size: 16px;
        }

        .freight-options {
            display: none;
        }

        .freight-options.show {
            display: block;
        }

        .freight-grid {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .freight-btn {
            padding: 8px 12px;
            border: 2px solid var(--hint-color);
            border-radius: 6px;
            background: var(--bg-color);
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
            flex: 1;
            min-width: 80px;
            text-align: center;
            -webkit-tap-highlight-color: transparent;
        }

        .freight-btn:hover, .freight-btn.active {
            border-color: var(--link-color);
            background: var(--link-color);
            color: var(--button-text-color);
        }

        .calculate-btn {
            width: 100%;
            padding: 16px;
            background: var(--button-color);
            color: var(--button-text-color);
            border: none;
            border-radius: var(--border-radius);
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 16px;
            -webkit-tap-highlight-color: transparent;
        }

        .calculate-btn:hover {
            opacity: 0.9;
            transform: scale(0.98);
        }

        .calculate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .result-card {
            background: var(--secondary-bg-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 16px;
            box-shadow: var(--shadow);
            display: none;
            animation: slideUp 0.3s ease-out;
        }

        .result-card.show {
            display: block;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-total {
            text-align: center;
            margin-bottom: 20px;
            padding: 16px;
            background: var(--button-color);
            color: var(--button-text-color);
            border-radius: 8px;
        }

        .result-total .amount {
            font-size: 28px;
            font-weight: 700;
        }

        .result-total .label {
            font-size: 14px;
            opacity: 0.9;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--hint-color);
        }

        .breakdown-item:last-child {
            border-bottom: none;
            font-weight: 600;
            margin-top: 8px;
            padding-top: 16px;
            border-top: 2px solid var(--hint-color);
        }

        .breakdown-label {
            font-size: 14px;
        }

        .breakdown-amount {
            font-weight: 500;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--hint-color);
        }

        .loading:after {
            content: "";
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--hint-color);
            border-radius: 50%;
            border-top-color: var(--link-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-top: 16px;
            font-size: 14px;
            border-left: 4px solid #c33;
        }

        .meta-info {
            margin-top: 16px;
            padding: 12px;
            background: var(--bg-color);
            border-radius: 8px;
            font-size: 12px;
            color: var(--hint-color);
        }

        .share-btn {
            margin-top: 16px;
            padding: 12px;
            background: transparent;
            color: var(--link-color);
            border: 2px solid var(--link-color);
            border-radius: 8px;
            width: 100%;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .share-btn:hover {
            background: var(--link-color);
            color: var(--button-text-color);
        }

        /* Tabs UI */
        .tabs { margin-top: 8px; }
        .tab-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .tab-btn {
            flex: 1;
            padding: 10px 12px;
            border-radius: 8px;
            border: 2px solid var(--hint-color);
            background: var(--bg-color);
            color: var(--text-color);
            font-weight: 600;
            cursor: pointer;
            transition: all .2s ease;
            -webkit-tap-highlight-color: transparent;
        }
        .tab-btn.active {
            border-color: var(--link-color);
            background: var(--secondary-bg-color);
            color: var(--text-color);
        }
        .tab-panes { width: 100%; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        /* Back button on results tab */
        .back-btn {
            margin-top: 12px;
            padding: 12px;
            background: transparent;
            color: var(--link-color);
            border: 2px solid var(--link-color);
            border-radius: 8px;
            width: 100%;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .back-btn:hover {
            background: var(--link-color);
            color: var(--button-text-color);
        }
        /* Hide tab navigation from the top UI */
        .tab-nav { display: none !important; }
    </style>
    <noscript>Для работы приложения нужен JavaScript</noscript>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚗 Калькулятор растаможки</h1>
            <p>Рассчитайте полную стоимость автомобиля с учетом всех сборов</p>
        </div>

        <form id="calculatorForm">
            <div class="form-card">
                <div class="form-group">
                    <label>Страна покупки <span class="required">*</span></label>
                    <div class="country-selector">
                        <select id="countrySelect" class="country-dropdown" required>
                            <option value="">Выберите страну</option>
                            <option value="japan" class="country-option">🇯🇵 Япония</option>
                            <option value="korea" class="country-option">🇰🇷 Корея</option>
                            <option value="uae" class="country-option">🇦🇪 ОАЭ</option>
                            <option value="china" class="country-option">🇨🇳 Китай</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="year">Год выпуска <span class="required">*</span></label>
                    <input type="number" id="year" name="year" min="1990" max="2025" required>
                </div>

                <div class="form-group">
                    <label for="engineCc">Объем двигателя (см³) <span class="required">*</span></label>
                    <input type="number" id="engineCc" name="engineCc" min="500" max="10000" step="50" required>
                </div>

                <div class="form-group">
                    <label>Цена покупки <span class="required">*</span></label>
                    <div class="input-group">
                        <input type="number" id="purchasePrice" name="purchasePrice" min="1" step="0.01" required>
                        <select id="currency" name="currency" class="currency-select" required>
                            <option value="JPY">JPY</option>
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                            <option value="CNY">CNY</option>
                            <option value="AED">AED</option>
                        </select>
                    </div>
                </div>

                <div class="form-group freight-options" id="freightOptions">
                    <label>Тип фрахта</label>
                    <div class="freight-grid" id="freightGrid">
                        <!-- Динамически заполняется -->
                    </div>
                </div>
            </div>

            <button type="submit" class="calculate-btn" id="calculateBtn">
                Рассчитать стоимость
            </button>
        </form>

        <div class="result-card" id="resultCard">
            <div class="result-total">
                <div class="amount" id="totalAmount">0 ₽</div>
                <div class="label">Общая стоимость</div>
            </div>

            <div id="breakdown">
                <!-- Детализация расходов -->
            </div>

            <div class="meta-info" id="metaInfo">
                <!-- Дополнительная информация -->
            </div>

            <button class="share-btn" id="shareBtn" style="display: none;">
                📤 Поделиться результатом
            </button>
        </div>

        <div class="loading" id="loading" style="display: none;">
            Рассчитываем стоимость...
        </div>

        <div class="error" id="error" style="display: none;"></div>
    </div>

    <script>
        // =====================================================================
        // Enhanced API and Security Layer with ngrok bypass
        // =====================================================================
        class SecureAPI {
            constructor() {
                this.baseURL = this.resolveBaseURL();
                this.retryAttempts = 3;
                this.retryDelay = 1000;
                this.timeout = 10000;
                this.csrfToken = null;
                this.initCSRF();
            }

            resolveBaseURL() {
                try {
                    const params = new URLSearchParams(location.search);
                    const override = params.get('api_base');
                    if (override) return override.replace(/\/$/, '');

                    if (location.protocol === 'https:' || location.protocol === 'http:') {
                        const currentHost = location.host;
                        if (currentHost.includes('ngrok') || !currentHost.includes('localhost')) {
                            return `${location.protocol}//${currentHost}`;
                        }
                        return `${location.protocol}//${location.host}`;
                    }
                    return window.location.hostname ? `https://${window.location.hostname}` : '';
                } catch (error) {
                    console.warn('Failed to resolve base URL:', error);
                    return '';
                }
            }

            async initCSRF() {
                try {
                    this.csrfToken = this.generateCSRFToken();
                } catch (error) {
                    console.warn('CSRF initialization failed:', error);
                }
            }

            generateCSRFToken() {
                return 'csrf_' + Math.random().toString(36).substr(2, 15);
            }

            getURL(path) {
                if (path.startsWith('http')) return path;
                if (this.baseURL) return this.baseURL + path;
                return path;
            }

            async fetchWithRetry(url, options = {}) {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), this.timeout);

                const fetchOptions = {
                    ...options,
                    signal: controller.signal,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'ngrok-skip-browser-warning': 'true',
                        'User-Agent': 'Mozilla/5.0 (compatible; TelegramWebApp)',
                        'Accept': 'application/json, text/plain, */*',
                        'Cache-Control': 'no-cache',
                        ...(this.csrfToken && { 'X-CSRF-Token': this.csrfToken }),
                        ...options.headers
                    }
                };

                let lastError;

                for (let attempt = 0; attempt < this.retryAttempts; attempt++) {
                    try {
                        const response = await fetch(url, fetchOptions);
                        clearTimeout(timeoutId);

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        return response;
                    } catch (error) {
                        lastError = error;
                        console.warn(`Request attempt ${attempt + 1} failed:`, error.message);

                        if (attempt < this.retryAttempts - 1) {
                            await this.delay(this.retryDelay * Math.pow(2, attempt));
                        }
                    }
                }

                clearTimeout(timeoutId);
                throw lastError;
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            async get(path) {
                const response = await this.fetchWithRetry(this.getURL(path));
                return response.json();
            }

            async post(path, data) {
                const response = await this.fetchWithRetry(this.getURL(path), {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                return response.json();
            }
        }

        // =====================================================================
        // Enhanced Telegram Integration
        // =====================================================================
        class TelegramWebAppHelper {
            constructor() {
                this.tg = window.Telegram?.WebApp;
                this.isValid = false;
                this.init();
            }

            detectInTelegram() {
                try {
                    if (!this.tg) return false;
                    const hasInitData = typeof this.tg.initData === 'string' && this.tg.initData.length > 0;
                    const hasUser = !!this.tg.initDataUnsafe?.user;
                    return hasInitData || hasUser;
                } catch (e) {
                    return false;
                }
            }

            canSendData() {
                // Runtime check whether Telegram can accept sendData from this context
                try {
                    if (!this.tg) return false;
                    const hasInitData = typeof this.tg.initData === 'string' && this.tg.initData.length > 0;
                    const hasUser = !!this.tg.initDataUnsafe?.user;
                    return hasInitData || hasUser;
                } catch (e) {
                    return false;
                }
            }

            init() {
                if (!this.tg) {
                    console.warn('Telegram WebApp API not available');
                    return;
                }

                // Keep UI features behind isValid; evaluate after ready
                try {
                    this.tg.ready();
                    this.tg.expand();
                    // After ready, re-evaluate environment
                    this.isValid = this.detectInTelegram();
                    this.applyTheme();
                    if (this.isValid) this.setupEventListeners();
                    console.log('Telegram WebApp initialized (isValid:', this.isValid, ')');
                } catch (error) {
                    console.error('Telegram WebApp initialization failed:', error);
                    this.isValid = false;
                }
            }

            applyTheme() {
                const themeParams = this.tg.themeParams;
                if (!themeParams) return;

                const root = document.documentElement;
                const cssVariables = {
                    '--tg-bg-color': themeParams.bg_color || '#ffffff',
                    '--tg-text-color': themeParams.text_color || '#000000',
                    '--tg-hint-color': themeParams.hint_color || '#707579',
                    '--tg-link-color': themeParams.link_color || '#2481cc',
                    '--tg-button-color': themeParams.button_color || '#2481cc',
                    '--tg-button-text-color': themeParams.button_text_color || '#ffffff',
                    '--tg-secondary-bg-color': themeParams.secondary_bg_color || '#f1f1f1'
                };

                Object.entries(cssVariables).forEach(([property, value]) => {
                    if (value) root.style.setProperty(property, value);
                });
            }

            setupEventListeners() {
                this.tg.MainButton.setText('Рассчитать стоимость');
                this.tg.MainButton.onClick(() => {
                    const event = new Event('submit', { bubbles: true, cancelable: true });
                    document.getElementById('calculatorForm').dispatchEvent(event);
                });

                this.tg.BackButton.onClick(() => {
                    const resultCard = document.getElementById('resultCard');
                    if (resultCard.classList.contains('show')) {
                        hideResult();
                        this.hideBackButton();
                        this.showMainButton();
                    } else {
                        this.tg.close();
                    }
                });

                this.tg.onEvent('themeChanged', () => {
                    this.applyTheme();
                });
            }

            showMainButton(text = 'Рассчитать стоимость') {
                if (!this.isValid) return;
                this.tg.MainButton.setText(text);
                this.tg.MainButton.show();
                this.tg.MainButton.enable();
            }

            hideMainButton() {
                if (!this.isValid) return;
                this.tg.MainButton.hide();
            }

            showBackButton() {
                if (!this.isValid) return;
                this.tg.BackButton.show();
            }

            hideBackButton() {
                if (!this.isValid) return;
                this.tg.BackButton.hide();
            }

            setMainButtonLoading(loading = true) {
                if (!this.isValid) return;

                if (loading) {
                    this.tg.MainButton.showProgress();
                    this.tg.MainButton.disable();
                } else {
                    this.tg.MainButton.hideProgress();
                    this.tg.MainButton.enable();
                }
            }

            // Helper: count UTF-8 bytes of a string
            byteLength(str) {
                try {
                    return new TextEncoder().encode(str).length;
                } catch (_) {
                    // Fallback approximate length
                    return (str || '').length;
                }
            }

            sendData(data) {
                // Allow sendData if Telegram object is present and initData/user available now
                if (!this.tg || !this.canSendData()) return;
                try {
                    this.tg.sendData(JSON.stringify(data));
                } catch (error) {
                    console.error('Failed to send data to Telegram:', error);
                    try { this.showAlert('Ошибка отправки данных'); } catch (_) {}
                }
            }

            // Safe variant that keeps payload under Telegram limit (4096 bytes)
            sendDataSafe(data) {
                if (!this.tg || !this.canSendData()) return false;
                const LIMIT = 4096;
                let payload = typeof data === 'string' ? data : JSON.stringify(data);
                let size = this.byteLength(payload);

                console.log('[DEBUG] Sending data to Telegram, size:', size, 'bytes');
                console.log('[DEBUG] Payload preview:', payload.substring(0, 200) + (payload.length > 200 ? '...' : ''));

                if (size > LIMIT) {
                    console.warn('[Telegram] Payload too large:', size, 'bytes. Trimming...');
                    // Build minimal payload
                    const minimal = {
                        action: (data && data.action) || 'share_result',
                        summary: (data && data.summary) || (data && data.text) || 'Расчет готов',
                        total: data?.total ?? data?.total_rub,
                        country: data?.country,
                        year: data?.year,
                        engine_cc: data?.engine_cc
                    };
                    // Ensure summary fits
                    let summary = minimal.summary || '';
                    // Leave ~300 bytes for the rest of fields/overhead
                    const reserveBytes = 300;
                    const maxSummaryBytes = Math.max(0, LIMIT - reserveBytes - this.byteLength(JSON.stringify({ ...minimal, summary: '' })));
                    const truncateToBytes = (s, maxBytes) => {
                        if (this.byteLength(s) <= maxBytes) return s;
                        // naive truncation by characters until fits
                        let low = 0, high = s.length;
                        while (low < high) {
                            const mid = Math.floor((low + high) / 2);
                            const candidate = s.slice(0, mid) + '…';
                            if (this.byteLength(candidate) <= maxBytes) low = mid + 1; else high = mid;
                        }
                        const finalStr = s.slice(0, Math.max(0, low - 1)) + '…';
                        return finalStr;
                    };
                    minimal.summary = truncateToBytes(summary, maxSummaryBytes);
                    payload = JSON.stringify(minimal);
                    size = this.byteLength(payload);
                    console.warn('[Telegram] Trimmed payload size:', size, 'bytes');
                    try { this.showAlert('Сообщение слишком большое — отправляем краткую сводку'); } catch (_) {}
                }
                try {
                    console.log('[DEBUG] Calling tg.sendData...');
                    this.tg.sendData(payload);
                    console.log('[DEBUG] tg.sendData completed successfully');
                    return true;
                } catch (error) {
                    console.error('Failed to send data to Telegram:', error);
                    try { this.showAlert('Ошибка отправки данных'); } catch (_) {}
                    return false;
                }
            }

            showAlert(message) {
                if (!this.tg) return;
                this.tg.showAlert(message);
            }

            hapticFeedback(type = 'light') {
                if (!this.isValid || !this.tg?.HapticFeedback) return;

                try {
                    if (type === 'light') {
                        this.tg.HapticFeedback.impactOccurred('light');
                    } else if (type === 'medium') {
                        this.tg.HapticFeedback.impactOccurred('medium');
                    } else if (type === 'heavy') {
                        this.tg.HapticFeedback.impactOccurred('heavy');
                    }
                } catch (error) {
                    console.warn('Haptic feedback failed:', error);
                }
            }

            close() {
                if (!this.tg) return;
                this.tg.close();
            }

            isInTelegram() {
                return this.isValid;
            }
        }

        // Tabs helpers
        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));

            const btn = document.getElementById(tabId === 'resultTab' ? 'resultTabBtn' : 'calcTabBtn');
            const pane = document.getElementById(tabId);

            if (btn) btn.classList.add('active');
            if (pane) pane.classList.add('active');
        }
        function showResultsTab() { switchTab('resultTab'); }
        function showCalcTab() { switchTab('calcTab'); }
        function isResultTabActive() {
            const pane = document.getElementById('resultTab');
            return pane ? pane.classList.contains('active') : false;
        }

        function buildTabsUI() {
            const container = document.querySelector('.container');
            const header = container.querySelector('.header');

            const form = document.getElementById('calculatorForm');
            const resultCard = document.getElementById('resultCard');
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');

            // Avoid rebuilding if already built
            if (document.querySelector('.tabs')) return;

            const tabs = document.createElement('div');
            tabs.className = 'tabs';

            const tabNav = document.createElement('div');
            tabNav.className = 'tab-nav';

            const calcTabBtn = document.createElement('button');
            calcTabBtn.className = 'tab-btn active';
            calcTabBtn.id = 'calcTabBtn';
            calcTabBtn.dataset.tab = 'calcTab';
            calcTabBtn.textContent = 'Расчёт';

            const resultTabBtn = document.createElement('button');
            resultTabBtn.className = 'tab-btn';
            resultTabBtn.id = 'resultTabBtn';
            resultTabBtn.dataset.tab = 'resultTab';
            resultTabBtn.textContent = 'Результат';

            tabNav.append(calcTabBtn, resultTabBtn);

            const panes = document.createElement('div');
            panes.className = 'tab-panes';

            const calcPane = document.createElement('div');
            calcPane.className = 'tab-pane active';
            calcPane.id = 'calcTab';

            const resultPane = document.createElement('div');
            resultPane.className = 'tab-pane';
            resultPane.id = 'resultTab';

            // Move existing nodes into panes
            calcPane.appendChild(form);
            calcPane.appendChild(loading);
            calcPane.appendChild(error);

            resultPane.appendChild(resultCard);

            panes.append(calcPane, resultPane);
            tabs.append(tabNav, panes);

            // Insert tabs after header
            header.insertAdjacentElement('afterend', tabs);

            // Ensure a "back" button exists on the Results tab
            let backBtn = document.getElementById('backToCalcBtn');
            if (!backBtn) {
                backBtn = document.createElement('button');
                backBtn.id = 'backToCalcBtn';
                backBtn.className = 'back-btn';
                backBtn.textContent = '↩️ Вернуться к расчётам';
                resultCard.appendChild(backBtn);
            }

            // Wire up events
            calcTabBtn.addEventListener('click', () => {
                hideResult();
                showCalcTab();
                if (telegram.isInTelegram()) {
                    telegram.hideBackButton();
                    telegram.showMainButton();
                }
            });
            resultTabBtn.addEventListener('click', () => {
                showResultsTab();
                if (telegram.isInTelegram()) {
                    const resultCardVisible = document.getElementById('resultCard').classList.contains('show');
                    if (resultCardVisible) {
                        telegram.hideMainButton();
                        telegram.showBackButton();
                    }
                }
            });
            backBtn.addEventListener('click', () => {
                hideResult();
                showCalcTab();
                if (telegram.isInTelegram()) {
                    telegram.hideBackButton();
                    telegram.showMainButton();
                }
            });
        }

        // Initialize API and Telegram integration
        const api = new SecureAPI();
        const telegram = new TelegramWebAppHelper();

        // Глобальные переменные
        let selectedCountry = null;
        let selectedFreightType = null;
        let metaData = null;

        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            buildTabsUI();
            loadMetaData();
            setupEventListeners();
            setCurrentYear();

            // Patch result show/hide to switch tabs
            const originalDisplayResult = window.displayResult;
            const originalHideResult = window.hideResult;
            if (typeof originalDisplayResult === 'function') {
                window.displayResult = function(result) {
                    originalDisplayResult(result);
                    showResultsTab();
                };
            }
            if (typeof originalHideResult === 'function') {
                window.hideResult = function() {
                    originalHideResult();
                    showCalcTab();
                };
            }

            if (telegram.isInTelegram()) {
                // Use only Telegram MainButton, hide in-page calculate button
                const calcBtn = document.getElementById('calculateBtn');
                if (calcBtn) calcBtn.style.display = 'none';
                telegram.showMainButton();
            }
        });

        // Регистрация Service Worker для PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('SW registered: ', registration);
                    })
                    .catch(function(registrationError) {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // Загрузка метаданных о странах и типах фрахта
        async function loadMetaData() {
            try {
                const response = await api.get('/api/meta');
                metaData = response;
                console.log('Meta data loaded:', metaData);
            } catch (error) {
                console.error('Failed to load meta data:', error);
                // Fallback data for offline usage
                metaData = {
                    countries: [
                        { code: 'japan', label: 'Япония', emoji: '🇯🇵', purchase_currency: 'JPY', freight_types: ['standard'] },
                        { code: 'korea', label: 'Корея', emoji: '🇰🇷', purchase_currency: 'USD', freight_types: ['standard'] },
                        { code: 'uae', label: 'ОАЭ', emoji: '🇦🇪', purchase_currency: 'AED', freight_types: ['open', 'container'] },
                        { code: 'china', label: 'Китай', emoji: '🇨🇳', purchase_currency: 'CNY', freight_types: ['open'] }
                    ],
                    freight_type_labels: {
                        standard: 'Стандартный',
                        open: 'Открытый',
                        container: 'Контейнер'
                    }
                };
            }
        }

        // Установка текущего года по умолчанию
        function setCurrentYear() {
            const yearInput = document.getElementById('year');
            yearInput.value = new Date().getFullYear();
        }

        // Настройка обработчиков событий
        function setupEventListeners() {
            // Выбор страны через dropdown
            document.getElementById('countrySelect').addEventListener('change', function() {
                const country = this.value;
                if (country) {
                    selectCountry(country);
                    telegram.hapticFeedback('light');
                }
            });

            // Отправка формы
            document.getElementById('calculatorForm').addEventListener('submit', function(e) {
                e.preventDefault();
                calculateCost();
            });

            // Изменение страны - обновление валюты
            document.addEventListener('countryChanged', updateCurrencyAndFreight);

            // Поделиться результатом
            document.getElementById('shareBtn').addEventListener('click', function() {
                shareResult();
            });

            // Обновление состояния кнопки при вводе данных
            document.getElementById('calculatorForm').addEventListener('input', updateMainButtonState);
        }

        // Выбор страны
        function selectCountry(country) {
            selectedCountry = country;

            // Обновляем визуальное состояние dropdown
            const countrySelect = document.getElementById('countrySelect');
            countrySelect.classList.add('active');

            // Триггерим событие изменения страны
            document.dispatchEvent(new CustomEvent('countryChanged', { detail: country }));

            // Update main button state
            updateMainButtonState();
        }

        // Обновление валюты и опций фрахта при выборе страны
        function updateCurrencyAndFreight() {
            if (!metaData || !selectedCountry) return;

            const countryData = metaData.countries.find(c => c.code === selectedCountry);
            if (!countryData) return;

            // Обновляем валюту
            const currencySelect = document.getElementById('currency');
            if (countryData.purchase_currency) {
                currencySelect.value = countryData.purchase_currency;
            }

            // Обновляем опции фрахта
            updateFreightOptions(countryData.freight_types);
        }

        // Обновление опций фрахта
        function updateFreightOptions(freightTypes) {
            const freightOptions = document.getElementById('freightOptions');
            const freightGrid = document.getElementById('freightGrid');

            if (!freightTypes || freightTypes.length === 0) {
                freightOptions.classList.remove('show');
                return;
            }

            freightOptions.classList.add('show');
            freightGrid.innerHTML = '';

            const freightLabels = metaData.freight_type_labels || {};

            freightTypes.forEach(type => {
                const btn = document.createElement('div');
                btn.className = 'freight-btn';
                btn.dataset.freight = type;
                btn.textContent = freightLabels[type] || type;

                btn.addEventListener('click', function() {
                    selectFreightType(type);
                    telegram.hapticFeedback('light');
                });

                freightGrid.appendChild(btn);
            });

            // Выбираем первый тип по умолчанию
            if (freightTypes.length > 0) {
                selectFreightType(freightTypes[0]);
            }
        }

        // Выбор типа фрахта
        function selectFreightType(type) {
            selectedFreightType = type;
            document.querySelectorAll('.freight-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`[data-freight="${type}"]`);
            if (activeBtn) activeBtn.classList.add('active');
        }

        // Update main button state based on form validity
        function updateMainButtonState() {
            if (!telegram.isInTelegram()) return;
            if (!selectedCountry) {
                telegram.hideMainButton();
                return;
            }
            const formData = new FormData(document.getElementById('calculatorForm'));
            const isValid = formData.get('year') && formData.get('engineCc') && formData.get('purchasePrice');
            if (isValid) {
                telegram.showMainButton('Рассчитать стоимость');
            } else {
                telegram.hideMainButton();
            }
        }

        function validateForm() {
            const year = parseInt(document.getElementById('year').value);
            const currentYear = new Date().getFullYear();
            if (year > currentYear) {
                showError('Год выпуска не может быть больше текущего');
                return false;
            }
            if (year < 1990) {
                showError('Год выпуска должен быть не менее 1990');
                return false;
            }
            const engineCc = parseInt(document.getElementById('engineCc').value);
            if (engineCc < 500 || engineCc > 10000) {
                showError('Объем двигателя должен быть от 500 до 10000 см³');
                return false;
            }
            const price = parseFloat(document.getElementById('purchasePrice').value);
            if (price <= 0) {
                showError('Цена покупки должна быть больше 0');
                return false;
            }
            return true;
        }

        async function calculateCost() {
            if (!selectedCountry) {
                showError('Пожалуйста, выберите страну покупки');
                return;
            }
            if (!validateForm()) return;

            const formData = new FormData(document.getElementById('calculatorForm'));
            const requestData = {
                country: selectedCountry,
                year: parseInt(formData.get('year')),
                engine_cc: parseInt(formData.get('engineCc')),
                purchase_price: parseFloat(formData.get('purchasePrice')),
                currency: formData.get('currency'),
                freight_type: selectedFreightType
            };

            showLoading(true);
            hideError();
            hideResult();

            try {
                telegram.setMainButtonLoading(true);
                const result = await api.post('/api/calculate', requestData);
                displayResult(result);
                if (telegram.isInTelegram()) {
                    telegram.hapticFeedback('medium');
                    telegram.hideMainButton();
                    telegram.showBackButton();
                }
            } catch (error) {
                console.error('Calculation error:', error);
                showError('Ошибка расчета: ' + error.message);
                telegram.hapticFeedback('heavy');
            } finally {
                showLoading(false);
                telegram.setMainButtonLoading(false);
            }
        }

        function displayResult(result) {
            const { breakdown, meta } = result;
            document.getElementById('totalAmount').textContent = formatNumber(breakdown.total_rub) + ' ₽';

            const breakdownDiv = document.getElementById('breakdown');
            breakdownDiv.innerHTML = '';

            const items = [
                { label: 'Цена покупки', amount: breakdown.purchase_price_rub },
                { label: 'Таможенная пошлина', amount: breakdown.duties_rub },
                { label: 'Утилизационный сбор', amount: breakdown.utilization_fee_rub },
                { label: 'Таможенное оформление', amount: breakdown.customs_services_rub },
                { label: 'Эра-Глонасс', amount: breakdown.era_glonass_rub },
                { label: 'Фрахт', amount: breakdown.freight_rub },
                { label: 'Расходы в стране', amount: breakdown.country_expenses_rub },
                { label: 'Комиссия компании', amount: breakdown.company_commission_rub }
            ];

            items.forEach(item => {
                if (item.amount > 0) {
                    const div = document.createElement('div');
                    div.className='breakdown-item';
                    div.innerHTML=`<span class="breakdown-label">${item.label}</span><span class="breakdown-amount">${formatNumber(item.amount)} ₽</span>`;
                    breakdownDiv.appendChild(div);
                }
            });

            const totalDiv = document.createElement('div');
            totalDiv.className='breakdown-item';
            totalDiv.innerHTML=`<span class="breakdown-label">ИТОГО</span><span class="breakdown-amount">${formatNumber(breakdown.total_rub)} ₽</span>`;
            breakdownDiv.appendChild(totalDiv);

            // Engine volume display: fallback to request.engine_cc if meta.volume_band is a placeholder (e.g., 'value_brackets')
            const engineDisplay = (meta && meta.volume_band && meta.volume_band !== 'value_brackets' && meta.volume_band !== 'n/a')
                ? meta.volume_band
                : (result?.request?.engine_cc ? `${result.request.engine_cc} см³` : '—');

            const metaDiv = document.getElementById('metaInfo');
            metaDiv.innerHTML = `
                <div>Возраст авто: ${meta.age_years} лет (${getAgeCategory(meta.age_category)})</div>
                <div>Объем двигателя: ${engineDisplay}</div>
                ${meta.warnings && meta.warnings.length ? '<div style="color:#e74c3c;margin-top:8px;">⚠️ ' + meta.warnings.map(w=>w.message).join('<br>⚠️ ') + '</div>' : ''}
            `;

            document.getElementById('resultCard').classList.add('show');
            document.getElementById('shareBtn').style.display='block';
            window.lastCalculationResult = result;
        }

        function shareResult() {
            if (!window.lastCalculationResult) return;
            const res = window.lastCalculationResult;
            const resultStr = document.getElementById('totalAmount').textContent;
            const countryName = getCountryName(res.request?.country || selectedCountry);

            // Build full multi-line breakdown text
            const b = res.breakdown || {};
            const r = res.request || {};
            const m = res.meta || {};
            const fnum = (n) => (typeof n === 'number' ? new Intl.NumberFormat('ru-RU').format(n) : n);

            const lines = [];
            lines.push('🚗 Расчет растаможки');
            lines.push(`Страна: ${countryName}`);
            if (r.year) lines.push(`Год выпуска: ${r.year}`);
            if (r.engine_cc) lines.push(`Объем двигателя: ${r.engine_cc} см³`);
            if (r.purchase_price && r.currency) lines.push(`Цена покупки: ${fnum(r.purchase_price)} ${r.currency}`);
            if (r.freight_type) lines.push(`Тип фрахта: ${r.freight_type}`);
            if (m.age_years !== undefined && m.age_category) lines.push(`Возраст: ${m.age_years} лет (${getAgeCategory(m.age_category)})`);
            lines.push('');
            lines.push('Детализация:');
            if (b.purchase_price_rub) lines.push(`• Цена покупки: ${fnum(b.purchase_price_rub)} ₽`);
            if (b.duties_rub) lines.push(`• Таможенная пошлина: ${fnum(b.duties_rub)} ₽`);
            if (b.utilization_fee_rub) lines.push(`• Утилизационный сбор: ${fnum(b.utilization_fee_rub)} ₽`);
            if (b.customs_services_rub) lines.push(`• Таможенное оформление: ${fnum(b.customs_services_rub)} ₽`);
            if (b.era_glonass_rub) lines.push(`• Эра-Глонасс: ${fnum(b.era_glonass_rub)} ₽`);
            if (b.freight_rub) lines.push(`• Фрахт: ${fnum(b.freight_rub)} ₽`);
            if (b.country_expenses_rub) lines.push(`• Расходы в стране: ${fnum(b.country_expenses_rub)} ₽`);
            if (b.company_commission_rub) lines.push(`• Комиссия компании: ${fnum(b.company_commission_rub)} ₽`);
            if (b.total_rub) {
                lines.push('');
                lines.push(`ИТОГО: ${fnum(b.total_rub)} ₽`);
            }
            if (Array.isArray(m.warnings) && m.warnings.length) {
                lines.push('');
                lines.push('Предупреждения:');
                m.warnings.forEach(w => lines.push(`• ${w.message}`));
            }
            const detailText = lines.join('\n');

            const shareText = `🚗 Расчет растаможки автомобиля из ${countryName}: ${resultStr}`;

            // Clipboard copy (with fallback)
            const copyFallback = (text) => {
                try {
                    const ta = document.createElement('textarea');
                    ta.value = text;
                    ta.style.position = 'fixed';
                    ta.style.left = '-9999px';
                    document.body.appendChild(ta);
                    ta.focus();
                    ta.select();
                    const ok = document.execCommand('copy');
                    document.body.removeChild(ta);
                    return ok;
                } catch (e) {
                    return false;
                }
            };

            const doCopy = async (text) => {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    try {
                        await navigator.clipboard.writeText(text);
                        showToast('Полный расчет скопирован','success');
                        return true;
                    } catch (e) {
                        const ok = copyFallback(text);
                        showToast(ok ? 'Полный расчет скопирован' : 'Не удалось скопировать', ok ? 'success' : 'error');
                        return ok;
                    }
                } else {
                    const ok = copyFallback(text);
                    showToast(ok ? 'Полный расчет скопирован' : 'Не удалось скопировать', ok ? 'success' : 'error');
                    return ok;
                }
            };

            // Always copy full detail; then try sending to chat if inside Telegram
            doCopy(detailText).then(() => {
                if (telegram.canSendData && telegram.canSendData()) {
                    try {
                        const totalVal = b.total_rub;
                        const sent = telegram.sendDataSafe({
                            action: 'share_result',
                            text: shareText,
                            summary: shareText,
                            detail: detailText,
                            total: totalVal,
                            total_rub: totalVal,
                            country: r.country || selectedCountry,
                            year: r.year,
                            engine_cc: r.engine_cc,
                            currency: r.currency,
                            freight_type: r.freight_type
                        });
                        if (sent) {
                            showToast('Результат отправлен в чат','success');
                        } else {
                            showToast('Не удалось отправить в чат','error');
                        }
                        // Close to ensure Telegram delivers web_app_data in chat
                        setTimeout(() => { try { telegram.close(); } catch (_) {} }, 400);
                    } catch (e) {
                        showToast('Не удалось отправить в чат','error');
                        if (window.Telegram?.WebApp?.showAlert) {
                            window.Telegram.WebApp.showAlert('Чтобы отправка работала, откройте калькулятор через кнопку в чате бота');
                        }
                    }
                } else if (navigator.share) {
                    // Optional: native share sheet (in addition to clipboard)
                    navigator.share({ title: 'Калькулятор растаможки', text: shareText, url: location.href }).catch(()=>{});
                } else {
                    // Not in Telegram context
                    console.info('Not in Telegram context: open via bot WebApp button to send result to chat.');
                    try { if (window.Telegram?.WebApp?.showAlert) window.Telegram.WebApp.showAlert('Откройте калькулятор через кнопку в чате бота, чтобы отправить результат'); } catch (_) {}
                }
            });
        }

        function getCountryName(country) {
            return {
                japan:'Японии',
                korea:'Кореи',
                uae:'ОАЭ',
                china:'Китая'
            }[country] || country;
        }

        function formatNumber(n){
            return new Intl.NumberFormat('ru-RU').format(n);
        }

        function getAgeCategory(c){
            return {
                lt3:'до 3 лет',
                '3_5':'3-5 лет (проходные)',
                gt5:'свыше 5 лет'
            }[c] || c;
        }

        function showLoading(show){
            document.getElementById('loading').style.display = show?'block':'none';
            document.getElementById('calculateBtn').disabled=show;
        }

        function showError(msg){
            const e=document.getElementById('error');
            e.textContent=msg;
            e.style.display='block';
        }

        function hideError(){
            document.getElementById('error').style.display='none';
        }

        function hideResult(){
            document.getElementById('resultCard').classList.remove('show');
            document.getElementById('shareBtn').style.display='none';
        }

        function showToast(message,type='info'){
            const t=document.createElement('div');
            t.className=`toast ${type}`;
            t.textContent=message;
            t.style.cssText=`position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:${type==='success'?'#10b981':type==='error'?'#ef4444':'#3b82f6'};color:#fff;padding:12px 24px;border-radius:8px;z-index:1000;animation:slideUp .3s ease-out;`;
            document.body.appendChild(t);
            setTimeout(()=>t.remove(),3000);
        }
    </script>
</body>
</html>

