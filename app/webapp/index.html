<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ä–∞—Å—Ç–∞–º–æ–∂–∫–∏ –∞–≤—Ç–æ</title>
    <!-- PWA –º–∞–Ω–∏—Ñ–µ—Å—Ç (absolute path to work under /web/) -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2481cc">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="–†–∞—Å—Ç–∞–º–æ–∂–∫–∞">
    <!-- Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- CSS Modules -->
    <link rel="stylesheet" href="/static/css/variables.css">
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/components.css">
    <link rel="stylesheet" href="/static/css/telegram.css">
    <noscript>–î–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω—É–∂–µ–Ω JavaScript</noscript>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöó –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ä–∞—Å—Ç–∞–º–æ–∂–∫–∏</h1>
            <p>–†–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ –ø–æ–ª–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—è —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö —Å–±–æ—Ä–æ–≤</p>
        </div>

        <form id="calculatorForm">
            <div class="form-card">
                <div class="form-group">
                    <label>–°—Ç—Ä–∞–Ω–∞ –ø–æ–∫—É–ø–∫–∏ <span class="required">*</span></label>
                    <div class="country-selector">
                        <select id="countrySelect" class="country-dropdown" required>
                            <option value="" id="countryPlaceholder">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É</option>
                            <!-- –°—Ç—Ä–∞–Ω—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∏–∑ /api/meta -->
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="year">–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞ <span class="required">*</span></label>
                    <input type="number" id="year" name="year" min="1990" max="2025" required data-constraint-year>
                </div>

                <div class="form-group">
                    <label for="engineCc">–û–±—ä–µ–º –¥–≤–∏–≥–∞—Ç–µ–ª—è (—Å–º¬≥) <span class="required">*</span></label>
                    <input type="number" id="engineCc" name="engineCc" min="500" max="10000" step="50" required data-constraint-engine>
                </div>

                <div class="form-group">
                    <label>–¶–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏ <span class="required">*</span></label>
                    <div class="input-group">
                        <input type="number" id="purchasePrice" name="purchasePrice" min="1" step="0.01" required>
                        <select id="currency" name="currency" class="currency-select" required>
                            <option value="JPY">JPY</option>
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                            <option value="CNY">CNY</option>
                            <option value="AED">AED</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="vehicleType">–¢–∏–ø —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–≥–æ —Å—Ä–µ–¥—Å—Ç–≤–∞ <span class="required">*</span></label>
                    <select id="vehicleType" name="vehicleType" required>
                        <option value="M1" selected>–õ–µ–≥–∫–æ–≤–æ–π (M1)</option>
                    </select>
                </div>

                <div class="form-group freight-options" id="freightOptions">
                    <label>–¢–∏–ø —Ñ—Ä–∞—Ö—Ç–∞</label>
                    <div class="freight-grid" id="freightGrid">
                        <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è -->
                    </div>
                </div>
            </div>

            <button type="submit" class="calculate-btn" id="calculateBtn">
                –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å
            </button>
        </form>

        <div class="result-card" id="resultCard">
            <div class="result-total">
                <div class="amount" id="totalAmount">0 ‚ÇΩ</div>
                <div class="label">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</div>
            </div>

            <div id="breakdown">
                <!-- –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤ -->
            </div>

            <div class="meta-info" id="metaInfo">
                <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            </div>

            <button class="share-btn" id="shareBtn" style="display: none;">
                üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
            </button>
        </div>

        <div class="loading" id="loading" style="display: none;">
            –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å...
        </div>

        <div class="error" id="error" style="display: none;"></div>
    </div>

    <script type="module">
        // =====================================================================
        // Import utility modules (RPG Sprint 2)
        // =====================================================================
        import * as formatters from '/static/js/utils/formatters.js';
        import * as dom from '/static/js/utils/dom.js';

        // =====================================================================
        // Import configuration modules (RPG Sprint 3)
        // =====================================================================
        import { Messages } from '/static/js/config/messages.js';
        import {
            Constraints,
            API_ENDPOINTS,
            API_CONFIG,
            DEFAULT_VALUES,
            FALLBACK_META,
            HAPTIC_TYPES,
            ANIMATION
        } from '/static/js/config/constants.js';

        // =====================================================================
        // Import validator module (RPG Sprint 4)
        // =====================================================================
        import { validator as formValidator } from '/static/js/modules/validator.js';

        // =====================================================================
        // Import API client module (RPG Sprint 5)
        // =====================================================================
        import { api, APIError } from '/static/js/modules/api.js';

        // =====================================================================
        // Import UI module (RPG Sprint 6)
        // =====================================================================
        import { ui } from '/static/js/modules/ui.js';

        // =====================================================================
        // Enhanced Telegram Integration
        // =====================================================================
        class TelegramWebAppHelper {
            constructor() {
                this.tg = window.Telegram?.WebApp;
                this.isValid = false;
                this.init();
            }

            detectInTelegram() {
                try {
                    if (!this.tg) return false;
                    const hasInitData = typeof this.tg.initData === 'string' && this.tg.initData.length > 0;
                    const hasUser = !!this.tg.initDataUnsafe?.user;
                    return hasInitData || hasUser;
                } catch (e) {
                    return false;
                }
            }

            init() {
                if (!this.tg) {
                    console.warn('Telegram WebApp API not available');
                    return;
                }

                // Keep UI features behind isValid; evaluate after ready
                try {
                    this.tg.ready();
                    this.tg.expand();
                    // After ready, re-evaluate environment
                    this.isValid = this.detectInTelegram();
                    this.applyTheme();
                    if (this.isValid) this.setupEventListeners();
                    console.log('Telegram WebApp initialized (isValid:', this.isValid, ')');
                } catch (error) {
                    console.error('Telegram WebApp initialization failed:', error);
                    this.isValid = false;
                }
            }

            applyTheme() {
                const themeParams = this.tg.themeParams;
                if (!themeParams) return;

                const root = document.documentElement;
                const cssVariables = {
                    '--tg-bg-color': themeParams.bg_color || '#ffffff',
                    '--tg-text-color': themeParams.text_color || '#000000',
                    '--tg-hint-color': themeParams.hint_color || '#707579',
                    '--tg-link-color': themeParams.link_color || '#2481cc',
                    '--tg-button-color': themeParams.button_color || '#2481cc',
                    '--tg-button-text-color': themeParams.button_text_color || '#ffffff',
                    '--tg-secondary-bg-color': themeParams.secondary_bg_color || '#f1f1f1'
                };

                Object.entries(cssVariables).forEach(([property, value]) => {
                    if (value) root.style.setProperty(property, value);
                });
            }

            setupEventListeners() {
                this.tg.MainButton.setText(Messages.buttons.CALCULATE);
                this.tg.MainButton.onClick(() => {
                    const event = new Event('submit', { bubbles: true, cancelable: true });
                    document.getElementById('calculatorForm').dispatchEvent(event);
                });

                this.tg.BackButton.onClick(() => {
                    const resultCard = document.getElementById('resultCard');
                    if (resultCard.classList.contains('show')) {
                        ui.hideResult();
                        this.hideBackButton();
                        this.showMainButton();
                    } else {
                        this.tg.close();
                    }
                });

                this.tg.onEvent('themeChanged', () => {
                    this.applyTheme();
                });
            }

            showMainButton(text = Messages.buttons.CALCULATE) {
                if (!this.isValid) return;
                this.tg.MainButton.setText(text);
                this.tg.MainButton.show();
                this.tg.MainButton.enable();
            }

            hideMainButton() {
                if (!this.isValid) return;
                this.tg.MainButton.hide();
            }

            showBackButton() {
                if (!this.isValid) return;
                this.tg.BackButton.show();
            }

            hideBackButton() {
                if (!this.isValid) return;
                this.tg.BackButton.hide();
            }

            setMainButtonLoading(loading = true) {
                if (!this.isValid) return;

                if (loading) {
                    this.tg.MainButton.showProgress();
                    this.tg.MainButton.disable();
                } else {
                    this.tg.MainButton.hideProgress();
                    this.tg.MainButton.enable();
                }
            }

            // Helper: count UTF-8 bytes of a string
            byteLength(str) {
                try {
                    return new TextEncoder().encode(str).length;
                } catch (_) {
                    // Fallback approximate length
                    return (str || '').length;
                }
            }

            sendData(data) {
                // Allow sendData if Telegram object is present and initData/user available now
                if (!this.tg) return;
                try {
                    this.tg.sendData(JSON.stringify(data));
                } catch (error) {
                    console.error('Failed to send data to Telegram:', error);
                    try { this.showAlert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö'); } catch (_) {}
                }
            }

            // Safe variant that keeps payload under Telegram limit (4096 bytes)
            sendDataSafe(data) {
                if (!this.tg) return false;
                const LIMIT = 4096;
                let payload = typeof data === 'string' ? data : JSON.stringify(data);
                let size = this.byteLength(payload);

                console.log('[DEBUG] Sending data to Telegram, size:', size, 'bytes');
                console.log('[DEBUG] Payload preview:', payload.substring(0, 200) + (payload.length > 200 ? '...' : ''));

                if (size > LIMIT) {
                    console.warn('[Telegram] Payload too large:', size, 'bytes. Trimming...');
                    // Build minimal payload
                    const minimal = {
                        action: (data && data.action) || 'share_result',
                        summary: (data && data.summary) || (data && data.text) || '–†–∞—Å—á–µ—Ç –≥–æ—Ç–æ–≤',
                        total: data?.total ?? data?.total_rub,
                        country: data?.country,
                        year: data?.year,
                        engine_cc: data?.engine_cc
                    };
                    // Ensure summary fits
                    let summary = minimal.summary || '';
                    // Leave ~300 bytes for the rest of fields/overhead
                    const reserveBytes = 300;
                    const maxSummaryBytes = Math.max(0, LIMIT - reserveBytes - this.byteLength(JSON.stringify({ ...minimal, summary: '' })));
                    const truncateToBytes = (s, maxBytes) => {
                        if (this.byteLength(s) <= maxBytes) return s;
                        // naive truncation by characters until fits
                        let low = 0, high = s.length;
                        while (low < high) {
                            const mid = Math.floor((low + high) / 2);
                            const candidate = s.slice(0, mid) + '‚Ä¶';
                            if (this.byteLength(candidate) <= maxBytes) low = mid + 1; else high = mid;
                        }
                        const finalStr = s.slice(0, Math.max(0, low - 1)) + '‚Ä¶';
                        return finalStr;
                    };
                    minimal.summary = truncateToBytes(summary, maxSummaryBytes);
                    payload = JSON.stringify(minimal);
                    size = this.byteLength(payload);
                    console.warn('[Telegram] Trimmed payload size:', size, 'bytes');
                    try { this.showAlert(Messages.warnings.LARGE_MESSAGE); } catch (_) {}
                }
                try {
                    console.log('[DEBUG] Calling tg.sendData...');
                    this.tg.sendData(payload);
                    console.log('[DEBUG] tg.sendData completed successfully');
                    return true;
                } catch (error) {
                    console.error('Failed to send data to Telegram:', error);
                    try { this.showAlert(Messages.errors.SEND_DATA_FAILED); } catch (_) {}
                    return false;
                }
            }

            showAlert(message) {
                if (!this.tg) return;
                this.tg.showAlert(message);
            }

            hapticFeedback(type = 'light') {
                // HapticFeedback is supported from Telegram WebApp API 6.1+
                if (!this.isValid || !this.tg?.HapticFeedback || !this.isHapticSupported()) return;

                try {
                    if (type === 'light') {
                        this.tg.HapticFeedback.impactOccurred('light');
                    } else if (type === 'medium') {
                        this.tg.HapticFeedback.impactOccurred('medium');
                    } else if (type === 'heavy') {
                        this.tg.HapticFeedback.impactOccurred('heavy');
                    }
                } catch (error) {
                    console.warn('Haptic feedback failed:', error);
                }
            }

            isHapticSupported() {
                if (!this.tg) return false;
                // HapticFeedback requires Telegram WebApp API 6.1+
                const version = this.tg.version || '6.0';
                const [major, minor] = version.split('.').map(Number);
                return major > 6 || (major === 6 && minor >= 1);
            }

            close() {
                if (!this.tg) return;
                this.tg.close();
            }

            isInTelegram() {
                return this.isValid;
            }
        }

        // Tabs helpers
        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));

            const btn = document.getElementById(tabId === 'resultTab' ? 'resultTabBtn' : 'calcTabBtn');
            const pane = document.getElementById(tabId);

            if (btn) btn.classList.add('active');
            if (pane) pane.classList.add('active');
        }
        function showResultsTab() { switchTab('resultTab'); }
        function showCalcTab() { switchTab('calcTab'); }
        function isResultTabActive() {
            const pane = document.getElementById('resultTab');
            return pane ? pane.classList.contains('active') : false;
        }

        function buildTabsUI() {
            const container = document.querySelector('.container');
            const header = container.querySelector('.header');

            const form = document.getElementById('calculatorForm');
            const resultCard = document.getElementById('resultCard');
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');

            // Avoid rebuilding if already built
            if (document.querySelector('.tabs')) return;

            const tabs = document.createElement('div');
            tabs.className = 'tabs';

            const tabNav = document.createElement('div');
            tabNav.className = 'tab-nav';

            const calcTabBtn = document.createElement('button');
            calcTabBtn.className = 'tab-btn active';
            calcTabBtn.id = 'calcTabBtn';
            calcTabBtn.dataset.tab = 'calcTab';
            calcTabBtn.textContent = Messages.buttons.TAB_CALC;

            const resultTabBtn = document.createElement('button');
            resultTabBtn.className = 'tab-btn';
            resultTabBtn.id = 'resultTabBtn';
            resultTabBtn.dataset.tab = 'resultTab';
            resultTabBtn.textContent = Messages.buttons.TAB_RESULT;

            tabNav.append(calcTabBtn, resultTabBtn);

            const panes = document.createElement('div');
            panes.className = 'tab-panes';

            const calcPane = document.createElement('div');
            calcPane.className = 'tab-pane active';
            calcPane.id = 'calcTab';

            const resultPane = document.createElement('div');
            resultPane.className = 'tab-pane';
            resultPane.id = 'resultTab';

            // Move existing nodes into panes
            calcPane.appendChild(form);
            calcPane.appendChild(loading);
            calcPane.appendChild(error);

            resultPane.appendChild(resultCard);

            panes.append(calcPane, resultPane);
            tabs.append(tabNav, panes);

            // Insert tabs after header
            header.insertAdjacentElement('afterend', tabs);

            // Ensure a "back" button exists on the Results tab
            let backBtn = document.getElementById('backToCalcBtn');
            if (!backBtn) {
                backBtn = document.createElement('button');
                backBtn.id = 'backToCalcBtn';
                backBtn.className = 'back-btn';
                backBtn.textContent = Messages.buttons.BACK;
                resultCard.appendChild(backBtn);
            }

            // Wire up events
            calcTabBtn.addEventListener('click', () => {
                ui.hideResult();
                showCalcTab();
                if (telegram.isInTelegram()) {
                    telegram.hideBackButton();
                    telegram.showMainButton();
                }
            });
            resultTabBtn.addEventListener('click', () => {
                showResultsTab();
                if (telegram.isInTelegram()) {
                    const resultCardVisible = document.getElementById('resultCard').classList.contains('show');
                    if (resultCardVisible) {
                        telegram.hideMainButton();
                        telegram.showBackButton();
                    }
                }
            });
            backBtn.addEventListener('click', () => {
                ui.hideResult();
                showCalcTab();
                if (telegram.isInTelegram()) {
                    telegram.hideBackButton();
                    telegram.showMainButton();
                }
            });
        }

        // Initialize Telegram integration (api is imported as singleton from api.js)
        const telegram = new TelegramWebAppHelper();

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let selectedCountry = null;
        let selectedFreightType = null;
        let metaData = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            buildTabsUI();
            applyFormConstraints(); // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏–∑ config
            loadMetaData();
            setupEventListeners();
            setDefaultValues(); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

            // Patch result show/hide to switch tabs
            const originalDisplayResult = window.displayResult;
            const originalHideResult = window.hideResult;
            if (typeof originalDisplayResult === 'function') {
                window.displayResult = function(result) {
                    originalDisplayResult(result);
                    showResultsTab();
                };
            }
            if (typeof originalHideResult === 'function') {
                window.hideResult = function() {
                    originalHideResult();
                    showCalcTab();
                };
            }

            if (telegram.isInTelegram()) {
                // Use only Telegram MainButton, hide in-page calculate button
                const calcBtn = document.getElementById('calculateBtn');
                if (calcBtn) calcBtn.style.display = 'none';
                telegram.showMainButton();
            }
        });

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker –¥–ª—è PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('SW registered: ', registration);
                    })
                    .catch(function(registrationError) {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –æ —Å—Ç—Ä–∞–Ω–∞—Ö –∏ —Ç–∏–ø–∞—Ö —Ñ—Ä–∞—Ö—Ç–∞
        async function loadMetaData() {
            try {
                const response = await api.getMeta();
                metaData = response;
                console.log('Meta data loaded:', metaData);
                populateCountries(); // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–∞–Ω –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
            } catch (error) {
                if (error instanceof APIError) {
                    console.error('Failed to load meta data:', error.toLogFormat());
                } else {
                    console.error('Failed to load meta data:', error);
                }
                // Fallback data for offline usage (from constants.js)
                metaData = FALLBACK_META;
                populateCountries(); // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–∞–Ω –∏–∑ fallback –¥–∞–Ω–Ω—ã—Ö
            }
        }

        // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å—Ç—Ä–∞–Ω –∏–∑ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
        function populateCountries() {
            if (!metaData || !metaData.countries) return;

            const select = document.getElementById('countrySelect');
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–µ—Ä–≤—É—é –æ–ø—Ü–∏—é "–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É"
            const placeholder = select.querySelector('option[value=""]');
            select.innerHTML = '';
            if (placeholder) {
                select.appendChild(placeholder);
            } else {
                const opt = document.createElement('option');
                opt.value = '';
                opt.textContent = Messages.placeholders.SELECT_COUNTRY;
                select.appendChild(opt);
            }

            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω—ã –∏–∑ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
            metaData.countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country.code;
                option.className = 'country-option';
                option.textContent = `${country.emoji} ${country.label}`;
                select.appendChild(option);
            });

            console.log('Countries populated:', metaData.countries.length);
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –≥–æ–¥–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        function setCurrentYear() {
            const yearInput = document.getElementById('year');
            yearInput.value = new Date().getFullYear();
        }

        // Apply constraint values to form inputs from Constants
        function applyFormConstraints() {
            const yearInput = document.getElementById('year');
            if (yearInput) {
                yearInput.min = Constraints.YEAR_MIN;
                yearInput.max = Constraints.YEAR_MAX();
            }

            const engineInput = document.getElementById('engineCc');
            if (engineInput) {
                engineInput.min = Constraints.ENGINE_CC_MIN;
                engineInput.max = Constraints.ENGINE_CC_MAX;
                engineInput.step = Constraints.ENGINE_CC_STEP;
            }

            const priceInput = document.getElementById('purchasePrice');
            if (priceInput) {
                priceInput.min = Constraints.PRICE_MIN;
                priceInput.step = Constraints.PRICE_STEP;
            }
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        function setDefaultValues() {
            const currentYear = new Date().getFullYear();

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–æ–¥ –≤—ã–ø—É—Å–∫–∞ (—Ç–µ–∫—É—â–∏–π –≥–æ–¥ - DEFAULT_VALUES.YEAR_OFFSET)
            const yearInput = document.getElementById('year');
            yearInput.value = currentYear - DEFAULT_VALUES.YEAR_OFFSET;

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—ä–µ–º –¥–≤–∏–≥–∞—Ç–µ–ª—è (DEFAULT_VALUES.ENGINE_CC)
            const engineInput = document.getElementById('engineCc');
            engineInput.value = DEFAULT_VALUES.ENGINE_CC;

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç—Ä–∞–Ω—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (DEFAULT_VALUES.COUNTRY)
            const countrySelect = document.getElementById('countrySelect');
            countrySelect.value = DEFAULT_VALUES.COUNTRY;
            selectCountry(DEFAULT_VALUES.COUNTRY);

            // –¢–∏–ø –¢–° –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (DEFAULT_VALUES.VEHICLE_TYPE)
            const vehicleTypeSelect = document.getElementById('vehicleType');
            vehicleTypeSelect.value = DEFAULT_VALUES.VEHICLE_TYPE;
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function setupEventListeners() {
            // –í—ã–±–æ—Ä —Å—Ç—Ä–∞–Ω—ã —á–µ—Ä–µ–∑ dropdown
            document.getElementById('countrySelect').addEventListener('change', function() {
                const country = this.value;
                if (country) {
                    selectCountry(country);
                    telegram.hapticFeedback(HAPTIC_TYPES.LIGHT);
                }
            });

            // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
            document.getElementById('calculatorForm').addEventListener('submit', function(e) {
                e.preventDefault();
                calculateCost();
            });

            // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω—ã - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∞–ª—é—Ç—ã
            document.addEventListener('countryChanged', updateCurrencyAndFreight);

            // –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
            document.getElementById('shareBtn').addEventListener('click', function() {
                shareResult();
            });

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –≤–≤–æ–¥–µ –¥–∞–Ω–Ω—ã—Ö
            document.getElementById('calculatorForm').addEventListener('input', updateMainButtonState);

            // Real-time validation (RPG Sprint 4)
            setupRealTimeValidation();
        }

        /**
         * Setup real-time validation for form fields (RPG Sprint 4)
         * Validates fields on blur and shows inline errors
         */
        function setupRealTimeValidation() {
            const fieldsToValidate = [
                { id: 'year', name: 'year' },
                { id: 'engineCc', name: 'engine_cc' },
                { id: 'purchasePrice', name: 'purchase_price' }
            ];

            fieldsToValidate.forEach(({ id, name }) => {
                const field = document.getElementById(id);
                if (!field) return;

                // Validate on blur (when user leaves field)
                field.addEventListener('blur', function() {
                    validateFieldRealTime(field, name);
                });

                // Clear error on input (when user starts typing)
                field.addEventListener('input', function() {
                    clearFieldError(field);
                });
            });

            // Validate country selection
            const countrySelect = document.getElementById('countrySelect');
            if (countrySelect) {
                countrySelect.addEventListener('change', function() {
                    if (this.value) {
                        clearFieldError(this);
                    }
                });
            }
        }

        /**
         * Validate single field in real-time
         * @param {HTMLElement} field - Input element
         * @param {string} fieldName - Field name for validator
         */
        function validateFieldRealTime(field, fieldName) {
            const value = field.value;
            const error = formValidator.validateField(fieldName, value);

            if (error) {
                showFieldError(field, error);
            } else {
                clearFieldError(field);
            }
        }

        /**
         * Show inline error for field
         * @param {HTMLElement} field - Input element
         * @param {string} message - Error message
         */
        function showFieldError(field, message) {
            // Add error class to field
            field.classList.add('error');

            // Find or create error message element
            let errorEl = field.nextElementSibling;
            if (!errorEl || !errorEl.classList.contains('field-error')) {
                errorEl = document.createElement('div');
                errorEl.className = 'field-error';
                field.parentNode.insertBefore(errorEl, field.nextSibling);
            }

            errorEl.textContent = message;
            errorEl.style.display = 'block';

            // Haptic feedback for error
            telegram.hapticFeedback(HAPTIC_TYPES.LIGHT);
        }

        /**
         * Clear inline error for field
         * @param {HTMLElement} field - Input element
         */
        function clearFieldError(field) {
            field.classList.remove('error');

            const errorEl = field.nextElementSibling;
            if (errorEl && errorEl.classList.contains('field-error')) {
                errorEl.style.display = 'none';
            }
        }

        // –í—ã–±–æ—Ä —Å—Ç—Ä–∞–Ω—ã
        function selectCountry(country) {
            selectedCountry = country;

            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ dropdown
            const countrySelect = document.getElementById('countrySelect');
            countrySelect.classList.add('active');

            // –¢—Ä–∏–≥–≥–µ—Ä–∏–º —Å–æ–±—ã—Ç–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω—ã
            document.dispatchEvent(new CustomEvent('countryChanged', { detail: country }));

            // Update main button state
            updateMainButtonState();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∞–ª—é—Ç—ã –∏ –æ–ø—Ü–∏–π —Ñ—Ä–∞—Ö—Ç–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Å—Ç—Ä–∞–Ω—ã
        function updateCurrencyAndFreight() {
            if (!metaData || !selectedCountry) return;

            const countryData = metaData.countries.find(c => c.code === selectedCountry);
            if (!countryData) return;

            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∞–ª—é—Ç—É
            const currencySelect = document.getElementById('currency');
            if (countryData.purchase_currency) {
                currencySelect.value = countryData.purchase_currency;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–ø—Ü–∏–∏ —Ñ—Ä–∞—Ö—Ç–∞
            updateFreightOptions(countryData.freight_types);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–ø—Ü–∏–π —Ñ—Ä–∞—Ö—Ç–∞
        function updateFreightOptions(freightTypes) {
            const freightOptions = document.getElementById('freightOptions');
            const freightGrid = document.getElementById('freightGrid');

            if (!freightTypes || freightTypes.length === 0) {
                freightOptions.classList.remove('show');
                return;
            }

            freightOptions.classList.add('show');
            freightGrid.innerHTML = '';

            const freightLabels = metaData.freight_type_labels || {};

            freightTypes.forEach(type => {
                const btn = document.createElement('div');
                btn.className = 'freight-btn';
                btn.dataset.freight = type;
                btn.textContent = freightLabels[type] || type;

                btn.addEventListener('click', function() {
                    selectFreightType(type);
                    telegram.hapticFeedback(HAPTIC_TYPES.LIGHT);
                });

                freightGrid.appendChild(btn);
            });

            // –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π —Ç–∏–ø –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            if (freightTypes.length > 0) {
                selectFreightType(freightTypes[0]);
            }
        }

        // –í—ã–±–æ—Ä —Ç–∏–ø–∞ —Ñ—Ä–∞—Ö—Ç–∞
        function selectFreightType(type) {
            selectedFreightType = type;
            document.querySelectorAll('.freight-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`[data-freight="${type}"]`);
            if (activeBtn) activeBtn.classList.add('active');
        }

        // Update main button state based on form validity
        function updateMainButtonState() {
            if (!telegram.isInTelegram()) return;
            if (!selectedCountry) {
                telegram.hideMainButton();
                return;
            }
            const formData = new FormData(document.getElementById('calculatorForm'));
            const isValid = formData.get('year') && formData.get('engineCc') && formData.get('purchasePrice');
            if (isValid) {
                telegram.showMainButton(Messages.buttons.CALCULATE);
            } else {
                telegram.hideMainButton();
            }
        }

        /**
         * Validate form using FormValidator (RPG Sprint 4)
         * @returns {boolean} - true if form is valid
         */
        function validateForm() {
            const formData = new FormData(document.getElementById('calculatorForm'));

            // Add country to form data (selected separately)
            formData.set('country', selectedCountry || '');

            const validationResult = formValidator.validate(formData);

            if (!validationResult.isValid) {
                // Show first error
                const firstError = validationResult.errors[0];
                ui.showError(firstError.message);

                // Highlight invalid field
                const fieldId = getFieldIdFromName(firstError.field);
                if (fieldId) {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.focus();
                        field.classList.add('error');
                        setTimeout(() => field.classList.remove('error'), 2000);
                    }
                }

                return false;
            }

            return true;
        }

        /**
         * Map field name to HTML element ID
         * @param {string} fieldName - Field name from validator
         * @returns {string|null} - Element ID
         */
        function getFieldIdFromName(fieldName) {
            const mapping = {
                'year': 'year',
                'engine_cc': 'engineCc',
                'purchase_price': 'purchasePrice',
                'country': 'countrySelect'
            };
            return mapping[fieldName] || null;
        }

        async function calculateCost() {
            if (!selectedCountry) {
                ui.showError(Messages.errors.NO_COUNTRY);
                return;
            }
            if (!validateForm()) return;

            const formData = new FormData(document.getElementById('calculatorForm'));
            const requestData = {
                country: selectedCountry,
                year: parseInt(formData.get('year')),
                engine_cc: parseInt(formData.get('engineCc')),
                purchase_price: parseFloat(formData.get('purchasePrice')),
                currency: formData.get('currency'),
                freight_type: selectedFreightType,
                vehicle_type: formData.get('vehicleType') || DEFAULT_VALUES.VEHICLE_TYPE
            };

            ui.showLoading();

            try {
                telegram.setMainButtonLoading(true);
                const result = await api.calculate(requestData);
                displayResult(result);
                if (telegram.isInTelegram()) {
                    telegram.hapticFeedback(HAPTIC_TYPES.MEDIUM);
                    telegram.hideMainButton();
                    telegram.showBackButton();
                }
            } catch (error) {
                console.error('Calculation error:', error);

                // Use APIError's user-friendly message if available
                let errorMessage = Messages.errors.CALCULATION_ERROR;
                if (error instanceof APIError) {
                    errorMessage = error.getUserMessage();
                    console.error('API Error details:', error.toLogFormat());
                } else {
                    errorMessage += ': ' + error.message;
                }

                ui.showError(errorMessage);
                telegram.hapticFeedback(HAPTIC_TYPES.HEAVY);
            } finally {
                ui.hideLoading();
                telegram.setMainButtonLoading(false);
            }
        }

        function displayResult(result) {
            const { breakdown, meta } = result;
            document.getElementById('totalAmount').textContent = formatNumber(breakdown.total_rub) + ' ‚ÇΩ';

            const breakdownDiv = document.getElementById('breakdown');
            breakdownDiv.innerHTML = '';

            const items = [
                { label: Messages.breakdown.PURCHASE_PRICE, amount: breakdown.purchase_price_rub },
                { label: Messages.breakdown.COUNTRY_EXPENSES, amount: breakdown.country_expenses_rub },
                { label: Messages.breakdown.FREIGHT, amount: breakdown.freight_rub },
                { label: Messages.breakdown.DUTIES, amount: breakdown.duties_rub },
                { label: Messages.breakdown.CUSTOMS_SERVICES, amount: breakdown.customs_services_rub },
                { label: Messages.breakdown.UTILIZATION_FEE, amount: breakdown.utilization_fee_rub },
                { label: Messages.breakdown.ERA_GLONASS, amount: breakdown.era_glonass_rub },
                { label: Messages.breakdown.COMPANY_COMMISSION, amount: breakdown.company_commission_rub }
            ];

            items.forEach(item => {
                if (item.amount > 0) {
                    const div = document.createElement('div');
                    div.className='breakdown-item';
                    div.innerHTML=`<span class="breakdown-label">${item.label}</span><span class="breakdown-amount">${formatNumber(item.amount)} ‚ÇΩ</span>`;
                    breakdownDiv.appendChild(div);
                }
            });

            const totalDiv = document.createElement('div');
            totalDiv.className='breakdown-item';
            totalDiv.innerHTML=`<span class="breakdown-label">${Messages.labels.TOTAL}</span><span class="breakdown-amount">${formatNumber(breakdown.total_rub)} ‚ÇΩ</span>`;
            breakdownDiv.appendChild(totalDiv);

            // Engine/duty details
            const engineDisplay = (meta && meta.volume_band && meta.volume_band !== 'value_brackets' && meta.volume_band !== 'n/a')
                ? meta.volume_band
                : (result?.request?.engine_cc ? `${result.request.engine_cc} —Å–º¬≥` : '‚Äî');

            const parts = [];

            // Country label on results page (from request or current selection)
            const countryCode = result?.request?.country || selectedCountry;
            if (countryCode) {
                const countryLabel = getCountryLabel(countryCode);
                parts.push(`<div>${Messages.labels.COUNTRY}: ${countryLabel}</div>`);
            }

            parts.push(`<div>${Messages.labels.AGE}: ${meta.age_years} –ª–µ—Ç (${getAgeCategory(meta.age_category)})</div>`);
            parts.push(`<div>${Messages.labels.ENGINE}: ${engineDisplay}</div>`);

            // Duty details
            if (meta.customs_value_eur != null) {
                parts.push(`<div>${Messages.labels.CUSTOMS_VALUE}: ${formatNumber(Math.round(meta.customs_value_eur))} ‚Ç¨</div>`);
            }
            if (meta.duty_formula_mode === 'percent') {
                if (meta.duty_percent != null) {
                    parts.push(`<div>${Messages.labels.DUTY}: ${Math.round(meta.duty_percent * 100)}% –æ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (–º–∏–Ω–∏–º—É–º –ø–æ ‚Ç¨/—Å–º¬≥)</div>`);
                }
                if (meta.duty_min_rate_eur_per_cc != null) {
                    parts.push(`<div>${Messages.labels.MIN_RATE}: ${meta.duty_min_rate_eur_per_cc} ‚Ç¨/—Å–º¬≥</div>`);
                }
                if (meta.duty_value_bracket_max_eur != null) {
                    parts.push(`<div>${Messages.duty.VALUE_BRACKET}: ${formatNumber(meta.duty_value_bracket_max_eur)} ‚Ç¨</div>`);
                }
            } else if (meta.duty_formula_mode === 'per_cc' && meta.duty_rate_eur_per_cc != null) {
                parts.push(`<div>${Messages.labels.DUTY_RATE}: ${meta.duty_rate_eur_per_cc} ‚Ç¨/—Å–º¬≥</div>`);
            }

            if (meta.vehicle_type && meta.vehicle_type !== DEFAULT_VALUES.VEHICLE_TYPE) {
                parts.push(`<div style="color:#e67e22;margin-top:8px;">${Messages.warnings.NON_M1_DISCLAIMER}</div>`);
            }

            if (meta.warnings && meta.warnings.length) {
                parts.push('<div style="color:#e74c3c;margin-top:8px;">' + Messages.warnings.WARNING_PREFIX + meta.warnings.map(w=>w.message).join('<br>' + Messages.warnings.WARNING_PREFIX) + '</div>');
            }

            const metaDiv = document.getElementById('metaInfo');
            metaDiv.innerHTML = parts.join('');

            ui.showResult();
            window.lastCalculationResult = result;
        }

        // Resolve country code to label (prefers API meta, falls back to Messages.countries)
        function getCountryLabel(code) {
            try {
                if (metaData && Array.isArray(metaData.countries)) {
                    const entry = metaData.countries.find(c => c.code === code);
                    if (entry) return (entry.emoji ? entry.emoji + ' ' : '') + (entry.label || code);
                }
            } catch (e) { /* ignore */ }
            return Messages.countries[code] || code;
        }
        function shareResult() {
            if (!window.lastCalculationResult) return;
            const res = window.lastCalculationResult;
            const resultStr = document.getElementById('totalAmount').textContent;

            // Build full multi-line breakdown text
            const b = res.breakdown || {};
            const r = res.request || {};
            const m = res.meta || {};
            const fnum = (n) => (typeof n === 'number' ? new Intl.NumberFormat('ru-RU').format(n) : n);

            // Resolve country for sharing
            const countryCode = r.country || selectedCountry;
            const countryLabel = countryCode ? getCountryLabel(countryCode) : '';

            const lines = [];
            lines.push(Messages.share.TITLE);
            if (countryLabel) lines.push(`${Messages.labels.COUNTRY}: ${countryLabel}`);
            if (r.year) lines.push(`${Messages.labels.YEAR}: ${r.year}`);
            if (r.engine_cc) lines.push(`${Messages.labels.ENGINE}: ${r.engine_cc} —Å–º¬≥`);
            if (r.purchase_price && r.currency) lines.push(`${Messages.labels.PRICE}: ${fnum(r.purchase_price)} ${r.currency}`);
            if (r.freight_type) lines.push(`${Messages.labels.FREIGHT_TYPE}: ${r.freight_type}`);
            if (m.age_years !== undefined && m.age_category) lines.push(`${Messages.labels.AGE}: ${m.age_years} –ª–µ—Ç (${getAgeCategory(m.age_category)})`);
            lines.push('');
            lines.push(Messages.share.BREAKDOWN_TITLE);
            if (b.purchase_price_rub) lines.push(`‚Ä¢ ${Messages.breakdown.PURCHASE_PRICE}: ${fnum(b.purchase_price_rub)} ‚ÇΩ`);
            if (b.duties_rub) lines.push(`‚Ä¢ ${Messages.breakdown.DUTIES}: ${fnum(b.duties_rub)} ‚ÇΩ`);
            if (b.utilization_fee_rub) lines.push(`‚Ä¢ ${Messages.breakdown.UTILIZATION_FEE}: ${fnum(b.utilization_fee_rub)} ‚ÇΩ`);
            if (b.customs_services_rub) lines.push(`‚Ä¢ ${Messages.breakdown.CUSTOMS_SERVICES}: ${fnum(b.customs_services_rub)} ‚ÇΩ`);
            if (b.era_glonass_rub) lines.push(`‚Ä¢ ${Messages.breakdown.ERA_GLONASS}: ${fnum(b.era_glonass_rub)} ‚ÇΩ`);
            if (b.freight_rub) lines.push(`‚Ä¢ ${Messages.breakdown.FREIGHT}: ${fnum(b.freight_rub)} ‚ÇΩ`);
            if (b.country_expenses_rub) lines.push(`‚Ä¢ ${Messages.breakdown.COUNTRY_EXPENSES}: ${fnum(b.country_expenses_rub)} ‚ÇΩ`);
            if (b.company_commission_rub) lines.push(`‚Ä¢ ${Messages.breakdown.COMPANY_COMMISSION}: ${fnum(b.company_commission_rub)} ‚ÇΩ`);
            if (b.total_rub) {
                lines.push('');
                lines.push(`${Messages.labels.TOTAL}: ${fnum(b.total_rub)} ‚ÇΩ`);
            }
            if (Array.isArray(m.warnings) && m.warnings.length) {
                lines.push('');
                lines.push(Messages.share.WARNINGS_TITLE);
                m.warnings.forEach(w => lines.push(`‚Ä¢ ${w.message}`));
            }
            const detailText = lines.join('\n');

            // Short share text now contains country
            const shareText = countryLabel
                ? Messages.share.TITLE_FROM_COUNTRY.replace('{country}', countryLabel).replace('{total}', resultStr)
                : Messages.share.TITLE_GENERIC.replace('{total}', resultStr);

            // Check if we're in Telegram
            const inTelegram = telegram.isInTelegram();

            // Always copy to clipboard first
            const copyFallback = (text) => {
                try {
                    const ta = document.createElement('textarea');
                    ta.value = text;
                    ta.style.position = 'fixed';
                    ta.style.left = '-9999px';
                    document.body.appendChild(ta);
                    ta.focus();
                    ta.select();
                    const ok = document.execCommand('copy');
                    document.body.removeChild(ta);
                    return ok;
                } catch (e) {
                    return false;
                }
            };

            const doCopy = async (text) => {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    try {
                        await navigator.clipboard.writeText(text);
                        return true;
                    } catch (e) {
                        return copyFallback(text);
                    }
                } else {
                    return copyFallback(text);
                }
            };

            // Copy to clipboard
            doCopy(detailText).then((copied) => {
                if (copied) {
                    showToast(Messages.info.COPIED, 'success');
                } else {
                    showToast(Messages.errors.COPY_FAILED, 'error');
                }
            });

            // If in Telegram, also try to send to chat
            if (true) {
                try {
                    const totalVal = b.total_rub;

                    // Prepare data for Telegram (includes country label)
                    const telegramData = {
                        action: 'share_result',
                        text: shareText,
                        summary: shareText,
                        detail: detailText,
                        total: totalVal,
                        total_rub: totalVal,
                        country: r.country || selectedCountry,
                        country_label: countryLabel,
                        year: r.year,
                        engine_cc: r.engine_cc,
                        currency: r.currency,
                        purchase_price: r.purchase_price,
                        freight_type: r.freight_type,
                        formatted_total: fnum(totalVal)
                    };

                    const sent = telegram.sendDataSafe(telegramData);

                    if (sent) {
                        ui.showToast(Messages.info.SENT_TO_CHAT, 'success');
                        telegram.hapticFeedback(HAPTIC_TYPES.MEDIUM);

                        setTimeout(() => {
                            try { telegram.close(); } catch (e) { console.warn('Failed to close WebApp:', e); }
                        }, ANIMATION.TELEGRAM_CLOSE_DELAY);
                    } else {
                        ui.showToast(Messages.errors.SEND_FAILED, 'error');
                        telegram.hapticFeedback(HAPTIC_TYPES.HEAVY);
                    }
                } catch (e) {
                    console.error('Exception while sending to Telegram:', e);
                    ui.showToast(Messages.errors.TELEGRAM_SEND_ERROR, 'error');
                    telegram.hapticFeedback(HAPTIC_TYPES.HEAVY);

                    if (window.Telegram?.WebApp?.showAlert) {
                        window.Telegram.WebApp.showAlert(Messages.warnings.OPEN_VIA_BOT);
                    }
                }
            }
        }

        // ===== Helper functions (now using imported modules) =====
        // formatNumber and getAgeCategory now come from formatters module
        const formatNumber = formatters.formatNumber;
        const getAgeCategory = formatters.getAgeCategory;

        // Expose UI and displayResult for compatibility with code that may reference window.*
        window.ui = ui;
        window.displayResult = displayResult;
    </script>
</body>
</html>
