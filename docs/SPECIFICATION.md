Обновлённое **техническое задание (ТЗ)** на калькулятор стоимости ввоза легковых автомобилей в РФ, с учётом новых требований по утилизационному сбору и актуальных данных из официальных источников (включая необходимость запроса **мощности в л.с.** и использования **кВт** в расчётах, а также актуальные ставки по утильсбору и пошлине на 2025 год).

---

# **Техническое задание: Калькулятор ввоза легковых автомобилей в РФ (2025)**

## **1. Общие положения**

Калькулятор предназначен для расчёта **полной стоимости ввоза и оформления** легкового автомобиля категории **M1 (некоммерческое использование)** на территорию Российской Федерации из следующих стран:
- Япония  
- Республика Корея  
- ОАЭ  
- Китай  
- Грузия  

> **Не применяется** к коммерческим, грузовым, пассажирским, спецТС, электромобилям с иной категорией, пикапам и авто категории N. Для таких ТС — только ручной расчёт через поддержку.

---

## **2. Входные данные от пользователя**

Калькулятор должен запрашивать у пользователя:

| Поле | Тип | Комментарий |
|------|-----|-------------|
| Страна происхождения | Список | Япония, Корея, ОАЭ, Китай, Грузия |
| Год выпуска | Число | Определяет возраст авто и категорию пошлины |
| Стоимость автомобиля | Число + валюта | Для Японии — в JPY, для остальных — в USD или RUB (с конвертацией) |
| Объём двигателя | Число (см³) | Обязателен для расчёта пошлины и текущего утильсбора |
| Мощность двигателя | Число (л.с.) | Обязательно запрашивается — для будущих расчётов и внутреннего перевода в кВт |
| Тип транспортировки | Выбор (только для ОАЭ) | Открытый / Контейнер |
| Санкционный статус | Чекбокс (только для Японии) | Если не уверен — подсказка: «Обратитесь в поддержку» |

> **Примечание:**  
> Внутренне: `Мощность (кВт) = Мощность (л.с.) × 0.7355` — сохраняется для возможного перехода на новую систему утильсбора (по мощности).

---

## **3. Классификация автомобилей**

**✅ Статус: Реализовано в v2.0 (2025-12-08)**

- **«Проходные» авто**: **2020–2022 гг.** — стандартные ставки пошлины.  
- **«Непроходные» авто**: **2023–2025 гг.** — повышенные таможенные платежи.

> **Алгоритм**:  
> Калькулятор **автоматически определяет возраст** по году выпуска и текущей дате (7 декабря 2025 г.).

---

## **4. Структура расчёта**

Для каждой страны рассчитывается:

### **4.1. Затраты в стране покупки**

| Страна | Условия | Сумма |
|--------|--------|--------|
| **Япония** | ≤ 3 000 000 JPY | 150 000 JPY |
| | 3 000 001 – 6 000 000 JPY | 300 000 JPY |
| | > 6 000 000 JPY | 400 000 JPY |
| **Корея** | Любой | 500 USD |
| **ОАЭ** | Любой | 1 000 USD |
| **Китай** | Любой | 1 000 USD |
| **Грузия** | Любой | 750 USD |

> Включает: осмотр, проверку, брокерские услуги, доставку до порта.

---

### **4.2. Фрахт и портовые сборы**

| Страна | Условия | Сумма (USD) | Порт назначения |
|--------|--------|--------------|------------------|
| **Япония** | Несанкционный | 350 | Владивосток / Находка |
| | Санкционный | 2 000 | Владивосток / Находка |
| **Корея** | Любой | 1 000 | Владивосток / Находка |
| **Китай** | Любой | 1 000 | Дальний Восток |
| **Грузия** | Любой | 750 | РФ (по умолчанию — Новороссийск) |
| **ОАЭ** | Открытый | 2 500 | Астрахань, Новороссийск, СПб |
| | Контейнер | 3 800 | Астрахань, Новороссийск, СПб, Владивосток |

---

### **4.3. Затраты на территории РФ**

#### **4.3.1. Услуги по таможенному оформлению**

| Страна | Сумма (RUB) |
|--------|-------------|
| Япония, Корея, Китай | 70 000 |
| Грузия | 120 000 |
| ОАЭ | 150 000 |

> Включает: СВХ, СБКТС, ЭПТС (для ОАЭ, Китая, Грузии).

#### **4.3.2. Утилизационный сбор (УС)**

**✅ Статус: Реализовано в v2.0 (2025-12-08)**

Новая система утилизационного сбора с двумерной таблицей (объём + мощность).

**Входные данные:**
- Объём двигателя (см³)
- **Мощность двигателя (л.с.)** ← НОВОЕ ОБЯЗАТЕЛЬНОЕ ПОЛЕ
- Возраст автомобиля

**Расчёт:**
1. Конвертация л.с. → кВт: `kw = hp × 0.7355`
2. Поиск диапазона объёма (5 bands)
3. Поиск диапазона мощности в выбранном band
4. Выбор коэффициента (lt3 или gt3)
5. Расчёт: `fee = 20,000 ₽ × coefficient`

**Конфигурация:** `config/rates.yml` (utilization_m1_personal)

**Формула**:  
\[
УС = Базовая\ ставка \times Коэффициент
\]

- **Базовая ставка (М1, физ.лицо)**: **20 000 руб.**

> **Важно:**
> - Объём и мощность запрашиваются **для расчета по новой системе** (Минпромторг: с 2025 г. планируется переход на расчёт по мощности).  
> - Для коммерческих авто — не рассчитывается.

Спасибо за уточнение. Ниже — **точная, компактная и программно применимая версия утилизационного сбора для физических лиц при ввозе авто для личного пользования**, **действующая с 1 декабря 2015 г.**, согласно вашей таблице.

---

## ✅ **Формула расчёта утилизационного сбора (УС)**

\[
УС = Базовая\ ставка \times Коэффициент
\]

- **Базовая ставка** = **20 000 руб.**  
  (для легковых автомобилей категории М1, ввозимых физлицами для личного пользования)

> **Важно:** Коэффициент **зависит от объёма двигателя (см³) и мощности (кВт)**.  
> Значения приведены в таблице ниже.

---

## ✅ **Таблица коэффициентов утилизационного сбора**

| Объём двигателя | Мощность (кВт) | Коэффициент (до 3 лет) | Коэффициент (старше 3 лет) |
|------------------|----------------|------------------------|----------------------------|
| **≤ 1000 см³** | ≤ 51,48 | **0,17** | **0,26** |
| | 51,49 – 73,55 | **0,17** | **0,26** |
| | 73,56 – 95,61 | **0,17** | **0,26** |
| | 95,62 – 117,68 | **0,17** | **0,26** |
| | ≥ 117,69 | **см. строку ниже** | **см. ниже** |
| **1001–2000 см³** | ≤ 51,48 | **0,17** | **0,26** |
| | 51,49 – 73,55 | **0,17** | **0,26** |
| | 73,56 – 95,61 | **0,17** | **0,26** |
| | 95,62 – 117,68 | **0,17** | **0,26** |
| | 117,69 – 139,75 | **37,5** | **62,2** |
| | 139,76 – 161,81 | **39,7** | **66,0** |
| | 161,82 – 183,88 | **42,1** | **69,9** |
| | 183,89 – 205,94 | **47,6** | **76,6** |
| | 205,95 – 228,00 | **53,8** | **83,8** |
| | 228,01 – 250,07 | **60,8** | **91,8** |
| | 250,08 – 272,13 | **69,3** | **100,5** |
| | 272,14 – 294,20 | **79,0** | **110,0** |
| | 294,21 – 316,26 | **90,0** | **120,5** |
| | 316,27 – 338,33 | **102,7** | **132,0** |
| | 338,34 – 367,75 | **117,0** | **144,5** |
| | ≥ 367,76 | **133,4** | **158,2** |
| **2001–3000 см³** | ≤ 51,48 | **0,17** | **0,26** |
| | 51,49 – 73,55 | **0,17** | **0,26** |
| | 73,56 – 95,61 | **0,17** | **0,26** |
| | 95,62 – 117,68 | **0,17** | **0,26** |
| | 117,69 – 139,75 | **96,11** | **144,0** |
| | 139,76 – 161,81 | **98,5** | **145,9** |
| | 161,82 – 183,88 | **100,1** | **148,0** |
| | 183,89 – 205,94 | **105,0** | **152,5** |
| | 205,95 – 228,00 | **109,2** | **157,1** |
| | 228,01 – 250,07 | **113,6** | **161,4** |
| | 250,08 – 272,13 | **118,1** | **165,9** |
| | 272,14 – 294,20 | **122,9** | **170,6** |
| | 294,21 – 316,26 | **127,8** | **175,4** |
| | 316,27 – 338,33 | **132,9** | **180,3** |
| | 338,34 – 367,75 | **138,2** | **185,3** |
| | ≥ 367,76 | **143,7** | **190,5** |
| **3001–3500 см³** | ≤ 51,48 | **107,67** | **164,84** |
| | 51,49 – 73,55 | **107,67** | **164,84** |
| | 73,56 – 95,61 | **107,67** | **164,84** |
| | 95,62 – 117,68 | **107,67** | **164,84** |
| | 117,69 – 139,75 | **109,8** | **166,7** |
| | 139,76 – 161,81 | **112,0** | **168,5** |
| | 161,82 – 183,88 | **114,3** | **170,3** |
| | 183,89 – 205,94 | **117,1** | **172,7** |
| | 205,95 – 228,00 | **120,0** | **177,0** |
| | 228,01 – 250,07 | **126,6** | **181,5** |
| | 250,08 – 272,13 | **133,6** | **186,9** |
| | 272,14 – 294,20 | **141,0** | **192,5** |
| | 294,21 – 316,26 | **148,7** | **198,3** |
| | 316,27 – 338,33 | **156,9** | **204,2** |
| | 338,34 – 367,75 | **165,5** | **210,4** |
| | ≥ 367,76 | **174,6** | **216,7** |
| **> 3500 см³** | ≤ 51,48 | **137,11** | **180,24** |
| | 51,49 – 73,55 | **137,11** | **180,24** |
| | 73,56 – 95,61 | **137,11** | **180,24** |
| | 95,62 – 117,68 | **137,11** | **180,24** |
| | 117,69 – 139,75 | **139,4** | **182,9** |
| | 139,76 – 161,81 | **141,8** | **185,7** |
| | 161,82 – 183,88 | **144,2** | **188,5** |
| | 183,89 – 205,94 | **147,1** | **192,8** |
| | 205,95 – 228,00 | **150,0** | **197,2** |
| | 228,01 – 250,07 | **155,3** | **208,0** |
| | 250,08 – 272,13 | **160,73** | **219,5** |
| | 272,14 – 294,20 | **166,4** | **231,6** |
| | 294,21 – 316,26 | **172,2** | **244,3** |
| | 316,27 – 338,33 | **178,2** | **257,8** |
| | 338,34 – 367,75 | **184,4** | **272,0** |
| | ≥ 367,76 | **190,9** | **286,9** |

> **Для электромобилей и гибридов последовательного типа:**  
> применяется **первая строка таблицы** (объём = 0, только по мощности):
> - ≤ 58,84 кВт → 0,17 / 0,26  
> - 58,85–73,55 кВт → **41,3 / 68,4**  
> - и далее по данным вашей таблицы.

---

## ✅ **Как использовать в калькуляторе**

1. Пользователь вводит:
   - Объём двигателя (см³)
   - Мощность (л.с.) → конвертируется в кВт: `кВт = л.с. × 0.7355`
   - Год выпуска → определяет возраст (≤3 или >3 лет на дату расчёта)

2. Система:
   - Находит строку по объёму
   - Находит поддиапазон по мощности (кВт)
   - Выбирает коэффициент в зависимости от возраста
   - Считает: `УС = 20 000 × Коэффициент`

---

## ⚠️ Важно

- Эта таблица **не применяется** к:
  - Коммерческим авто (ЮЛ)
  - Пикапам, микроавтобусам, грузовикам (категории N1/N2/N3)
  - Электромобилям с иной гибридной схемой (не последовательного типа)
- Для таких ТС — иные базовые ставки (150 000 и 172 500 руб.)

---

Предоставить эту таблицу в виде **структурированного YAML** для прямой интеграции в код.

#### **4.3.3. Таможенная пошлина**

**✅ Статус: Реализовано в v2.0 (2025-12-08)**

Применяе��ся **по данным Таможенного союза ЕАЭС** (официальные ставки 2025).

> **Обновлено:** 2025-12-08 — исправлены пороговые значения для авто ≤3 лет (используются EUR, не RUB)

##### **Для авто ≤ 3 лет**  
Расчёт **по таможенной стоимости в евро и объёму**:

| Таможенная стоимость (EUR) | Ставка |
|----------------------------|--------|
| < 8 500 | 54% от стоимости, **но не менее 2.5 €/см³** |
| 8 500–16 700 | 48%, **не менее 3.5 €/см��** |
| 16 700–42 300 | 48%, **не менее 5.5 €/см³** |
| 42 300–84 500 | 48%, **не менее 7.5 €/см³** |
| 84 500–169 000 | 48%, **не менее 15 €/см³** |
| > 169 000 | 48%, **не менее 20 €/см³** |

> **Алгоритм расчета:**
> 1. Таможенная стоимость = Цена покупки (RUB) / Курс EUR_RUB
> 2. Определяется брэкет по таможенной стоимости в EUR
> 3. Рассчитываются два значения:
>    - `duty_percent = customs_value_eur × percent`
>    - `duty_min = engine_cc × min_rate_eur_per_cc`
> 4. **Выбирается МАКСИМАЛЬНОЕ** из двух значений
> 5. Конвертация в RUB: `duty_rub = duty_eur × EUR_RUB`

##### **Для авто 3–5 лет**  
Фиксированная ставка по объёму:

| Объём (см³) | Ставка (€/см³) |
|-------------|----------------|
| ≤ 1000 | 1.5 |
| 1001–1500 | 1.7 |
| 1501–1800 | 2.5 |
| 1801–2300 | 2.7 |
| 2301–3000 | 3.0 |
| > 3000 | 3.6 |

##### **Для авто > 5 лет**

| Объём (см³) | Ставка (€/см³) |
|-------------|----------------|
| ≤ 1000 | 3.0 |
| 1001–1500 | 3.2 |
| 1501–1800 | 3.5 |
| 1801–2300 | 4.8 |
| 2301–3000 | 5.0 |
| > 3000 | 5.7 |

> **Курс евро**: используется актуальный (API).

#### **4.3.4. ЭРА-ГЛОНАСС**

**✅ Статус: Реализовано в v2.0 (2025-12-08)**

- **Базовая ставка:** 45,000 руб. (configurable)
- Стоимость: **35 000 – 50 000 руб.**  
- **Рекомендация**: отображать **45 000 руб.** как базовую, с примечанием: «Сумма может измениться в зависимости от конъюнктуры».

**Конфигурация:** `config/rates.yml` (era_glonass_rub)

---

### **4.4. Комиссия компании**

**✅ Статус: Реализовано в v2.0 (2025-12-08)**

- **Единая фиксированная ставка комиссии компании:** 1000 USD для всех стран.
- **Исключение:** ОАЭ — комиссия 0 USD (включена в расходы страны).

**Конфигурация:** `config/commissions.yml` (ключи `default_commission_usd`, `by_country.*.commission_usd`).

> **Важно:** это **комиссия компании-поставщика услуги** (брокер, сопровождение и т.п.), а не банковская комиссия.

---

### **4.5. Банковская комиссия (надбавка к валютному курсу)**

Банковская комиссия вводится как **надбавка к валютному курсу**, а не как отдельная рублёвая сумма.
Она настраивается в файле `config/commissions.yml` в секции `bank_commission`.

### 4.5.1. Структура секции `bank_commission` в `config/commissions.yml`

```yaml
bank_commission:
  enabled: false            # опционально; false или отсутствие секции = 0% комиссии
  percent: 0.0              # глобальная надбавка к курсу, в процентах

  meta:
    recommended_min: 0.0    # рекомендуемый минимум
    recommended_max: 10.0   # рекомендуемый максимум (мягкое ограничение)
    warn_above: 10.0        # порог, выше которого конфиг в будущем помечается warning'ом
    default_percent: 0.0    # значение по умолчанию, если percent не задан
```

**Инварианты и поведение по умолчанию**

- Если секция `bank_commission` **отсутствует** в `commissions.yml`, поведение эквивалентно:
  - `bank_commission.enabled = false` и `bank_commission.percent = 0.0`.
- Если секция присутствует, но:
  - `enabled: false` — фактический процент комиссии = 0.0 независимо от `percent`;
  - ключ `enabled` отсутствует — по умолчанию трактуем как `enabled = true`;
  - ключ `percent` отсутствует — используется `meta.default_percent` (если он не задан, трактуем как 0.0).
- Рекомендуемый диапазон значений:
  - `meta.recommended_min` — обычно 0.0;
  - `meta.recommended_max` — 10.0 (значения выше считаются допустимыми, но нежелательными).
- `meta.warn_above` задаёт мягкий порог, при превышении которого конфиг должен в будущем помечаться предупреждением (warning), но не считается невалидным.

### 4.5.2. Контракт с движком и метаданными

- `bank_commission.percent` интерпретируется как процентная надбавка к базовому курсу валюты:

  \[
  effective\_rate = base\_rate \times (1 + bank\_commission\_percent / 100)
  \]

- Все рублёвые суммы, зависящие от валютного курса (стоимость авто, фрахт, расходы по стране,
  комиссия компании и т.д.), в будущей реализации должны вычисляться через `effective_rate`.
- Эффект банковской комиссии **не выводится отдельной строкой** в breakdown; он отражается только через:
  - изменённое значение `breakdown.total_rub`;
  - структуру `CalculationMeta.rates_used`.

### 4.5.3. Контракт с API и `CalculationMeta.rates_used`

- Структура JSON-ответов `/api/calculate` и `/api/rates` остаётся прежней: новые поля
  `bank_commission_*` в публичный контракт **не добавляются**.
- Знание о банковской комиссии для клиентов доступно только через метаданные о курсах.
- В будущем для каждой валюты в `CalculationMeta.rates_used` должны быть доступны:
  - `base_rate` — базовый курс без банковской комиссии;
  - `bank_commission_percent` — применённый процент надбавки;
  - `effective_rate` — фактический курс, использованный при расчётах.

**Обратная совместимость**

- При отсутствии секции `bank_commission` или её ключей (`enabled`, `percent`) текущее поведение
  калькулятора сохраняется: используется базовый курс без надбавки.
- Добавление секции `bank_commission` в `commissions.yml` не должно требовать изменений от
  существующих клиентов API до тех пор, пока не будет реализована логика `effective_rate` в движке
  и расширение метаданных `rates_used`.

---

## ✅ Как использовать в калькуляторе (обновление в части commission)

1. Пользователь вводит:
   - Объём двигателя (см³)
   - Мощность (л.с.) → конвертируется в кВт: `кВт = л.с. × 0.7355`
   - Год выпуска → определяет возраст (≤3 или >3 лет на дату расчёта)

2. Система:
   - Находит строку по объёму
   - Находит поддиапазон по мощности (кВт)
   - Выбирает коэффициент в зависимости от возраста
   - Считает: `УС = 20 000 × Коэффициент`

3. **Комиссия компании:**
   - Всегда **1000 USD** (для всех стран, кроме ОАЭ).
   - Для ОАЭ — комиссия **0 USD** (включена в расходы страны).

4. **Банковская комиссия:**
   - Применяется как надбавка к валютному курсу для всех операций в иностранной валюте.

### 4.5.4. Тестовые конфиги комиссий

Для изоляции и детерминированности тестов используются отдельные YAML-конфиги комиссий
в каталоге `tests/test_data/config`:

- `commissions_company_only.yml` — тестовый конфиг с только комиссией компании
  (`default_commission_usd`, `by_country.uae.commission_usd = 0`) **без** секции
  `bank_commission`. Этот файл применяется через тестовую фикстуру, чтобы функциональные
  и интеграционные тесты работали с предсказуемой схемой комиссий, совпадающей по формату
  с `config/commissions.yml`.
- `commissions_with_bank.yml` — тестовый пример того же формата, но с включённой секцией
  `bank_commission` (enabled + percent + meta.*). Он предназначен для сценариев, где нужно
  явно проверить влияние банковской комиссии в будущих спринтах.

Эти файлы **не меняют** контракт публичного API и не используются в боевом окружении; они
служат только для тестов и примеряют целевой формат `bank_commission` к реальной схеме
`commissions.yml`.
