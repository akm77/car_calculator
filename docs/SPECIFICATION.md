Обновлённое **техническое задание (ТЗ)** на калькулятор стоимости ввоза легковых автомобилей в РФ, с учётом новых требований по утилизационному сбору и актуальных данных из официальных источников (включая необходимость запроса **мощности в л.с.** и использования **кВт** в расчётах, а также актуальные ставки по утильсбору и пошлине на 2025 год).

---

# **Техническое задание: Калькулятор ввоза легковых автомобилей в РФ (2025)**

## **1. Общие положения**

Калькулятор предназначен для расчёта **полной стоимости ввоза и оформления** легкового автомобиля категории **M1 (некоммерческое использование)** на территорию Российской Федерации из следующих стран:
- Япония  
- Республика Корея  
- ОАЭ  
- Китай  
- Грузия  

> **Не применяется** к коммерческим, грузовым, пассажирским, спецТС, электромобилям с иной категорией, пикапам и авто категории N. Для таких ТС — только ручной расчёт через поддержку.

---

## **2. Входные данные от пользователя**

Калькулятор должен запрашивать у пользователя:

| Поле | Тип | Комментарий |
|------|-----|-------------|
| Страна происхождения | Список | Япония, Корея, ОАЭ, Китай, Грузия |
| Год выпуска | Число | Определяет возраст авто и категорию пошлины |
| Стоимость автомобиля | Число + валюта | Для Японии — в JPY, для остальных — в USD или RUB (с конвертацией) |
| Объём двигателя | Число (см³) | Обязателен для расчёта пошлины и текущего утильсбора |
| Мощность двигателя | Число (л.с.) | Обязательно запрашивается — для будущих расчётов и внутреннего перевода в кВт |
| Тип транспортировки | Выбор (только для ОАЭ) | Открытый / Контейнер |
| Санкционный статус | Чекбокс (только для Японии) | Если не уверен — подсказка: «Обратитесь в поддержку» |

> **Примечание:**  
> Внутренне: `Мощность (кВт) = Мощность (л.с.) × 0.7355` — сохраняется для возможного перехода на новую систему утильсбора (по мощности).

---

## **3. Классификация автомобилей**

**✅ Статус: Реализовано в v2.0 (2025-12-08)**

- **«Проходные» авто**: **2020–2022 гг.** — стандартные ставки пошлины.  
- **«Непроходные» авто**: **2023–2025 гг.** — повышенные таможенные платежи.

> **Алгоритм**:  
> Калькулятор **автоматически определяет возраст** по году выпуска и текущей дате (7 декабря 2025 г.).

---

## **4. Структура расчёта**

Для каждой страны рассчитывается:

### **4.1. о**

| Страна | Условия | Сумма |
|--------|--------|--------|
| **Япония** | ≤ 3 000 000 JPY | 150 000 JPY |
| | 3 000 001 – 6 000 000 JPY | 300 000 JPY |
| | > 6 000 000 JPY | 400 000 JPY |
| **Корея** | Любой | 500 USD |
| **ОАЭ** | Любой | 1 000 USD |
| **Китай** | Любой | 1 000 USD |
| **Грузия** | Любой | 750 USD |

> Включает: осмотр, проверку, брокерские услуги, доставку до порта.

---

### **4.2. Фрахт и портовые сборы**

| Страна | Условия | Сумма (USD) | Порт назначения |
|--------|--------|--------------|------------------|
| **Япония** | Несанкционный | 350 | Владивосток / Находка |
| | Санкционный | 2 000 | Владивосток / Находка |
| **Корея** | Любой | 1 000 | Владивосток / Находка |
| **Китай** | Любой | 1 000 | Дальний Восток |
| **Грузия** | Любой | 750 | РФ (по умолчанию — Новороссийск) |
| **ОАЭ** | Открытый | 2 500 | Астрахань, Новороссийск, СПб |
| | Контейнер | 3 800 | Астрахань, Новороссийск, СПб, Владивосток |

---

### **4.3. Затраты на территории РФ**

#### **4.3.1. Услуги по таможенному оформлению**

| Страна | Сумма (RUB) |
|--------|-------------|
| Япония, Корея, Китай | 70 000 |
| Грузия | 120 000 |
| ОАЭ | 150 000 |

> Включает: СВХ, СБКТС, ЭПТС (для ОАЭ, Китая, Грузии).

#### **4.3.2. Утилизационный сбор (УС)**

**✅ Статус: Реализовано в v2.0 (2025-12-08)**

Новая система утилизационного сбора с двумерной таблицей (объём + мощность).

**Входные данные:**
- Объём двигателя (см³)
- **Мощность двигателя (л.с.)** ← НОВОЕ ОБЯЗАТЕЛЬНОЕ ПОЛЕ
- Возраст автомобиля

**Расчёт:**
1. Конвертация л.с. → кВт: `kw = hp × 0.7355`
2. Поиск диапазона объёма (5 bands)
3. Поиск диапазона мощности в выбранном band
4. Выбор коэффициента (lt3 или gt3)
5. Расчёт: `fee = 20,000 ₽ × coefficient`

**Конфигурация:** `config/rates.yml` (utilization_m1_personal)

**Формула**:  
\[
УС = Базовая\ ставка \times Коэффициент
\]

- **Базовая ставка (М1, физ.лицо)**: **20 000 руб.**

> **Важно:**
> - Объём и мощность запрашиваются **для расчета по новой системе** (Минпромторг: с 2025 г. планируется переход на расчёт по мощности).  
> - Для коммерческих авто — не рассчитывается.

Спасибо за уточнение. Ниже — **точная, компактная и программно применимая версия утилизационного сбора для физических лиц при ввозе авто для личного пользования**, **действующая с 1 декабря 2015 г.**, согласно вашей таблице.

---

## ✅ **Формула расчёта утилизационного сбора (УС)**

\[
УС = Базовая\ ставка \times Коэффициент
\]

- **Базовая ставка** = **20 000 руб.**  
  (для легковых автомобилей категории М1, ввозимых физлицами для личного пользования)

> **Важно:** Коэффициент **зависит от объёма двигателя (см³) и мощности (кВт)**.  
> Значения приведены в таблице ниже.

---

## ✅ **Таблица коэффициентов утилизационного сбора**

| Объём двигателя | Мощность (кВт) | Коэффициент (до 3 лет) | Коэффициент (старше 3 лет) |
|------------------|----------------|------------------------|----------------------------|
| **≤ 1000 см³** | ≤ 51,48 | **0,17** | **0,26** |
| | 51,49 – 73,55 | **0,17** | **0,26** |
| | 73,56 – 95,61 | **0,17** | **0,26** |
| | 95,62 – 117,68 | **0,17** | **0,26** |
| | ≥ 117,69 | **см. строку ниже** | **см. ниже** |
| **1001–2000 см³** | ≤ 51,48 | **0,17** | **0,26** |
| | 51,49 – 73,55 | **0,17** | **0,26** |
| | 73,56 – 95,61 | **0,17** | **0,26** |
| | 95,62 – 117,68 | **0,17** | **0,26** |
| | 117,69 – 139,75 | **37,5** | **62,2** |
| | 139,76 – 161,81 | **39,7** | **66,0** |
| | 161,82 – 183,88 | **42,1** | **69,9** |
| | 183,89 – 205,94 | **47,6** | **76,6** |
| | 205,95 – 228,00 | **53,8** | **83,8** |
| | 228,01 – 250,07 | **60,8** | **91,8** |
| | 250,08 – 272,13 | **69,3** | **100,5** |
| | 272,14 – 294,20 | **79,0** | **110,0** |
| | 294,21 – 316,26 | **90,0** | **120,5** |
| | 316,27 – 338,33 | **102,7** | **132,0** |
| | 338,34 – 367,75 | **117,0** | **144,5** |
| | ≥ 367,76 | **133,4** | **158,2** |
| **2001–3000 см³** | ≤ 51,48 | **0,17** | **0,26** |
| | 51,49 – 73,55 | **0,17** | **0,26** |
| | 73,56 – 95,61 | **0,17** | **0,26** |
| | 95,62 – 117,68 | **0,17** | **0,26** |
| | 117,69 – 139,75 | **96,11** | **144,0** |
| | 139,76 – 161,81 | **98,5** | **145,9** |
| | 161,82 – 183,88 | **100,1** | **148,0** |
| | 183,89 – 205,94 | **105,0** | **152,5** |
| | 205,95 – 228,00 | **109,2** | **157,1** |
| | 228,01 – 250,07 | **113,6** | **161,4** |
| | 250,08 – 272,13 | **118,1** | **165,9** |
| | 272,14 – 294,20 | **122,9** | **170,6** |
| | 294,21 – 316,26 | **127,8** | **175,4** |
| | 316,27 – 338,33 | **132,9** | **180,3** |
| | 338,34 – 367,75 | **138,2** | **185,3** |
| | ≥ 367,76 | **143,7** | **190,5** |
| **3001–3500 см³** | ≤ 51,48 | **107,67** | **164,84** |
| | 51,49 – 73,55 | **107,67** | **164,84** |
| | 73,56 – 95,61 | **107,67** | **164,84** |
| | 95,62 – 117,68 | **107,67** | **164,84** |
| | 117,69 – 139,75 | **109,8** | **166,7** |
| | 139,76 – 161,81 | **112,0** | **168,5** |
| | 161,82 – 183,88 | **114,3** | **170,3** |
| | 183,89 – 205,94 | **117,1** | **172,7** |
| | 205,95 – 228,00 | **120,0** | **177,0** |
| | 228,01 – 250,07 | **126,6** | **181,5** |
| | 250,08 – 272,13 | **133,6** | **186,9** |
| | 272,14 – 294,20 | **141,0** | **192,5** |
| | 294,21 – 316,26 | **148,7** | **198,3** |
| | 316,27 – 338,33 | **156,9** | **204,2** |
| | 338,34 – 367,75 | **165,5** | **210,4** |
| | ≥ 367,76 | **174,6** | **216,7** |
| **> 3500 см³** | ≤ 51,48 | **137,11** | **180,24** |
| | 51,49 – 73,55 | **137,11** | **180,24** |
| | 73,56 – 95,61 | **137,11** | **180,24** |
| | 95,62 – 117,68 | **137,11** | **180,24** |
| | 117,69 – 139,75 | **139,4** | **182,9** |
| | 139,76 – 161,81 | **141,8** | **185,7** |
| | 161,82 – 183,88 | **144,2** | **188,5** |
| | 183,89 – 205,94 | **147,1** | **192,8** |
| | 205,95 – 228,00 | **150,0** | **197,2** |
| | 228,01 – 250,07 | **155,3** | **208,0** |
| | 250,08 – 272,13 | **160,73** | **219,5** |
| | 272,14 – 294,20 | **166,4** | **231,6** |
| | 294,21 – 316,26 | **172,2** | **244,3** |
| | 316,27 – 338,33 | **178,2** | **257,8** |
| | 338,34 – 367,75 | **184,4** | **272,0** |
| | ≥ 367,76 | **190,9** | **286,9** |

> **Для электромобилей и гибридов последовательного типа:**  
> применяется **первая строка таблицы** (объём = 0, только по мощности):
> - ≤ 58,84 кВт → 0,17 / 0,26  
> - 58,85–73,55 кВт → **41,3 / 68,4**  
> - и далее по данным вашей таблицы.

---

## ✅ **Как использовать в калькуляторе**

1. Пользователь вводит:
   - Объём двигателя (см³)
   - Мощность (л.с.) → конвертируется в кВт: `кВт = л.с. × 0.7355`
   - Год выпуска → определяет возраст (≤3 или >3 лет на дату расчёта)

2. Система:
   - Находит строку по объёму
   - Находит поддиапазон по мощности (кВт)
   - Выбирает коэффициент в зависимости от возраста
   - Считает: `УС = 20 000 × Коэффициент`

---

## ⚠️ Важно

- Эта таблица **не применяется** к:
  - Коммерческим авто (ЮЛ)
  - Пикапам, микроавтобусам, грузовикам (категории N1/N2/N3)
  - Электромобилям с иной гибридной схемой (не последовательного типа)
- Для таких ТС — иные базовые ставки (150 000 и 172 500 руб.)

---

Предоставить эту таблицу в виде **структурированного YAML** для прямой интеграции в код.

#### **4.3.3. Таможенная пошлина**

**✅ Статус: Реализовано в v2.0 (2025-12-08)**

Применяе��ся **по данным Таможенного союза ЕАЭС** (официальные ставки 2025).

> **Обновлено:** 2025-12-08 — исправлены пороговые значения для авто ≤3 лет (используются EUR, не RUB)

##### **Для авто ≤ 3 лет**  
Расчёт **по таможенной стоимости в евро и объёму**:

| Таможенная стоимость (EUR) | Ставка |
|----------------------------|--------|
| < 8 500 | 54% от стоимости, **но не менее 2.5 €/см³** |
| 8 500–16 700 | 48%, **не менее 3.5 €/см��** |
| 16 700–42 300 | 48%, **не менее 5.5 €/см³** |
| 42 300–84 500 | 48%, **не менее 7.5 €/см³** |
| 84 500–169 000 | 48%, **не менее 15 €/см³** |
| > 169 000 | 48%, **не менее 20 €/см³** |

> **Алгоритм расчета:**
> 1. Таможенная стоимость = Цена покупки (RUB) / Курс EUR_RUB
> 2. Определяется брэкет по таможенной стоимости в EUR
> 3. Рассчитываются два значения:
>    - `duty_percent = customs_value_eur × percent`
>    - `duty_min = engine_cc × min_rate_eur_per_cc`
> 4. **Выбирается МАКСИМАЛЬНОЕ** из двух значений
> 5. Конвертация в RUB: `duty_rub = duty_eur × EUR_RUB`

##### **Для авто 3–5 лет**  
Фиксированная ставка по объёму:

| Объём (см³) | Ставка (€/см³) |
|-------------|----------------|
| ≤ 1000 | 1.5 |
| 1001–1500 | 1.7 |
| 1501–1800 | 2.5 |
| 1801–2300 | 2.7 |
| 2301–3000 | 3.0 |
| > 3000 | 3.6 |

##### **Для авто > 5 лет**

| Объём (см³) | Ставка (€/см³) |
|-------------|----------------|
| ≤ 1000 | 3.0 |
| 1001–1500 | 3.2 |
| 1501–1800 | 3.5 |
| 1801–2300 | 4.8 |
| 2301–3000 | 5.0 |
| > 3000 | 5.7 |

> **Курс евро**: используется актуальный (API).

#### **4.3.4. ЭРА-ГЛОНАСС**

**✅ Статус: Реализовано в v2.0 (2025-12-08)**

- **Базовая ставка:** 45,000 руб. (configurable)
- Стоимость: **35 000 – 50 000 руб.**  
- **Рекомендация**: отображать **45 000 руб.** как базовую, с примечанием: «Сумма может измениться в зависимости от конъюнктуры».

**Конфигурация:** `config/rates.yml` (era_glonass_rub)

---

### **4.4. Комиссия компании**

**✅ Статус: Реализовано в v2.0 (2025-12-08)**

- **Единая фиксированная ставка комиссии компании:** 1000 USD для всех стран.
- **Исключение:** ОАЭ — комиссия 0 USD (включена в расходы страны).

**Конфигурация:** `config/commissions.yml` (ключи `default_commission_usd`, `by_country.*.commission_usd`).

> **Важно:** это **комиссия компании-поставщика услуги** (брокер, сопровождение и т.п.), а не банковская комиссия.

---

### **4.5. Банковская комиссия (надбавка к валютному курсу)**

Банковская комиссия вводится как **надбавка к валютному курсу**, а не как отдельная рублёвая строка в breakdown. Она настраивается в `config/commissions.yml` в секции `bank_commission` и влияет только на те компоненты, которые считаются в валюте и затем конвертируются в RUB.

Структура секции в боевом конфиге:

```yaml
bank_commission:
  enabled: false
  percent: 0.0
  meta:
    recommended_min: 0.0
    recommended_max: 10.0
    warn_above: 10.0
    default_percent: 0.0
```

- `enabled`: если `false` или секция `bank_commission` отсутствует — комиссия считается равной 0%.
- `percent`: глобальный процент надбавки к курсу (в процентах) для всех валютных конвертаций.
- `meta.default_percent`: используется, если `percent` не задан (fallback).
- `meta.recommended_min` / `meta.recommended_max` / `meta.warn_above`: диапазоны и пороги, полезные для валидации и предупреждений; текущая реализация движка только читает `percent` и не добавляет специальных warning-кодов по превышению порога, но формат оставлен на будущее.

Если секции `bank_commission` нет, либо она не является словарём, либо `enabled=false`, либо значение `percent`/`default_percent` не удаётся привести к числу, движок трактует банковскую комиссию как 0%.

#### 4.5.2. Алгоритм применения комиссии в движке

Пусть `base_rate` — базовый курс `VALUTA/RUB` из `rates_conf["currencies"]["<CODE>_RUB"]` после слияния статических и live‑курсов в `get_effective_rates`. Тогда движок считает:

\[
  effective\_rate = base\_rate \times (1 + bank\_commission\_percent / 100)
\]

где `bank_commission_percent` извлекается функцией `_get_bank_commission_percent(commissions_conf)` в `app/calculation/engine.py`.

Для большинства внешних конвертаций используется вспомогательная функция `_convert(amount, currency, rates_conf, bank_commission_percent=None)`, которая:

- при `bank_commission_percent is None` использует **базовый курс** (режим обратной совместимости);
- при заданном `bank_commission_percent` использует **эффективный курс**.

Обратная конвертация `RUB -> VALUTA` для внутренних расчётов (например, нормализация японских тиров) выполняется через `_convert_from_rub` и всегда использует базовый курс без надбавки.

#### 4.5.3. Операции, на которые влияет банковская комиссия

Комиссия влияет на все реальные валютные платежи пользователя, которые конвертируются в RUB через `_convert(..., bank_commission_percent)`:

- **`purchase_price_rub`** — стоимость автомобиля в RUB, если входная валюта не RUB;
- **`country_expenses_rub`** — страновые расходы в валюте (JPY, USD и др.);
- **`freight_rub`** — фрахт и портовые сборы в иностранной валюте;
- **`company_commission_rub`** — комиссия компании, заданная в USD и пересчитанная в RUB по текущему курсу.

При этом:

- расчёт таможенной пошлины использует только базовый курс `EUR_RUB` (через `_currency_rate`) и *не учитывает банковскую комиссию*;
- утильсбор и внутренние расходы в РФ считаются в RUB и не зависят от надбавки к курсу;
- для ОАЭ (`uae`) комиссия компании по‑прежнему равна 0 USD и остаётся 0 RUB даже при ненулевой банковской комиссии (инвариант, покрытый тестами).

#### 4.5.4. Связь с CalculationMeta и meta.rates_used

В модели `CalculationMeta` (см. `app/calculation/models.py`) используются два связанных поля:

- `rates_used: dict[str, float]` — числовое представление курсов `XXX_RUB` (для обратной совместимости и отладки);
- `detailed_rates_used: dict[str, RateUsage]` — расширенное описание курсов для клиентов.

Модель `RateUsage` содержит:

- `base_rate: float` — базовый курс `XXX_RUB` без учёта банковской комиссии;
- `effective_rate: float` — курс с учётом надбавки (`base_rate * (1 + bank_commission_percent/100)`);
- `bank_commission_percent: float` — фактически применённый процент (0.0, если комиссия отключена);
- `display: str` — человекочитаемая строка для UI, формируемая на сервере, в формате:
  - `"USD/RUB = 90.0"` при `bank_commission_percent == 0`;
  - `"USD/RUB = 90.0 + 2.0%"` при ненулевой комиссии.

Эти поля сериализуются в ответ `/api/calculate` в объекте `meta`. Текущие клиенты используют **только** `detailed_rates_used[*].display` для отображения курса и не зависят от внутренней формы `RateUsage`.

Инварианты контракта:

- Отсутствие или отключение банковской комиссии (`enabled=false` или нет секции) эквивалентно `bank_commission_percent == 0`:
  - `effective_rate == base_rate`;
  - `display` не содержит `+ P%`.
- При фиксированных входных данных и базовых курсах для любой валюты:
  - `bank_commission_percent_1 < bank_commission_percent_2` ⇒ `effective_rate_1 < effective_rate_2`;
  - все задействованные валютно‑зависимые компоненты в breakdown (и `total_rub`) возрастают.
- Структура ответа `/api/calculate` **не** добавляет отдельные поля для банковской комиссии в `breakdown`: её эффект виден только через суммы в RUB и через `meta.rates_used`/`meta.detailed_rates_used`.

#### 4.5.5. Тестовые конфиги комиссий

Для изоляции банковской комиссии и детерминированности тестов используются отдельные YAML‑конфиги в каталоге `tests/test_data/config`:

- `commissions_company_only.yml` — тестовый конфиг только с комиссией компании (`default_commission_usd`, `by_country.uae.commission_usd = 0`) **без** секции `bank_commission`. Он автоматически подхватывается во всех функциональных тестах через фикстуру `_ensure_test_commissions_defaults` в `tests/conftest.py`.
- `commissions_with_bank.yml` — тестовый пример того же формата, но с включённой секцией `bank_commission` (enabled + percent + meta.*). В функциональных тестах банк. комиссии (`tests/functional/test_api_bank_commission.py`) он подменяется через фикстуру `_patch_commissions`, чтобы сравнивать сценарии с 0% и с ненулевой комиссией, не затрагивая боевой конфиг.

Эти файлы **не меняют** контракт публичного API и не используются в боевом окружении; они
служат только для тестов и примеряют целевой формат `bank_commission` к реальной схеме
`commissions.yml`.
