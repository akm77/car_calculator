# Спринт 3: Дизайн изменений API и клиентов (WebApp, Telegram‑бот)

## Роль модели

- Модель выступает как **архитектор интеграций и клиентских интерфейсов**, который проектирует, как банковская комиссия будет отражаться в API и UI, не раскрывая внутренних деталей расчёта.
- Работа ведётся по методике **RPG**, с явным описанием ролей (API, Web, бот), процессов (поток данных из движка в клиенты), границ и артефактов.

## Методика RPG

- **Роли:**
  - API‑слой: `app/api/routes.py`, модели ответа из `app/calculation/models.py`.
  - WebApp: `app/webapp/index.html`, JS‑модули в `app/webapp/js/**`, статические ресурсы.
  - Telegram‑бот: `app/bot/main.py`, `app/bot/handlers/**`, `app/bot/keyboards.py`.
- **Процессы:**
  - `engine.calculate()` → `CalculationResult` → сериализация в JSON → обработка на фронтенде и в боте.
  - Отображение `meta.rates_used` и `total_rub` с учётом банковской комиссии.
- **Границы:**
  - На этом спринте **не меняется бизнес‑логика движка** и не добавляется код расчёта комиссии.
  - Меняются и дополняются только:
    - описание API,
    - требования к отображению на фронтенде и в боте,
    - RPG‑описание взаимодействий.
- **Артефакты:**
  - Обновлённые разделы `docs/API_RESULT_FLOW.md`, `docs/SPECIFICATION.md` по ответу `/api/calculate`.
  - Описание ожидаемого поведения WebApp и бота при наличии/отсутствии банковской комиссии.

## Источники правды

- `docs/SPECIFICATION.md` — структура ответа `CalculationResult`, описание `CalculationMeta` и `CostBreakdown`.
- `docs/API_RESULT_FLOW.md` — текущий контракт и примеры JSON для `/api/calculate` и связанных методов.
- `docs/rpg.yaml` и `docs/rpg_intro.txt` — описание RPG‑узлов и потоков данных.
- `app/api/routes.py` — реализация API‑эндпоинтов.
- `app/webapp/js/**`, `app/webapp/index.html` — реализация отображения результатов расчёта в Web.
- `app/bot/**` — реализация ответов бота и форматирования сообщений.

## Цели спринта

1. **Спроектировать изменения в API‑контракте без изменения формата JSON**:
   - Подтвердить, что структура ответа `/api/calculate` сохраняется (те же поля),
     но семантика `breakdown.total_rub` меняется: теперь она включает банковскую комиссию.
   - Определить, какие поля `CalculationMeta` нужны для корректного отображения комиссии через `rates_used`.
2. **Зафиксировать поведение WebApp**:
   - Описать, как WebApp должен отображать курс:
     - при комиссии > 0: `USD/RUB = 78.95 + 1%`,
     - при комиссии = 0 или отсутствии: `USD/RUB = 78.95`.
   - Уточнить место в UI, где выводится эта информация, и то, что пользователь **не может** изменять комиссию.
3. **Зафиксировать поведение Telegram‑бота**:
   - Определить формат текстового вывода для курса в сообщениях бота аналогично WebApp.
   - Убедиться, что никакие новые команды/поля ввода не добавляются.
4. **Обновить RPG‑описание взаимодействий**:
   - В `docs/rpg.yaml` отразить, что:
     - API получает `meta.rates_used` и передаёт его клиентам,
     - WebApp и бот используют эти данные для отображения комиссии через курс, не зная внутренних деталей.

## Критерии достижения целей

1. В `docs/API_RESULT_FLOW.md` и/или `docs/SPECIFICATION.md`:
   - Явно указано, что `breakdown.total_rub` теперь включает банковскую комиссию.
   - Описано, что банковская комиссия **не имеет собственных полей** в JSON.
   - Структура `CalculationMeta` дополнена/уточнена так, чтобы клиенты могли строить строки вида `BASE_RATE [+ PERCENT%]`.
2. Для WebApp есть документация (в виде текста/диаграмм):
   - Где именно выводится информация о курсе.
   - Как формируется строка с `+ X%` при ненулевой комиссии.
   - Подтверждение, что интерфейс ввода не изменяется (комиссия полностью управляется конфигом).
3. Для Telegram‑бота есть аналогичное описание:
   - Формат одной или нескольких строк в ответе, содержащих курс.
   - Условие показа `+ X%`.
4. В `docs/rpg.yaml` обновлены связи между узлами:
   - `engine.py` → `models.CalculationMeta` → `api.routes` → `webapp` / `bot`.
   - Добавлено указание, что банковская комиссия на клиенте видна только как надбавка к курсу, без раскрытия сумм.

