# Спринт 3: Дизайн изменений API и клиентов (WebApp, Telegram‑бот)

## Роль модели

- Модель выступает как **архитектор интеграций и клиентских интерфейсов**, который проектирует, как банковская комиссия будет отражаться в API и UI, не раскрывая внутренних деталей расчёта.
- Работа ведётся по методике **RPG**, с явным описанием ролей (API, Web, бот), процессов (поток данных из движка в клиенты), границ и артефактов.

## Методика RPG

- **Роли:**
  - API‑слой: `app/api/routes.py`, модели ответа из `app/calculation/models.py`.
  - WebApp: `app/webapp/index.html`, JS‑модули в `app/webapp/js/**`, статические ресурсы.
  - Telegram‑бот: `app/bot/main.py`, `app/bot/handlers/**`, `app/bot/keyboards.py`.
- **Процессы:**
  - `engine.calculate()` → `CalculationResult` → сериализация в JSON → обработка на фронтенде и в боте.
  - Отображение `meta.rates_used` и `total_rub` с учётом банковской комиссии.
- **Границы:**
  - На этом спринте **не меняется бизнес‑логика движка** и не добавляется код расчёта комиссии.
  - Меняются и дополняются только:
    - описание API,
    - требования к отображению на фронтенде и в боте,
    - RPG‑описание взаимодействий.
- **Артефакты:**
  - Обновлённые разделы `docs/API_RESULT_FLOW.md`, `docs/SPECIFICATION.md` по ответу `/api/calculate`.
  - Описание ожидаемого поведения WebApp и бота при наличии/отсутствии банковской комиссии.

### Мини‑диаграмма потока данных (в контексте спринта 3)

```text
[engine.calculate]
    ├─ считает CostBreakdown (RUB, уже по effective_rate)
    ├─ формирует CalculationMeta (включая rates_used и detailed_rates_used)
    ▼
[CalculationResult]
    ├─ возвращается из engine → api.routes
    ├─ сериализуется FastAPI как JSON (breakdown, meta, request)
    ▼
[/api/calculate]
    ├─ вызывает engine, не меняя структуру JSON
    ▼
[WebApp]
    ├─ читает breakdown.total_rub и детали расходов
    ├─ читает meta.rates_used / detailed_rates_used.display
    └─ показывает строку курса: "USD/RUB = BASE_RATE [+ PERCENT%]"

[Telegram‑бот]
    ├─ получает CalculationResult (через engine/API)
    ├─ использует breakdown.total_rub и meta.rates_used
    └─ показывает строку курса в сообщении, без отдельных сумм комиссии
```

## Источники правды

- `docs/SPECIFICATION.md` — структура ответа `CalculationResult`, описание `CalculationMeta` и `CostBreakdown`.
- `docs/API_RESULT_FLOW.md` — текущий контракт и примеры JSON для `/api/calculate` и связанных методов.
- `docs/rpg.yaml` и `docs/rpg_intro.txt` — описание RPG‑узлов и потоков данных.
- `app/api/routes.py` — реализация API‑эндпоинтов.
- `app/webapp/js/**`, `app/webapp/index.html` — реализация отображения результатов расчёта в Web.
- `app/bot/**` — реализация ответов бота и форматирования сообщений.

## Цели спринта

1. **Спроектировать изменения в API‑контракте без изменения формата JSON**:
   - Подтвердить, что структура ответа `/api/calculate` сохраняется (те же поля),
     но семантика `breakdown.total_rub` меняется: теперь она включает банковскую комиссию.
   - Определить, какие поля `CalculationMeta` нужны для корректного отображения комиссии через `rates_used`.
2. **Зафиксировать поведение WebApp**:
   - Описать, как WebApp должен отображать курс:
     - при комиссии > 0: `USD/RUB = 78.95 + 1%`,
     - при комиссии = 0 или отсутствии: `USD/RUB = 78.95`.
   - Уточнить место в UI, где выводится эта информация, и то, что пользователь **не может** изменять комиссию.
3. **Зафиксировать поведение Telegram‑бота**:
   - Определить формат текстового вывода для курса в сообщениях бота аналогично WebApp.
   - Убедиться, что никакие новые команды/поля ввода не добавляются.
4. **Обновить RPG‑описание взаимодействий**:
   - В `docs/rpg.yaml` отразить, что:
     - API получает `meta.rates_used` и передаёт его клиентам,
     - WebApp и бот используют эти данные для отображения комиссии через курс, не зная внутренних деталей.

## Фактический дизайн (результат спринта)

### 1. API и семантика `breakdown.total_rub`

**Файл:** `docs/API_RESULT_FLOW.md`  
**Разделы:** «Структура ответа API (JSON)», примечание под примером ответа.

- Структура JSON‑ответа `/api/calculate` **подтверждена как стабильная**: поля
  `breakdown`, `meta`, `request` остаются прежними, без новых полей для
  банковской комиссии.
- В описании рядом с примером JSON явным текстом зафиксировано, что:
  - компоненты `purchase_price_rub`, `freight_rub`, `country_expenses_rub`,
    `company_commission_rub` и другие валютозависимые поля считаются по
    эффективному курсу `effective_rate = base_rate × (1 + bank_commission_percent/100)`;
  - `breakdown.total_rub` — сумма этих компонент и, следовательно, уже
    **включает эффект банковской комиссии**;
  - **никаких полей** вида `bank_commission_percent`, `bank_commission_rub` в
    JSON нет и не планируется добавлять.

**Файл:** `docs/SPECIFICATION.md`  
**Раздел:** 4.5 «Банковская комиссия (надбавка к валютному курсу)»

- Добавлено подпояснение 4.5.1.1:
  - описывает, как именно банковская комиссия влияет на `CostBreakdown` и
    `total_rub`;  
  - подчёркивает, что `total_rub` — сумма рублёвых компонент, рассчитанных по
    `effective_rate`, и именно поэтому включает комиссию, хотя отдельного
    поля в JSON нет.

### 2. `CalculationMeta` и контракт `meta.rates_used`

**Файл:** `docs/SPECIFICATION.md`  
**Раздел:** 4.5.4 «Связь с метаданными `CalculationMeta` и `meta.rates_used`»

- Описан **внутренний логический состав** `rates_used` в модели:
  - `base_rate`, `bank_commission_percent`, `effective_rate`, `display` для
    каждой валютной пары (`USD_RUB`, `JPY_RUB` и др.).
- Добавлен подпункт 4.5.4.1 «Минимальный контракт для клиентов»:
  - для клиентов (WebApp и бот) официально гарантируется наличие как минимум
    **строкового представления курса** вида `BASE_RATE [+ PERCENT%]`;  
  - формально требуется, чтобы JSON‑ответ `/api/calculate` в `meta.rates_used`
    (или совместимом поле) содержал запись для основной валюты расчёта с
    подготовленной строкой для UI;
  - суффикс `+ PERCENT%` присутствует только при ненулевой банковской комиссии.
- Подпункт 4.5.4.2 «Обратная совместимость»:
  - старые клиенты могут игнорировать `meta.rates_used` и продолжать
    использовать только `breakdown.*`;  
  - при `bank_commission_percent = 0` строка курса не содержит `+ X%`.

### 3. Поведение WebApp

**Файлы:**
- `docs/API_RESULT_FLOW.md` — новый раздел «Как WebApp отображает курс и банковскую комиссию»;
- код: `app/webapp/index.html`, `app/webapp/js/utils/formatters.js` — поведение без изменений, только привязка к документации.

**Зафиксировано:**

- WebApp получает курс из `meta.rates_used` как **готовую строку** и вставляет
  её в UI без перерасчётов и доступа к внутренним полям `base_rate` или
  `effective_rate`.
- Правила формирования строки на стороне сервера (для UI):
  - при комиссии > 0: `USD/RUB = BASE_RATE + PERCENT%`;
  - при комиссии = 0: `USD/RUB = BASE_RATE`.
- Место отображения:
  - отдельная строка в блоке метаданных `metaInfo` под результатами, формата:
    `Курс: USD/RUB = 78.95 + 1%`.
- В документации явно зафиксировано, что:
  - в форме **нет** полей и переключателей для изменения банковской комиссии;
  - комиссия задаётся только через конфиг `config/commissions.yml::bank_commission`;
  - в `breakdown` **нет** строки «Банковская комиссия XXX ₽»; её эффект виден
    через рублёвые суммы и надбавку к курсу в виде `+ X%`.

### 4. Поведение Telegram‑бота

**Файлы:**
- `docs/API_RESULT_FLOW.md` — раздел «Как Telegram‑бот отображает курс и банковскую комиссию»;  
- код: `app/bot/handlers/start.py` (функция `_format_result`) — фактическая реализация форматирования.

**Зафиксировано:**

- Бот использует ту же информацию о курсах, что и WebApp — строковое
  представление из `meta.rates_used`.
- Рекомендуемый формат строки курса в сообщении бота:
  - при комиссии > 0:

    ```text
    Курс: USD/RUB = 78.95 + 1%
    ```

  - при комиссии = 0:

    ```text
    Курс: USD/RUB = 78.95
    ```

- Эта строка идёт в верхней части ответа (после страны/года/двигателя,
  до блока «Детализация»).
- Ограничения интерфейса:
  - бот **не** вводит новых команд, связанных с комиссией;  
  - нет дополнительных полей ввода/меню для задания процента комиссии;
  - настройки комиссии полностью задаются конфигурацией на сервере.

### 5. Обновлённое RPG‑описание взаимодействий

**Файл:** `docs/rpg.yaml`

**Добавлено/уточнено:**

- В `metadata.recent_changes` — запись о завершении Sprint 3 Design с
  описанием того, что `total_rub` трактуется как сумма с учётом комиссии, а
  клиенты используют только строковый курс `BASE_RATE [+ PERCENT%]`.
- В `nodes.modules`:
  - для `app_calculation` уточнено, что модуль формирует `CalculationMeta.rates_used`
    и применяет банковскую комиссию через `effective_rate`;
  - для `app_api` — что API сериализует `CalculationResult` и проксирует
    `meta.rates_used` без раскрытия деталей;
  - для `app_webapp` и `app_bot` — что они используют строку курса из
    `meta.rates_used` и не управляют комиссией.
- В `edges.inter_module_flows`:
  - поток `app_calculation → app_api`: `engine.calculate()` возвращает
    `CalculationResult` с `rates_used` (включая логические поля `base_rate`,
    `bank_commission_percent`, `effective_rate`, `display`);  
  - поток `app_api → app_webapp` и `app_api → app_bot`: клиенты получают
    `CalculationResult` и используют только строковое представление курса
    (например, `"USD/RUB = 78.95 + 1%"`), без доступа к абсолютной сумме
    банковской комиссии.
- В `component_relationships`:
  - связь `config_data → app_calculation`: описано, как
    `config/commissions.yml::bank_commission` и `rates.yml` определяют
    `effective_rate`, влияющий на `breakdown` и `meta.rates_used.display`;
  - связи `app_calculation → app_webapp` и `app_calculation → app_bot` через API
    подчёркивают, что на клиентах комиссия видна только как надбавка к курсу,
    без выделенных сумм.

## Чек‑лист задач спринта (для проверки завершения)

1. **API и SPEC**
   - [x] В `docs/API_RESULT_FLOW.md` описано, что `breakdown.total_rub`
         включает банковскую комиссию, при этом структура JSON не меняется.
   - [x] В `docs/SPECIFICATION.md` (раздел 4.5) уточнено влияние банковской
         комиссии на `CostBreakdown` и `total_rub`.
   - [x] Формально зафиксирован минимальный контракт `meta.rates_used` для
         клиентов: строка вида `BASE_RATE [+ PERCENT%]`.

2. **WebApp**
   - [x] Документация описывает место в UI, где выводится строка с курсом,
         и формат строки с `+ X%` при ненулевой комиссии.
   - [x] Явно указано, что интерфейс ввода не меняется: нет полей/переключателей
         для управлен��я банковской комиссией.

3. **Telegram‑бот**
   - [x] Описан формат строк курса в ответе бота (аналог WebApp).
   - [x] Зафиксировано условие показа `+ X%` и отсутствие новых команд/полей
         ввода для работы с комиссией.

4. **RPG‑описание**
   - [x] В `docs/rpg.yaml` добавлены/обновлены связи:
     - `engine.py` → `models.CalculationMeta.rates_used` → `api.routes` → `webapp` / `bot`;
     - указано, что банковская комиссия видна клиентам только как
       надбавка `+ X%` к курсу, без раскрытия абсолютных сумм.

## Резюме

Спринт 3 завершён на уровне дизайна и документации:  
- бизнес‑логика движка и формат JSON‑ответа `/api/calculate` **не менялись**;  
- изменена и уточнена только интерпретация существующих полей и правила их
  использования клиентами (WebApp и бот) в части отображения банковской комиссии.
