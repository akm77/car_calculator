# Спринт 4: План реализации и тестирования банковской комиссии

## Роль модели

- Модель выступает как **ведущий разработчик и тест‑инженер**, который планирует реализацию банковской комиссии во всех слоях (конфиг, движок, API, клиенты) и покрытие тестами.
- Необходимо продолжать работать по методике **RPG**, последовательно проходя по узлам системы и проверяя, что роли, процессы, границы и артефакты описаны и согласованы.

## Методика RPG

- **Роли:**
  - Конфиги: `config/commissions.yml`.
  - Движок: `app/calculation/engine.py`.
  - Модели/DTO: `app/calculation/models.py`.
  - API: `app/api/routes.py`.
  - Клиенты: `app/webapp/**`, `app/bot/**`.
  - Тесты: `tests/unit/**`, `tests/functional/**`, `tests/manual/**`.
- **Процессы:**
  - Загрузка конфига → применение процента в конвертациях → формирование `CalculationResult` → отображение на клиентах.
  - Прогон автоматических тестов и ручных сценариев, проверяющих оба режима (с комиссией и без).
- **Границы:**
  - Спринт описывает **пошаговый план реализации и тестирования**, но не требует немедленной правки всего кода.
  - В рамках одной итерации допустимо реализовывать и сразу покрывать тестами отдельные узлы.
- **Артефакты:**
  - Чек‑лист реализации по файлам и слоям.
  - Чек‑лист автотестов и ручных сценариев.

## Источники правды

- `docs/SPECIFICATION.md` — итоговое описание бизнес‑логики комиссии, конфигов, API и структуры результата.
- `docs/rpg.yaml` и `docs/rpg_intro.txt` — согласованная RPG‑карта, включающая все изменения предыдущих спринтов.
- `config/commissions.yml` — рабочий конфиг, где будет включаться банковская комиссия.
- `app/calculation/engine.py`, `app/calculation/models.py`, `app/api/routes.py` — основной код расчётов и API.
- `app/webapp/**`, `app/bot/**` — фронтовые клиенты.
- `tests/**` — текущий набор автотестов, на который нужно опираться.

## Цели спринта

1. **Сформировать подробный план реализации по слоям**:
   - Для конфига: где и как добавить чтение `bank_commission` и валидацию диапазона (с предупреждением при >10%).
   - Для движка: какие функции изменить/дополнить, чтобы использовать эффективный курс при конвертации.
   - Для моделей и API: как обновить `CalculationMeta` и сериализацию без изменения формата JSON.
   - Для клиентов: какие места в WebApp и боте нужно изменить для работы с новым форматом `rates_used`.
2. **Сформировать план автотестов**:
   - Unit‑тесты движка: сценарии без комиссии и с комиссией (включая крайние значения).
   - Функциональные тесты API: проверка изменения `total_rub` и `rates_used`.
   - При необходимости — тесты конфигурации (поведение при неверных значениях, >10%).
3. **Сформировать план ручного тестирования**:
   - Чек‑лист для WebApp: сценарии с 0% и >0% комиссии, визуальная проверка `total_rub` и отображения курса.
   - Чек‑лист для Telegram‑бота: аналогичные сценарии.

## Критерии достижения целей

1. Существует **документированный пофайловый план реализации**:
   - Для каждого ключевого файла (`commissions.yml`, `engine.py`, `models.py`, `routes.py`, ключевые JS/бот‑модули) описано:
     - какие изменения внести,
     - в каком порядке,
     - какие инварианты сохранить.
2. Существует **список автотестов** (unit и functional) c описанием сценариев:
   - Отдельно перечислены тесты для режима без комиссии (должен совпадать с текущим поведением).
   - Отдельно — для ненулевой комиссии (проверка роста `total_rub` и изменения `rates_used`).
3. Существует **чек‑лист ручного тестирования**:
   - Для WebApp: шаги по вводу данных, ожидания по `total_rub` и тексту курса.
   - Для бота: текст ответов и ожидаемые изменения при включённой/выключенной комиссии.
4. План реализации и тестирования согласован с RPG‑картой:
   - В `docs/rpg.yaml` нет противоречий между узлами и описанным планом.
   - Роли и процессы, затронутые банковской комиссией, явно отмечены.

## Статус по подзадаче 4.3 (meta.rates_used и API) на 2025-12-15

В рамках реализации SPRINT 4.3 выполнено:

- В `app/calculation/models.py` зафиксирована модель `RateUsage` и поле
  `CalculationMeta.detailed_rates_used: dict[str, RateUsage]` для расширенного
  описания использованных курсов (base_rate, effective_rate, bank_commission_percent, display);
- В `app/calculation/engine.calculate` для всех реально использованных валют
  (валюта покупки, EUR для пошлин, JPY/прочие для расходов/фрахта, USD для комиссии
  компании) заполняются:
  - `meta.rates_used["XXX_RUB"]` — числовые курсы для внутренней диагностики
    и обратной совместимости;
  - `meta.detailed_rates_used["XXX"].display` — человекочитаемая строка курса
    вида `"USD/RUB = BASE"` или `"USD/RUB = BASE + PERCENT%"` в зависимости
    от `bank_commission_percent`.
- Клиентский контракт `/api/calculate` **не менялся в ширину**: объект `meta`
  по-прежнему содержит `rates_used` как карту курсов, а дополнительные поля
  `detailed_rates_used` используются как расширенная внутренняя структура и
  источник строки для UI (WebApp/бота).

Это соответствует целям спринта: сделать комиссию «прозрачной» через meta.rates_used
и связанные метаданные, **не ломая существующий JSON-формат** и не требуя
изменений от клиентов, кроме использования готовой строки курса.
