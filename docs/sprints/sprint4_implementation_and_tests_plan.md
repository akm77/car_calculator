# Спринт 4: План реализации и тестирования банковской комиссии

## Роль модели

- Модель выступает как **ведущий разработчик и тест‑инженер**, который планирует реализацию банковской комиссии во всех слоях (конфиг, движок, API, клиенты) и покрытие тестами.
- Необходимо продолжать работать по методике **RPG**, последовательно проходя по узлам системы и проверяя, что роли, процессы, границы и артефакты описаны и согласованы.

## Методика RPG

- **Роли:**
  - Конфиги: `config/commissions.yml`.
  - Движок: `app/calculation/engine.py`.
  - Модели/DTO: `app/calculation/models.py`.
  - API: `app/api/routes.py`.
  - Клиенты: `app/webapp/**`, `app/bot/**`.
  - Тесты: `tests/unit/**`, `tests/functional/**`, `tests/manual/**`.
- **Процессы:**
  - Загрузка конфига → применение процента в конвертациях → формирование `CalculationResult` → отображение на клиентах.
  - Прогон автоматических тестов и ручных сценариев, проверяющих оба режима (с комиссией и без).
- **Границы:**
  - Спринт описывает **пошаговый план реализации и тестирования**, но не требует немедленной правки всего кода.
  - В рамках одной итерации допустимо реализовывать и сразу покрывать тестами отдельные узлы.
- **Артефакты:**
  - Чек‑лист реализации по файлам и слоям.
  - Чек‑лист автотестов и ручных сценариев.

## Источники правды

- `docs/SPECIFICATION.md` — итоговое описание бизнес‑логики комиссии, конфигов, API и структуры результата.
- `docs/rpg.yaml` и `docs/rpg_intro.txt` — согласованная RPG‑карта, включающая все изменения предыдущих спринтов.
- `config/commissions.yml` — рабочий конфиг, где будет включаться банковская комиссия.
- `app/calculation/engine.py`, `app/calculation/models.py`, `app/api/routes.py` — основной код расчётов и API.
- `app/webapp/**`, `app/bot/**` — фронтовые клиенты.
- `tests/**` — текущий набор автотестов, на который нужно опираться.

## Цели спринта

1. **Сформировать подробный план реализации по слоям**:
   - Для конфига: где и как добавить чтение `bank_commission` и валидацию диапазона (с предупреждением при >10%).
   - Для движка: какие функции изменить/дополнить, чтобы использовать эффективный курс при конвертации.
   - Для моделей и API: как обновить `CalculationMeta` и сериализацию без изменения формата JSON.
   - Для клиентов: какие места в WebApp и боте нужно изменить для работы с новым форматом `rates_used`.
2. **Сформировать план автотестов**:
   - Unit‑тесты движка: сценарии без комиссии и с комиссией (включая крайние значения).
   - Функциональные тесты API: проверка изменения `total_rub` и `rates_used`.
   - При необходимости — тесты конфигурации (поведение при неверных значениях, >10%).
3. **Сформировать план ручного тестирования**:
   - Чек‑лист для WebApp: сценарии с 0% и >0% комиссии, визуальная проверка `total_rub` и отображения курса.
   - Чек‑лист для Telegram‑бота: аналогичные сценарии.

## Критерии достижения целей

1. Существует **документированный пофайловый план реализации**:
   - Для каждого ключевого файла (`commissions.yml`, `engine.py`, `models.py`, `routes.py`, ключевые JS/бот‑модули) описано:
     - какие изменения внести,
     - в каком порядке,
     - какие инварианты сохранить.
2. Существует **список автотестов** (unit и functional) c описанием сценариев:
   - Отдельно перечислены тесты для режима без комиссии (должен совпадать с текущим поведением).
   - Отдельно — для ненулевой комиссии (проверка роста `total_rub` и изменения `rates_used`).
3. Существует **чек‑лист ручного тестирования**:
   - Для WebApp: шаги по вводу данных, ожидания по `total_rub` и тексту курса.
   - Для бота: текст ответов и ожидаемые изменения при включённой/выключенной комиссии.
4. План реализации и тестирования согласован с RPG‑картой:
   - В `docs/rpg.yaml` нет противоречий между узлами и описанным планом.
   - Роли и процессы, затронутые банковской комиссией, явно отмечены.

## Статус по подзадаче 4.3 (meta.rates_used и API) на 2025-12-15

В рамках реализации SPRINT 4.3 выполнено:

- В `app/calculation/models.py` зафиксирована модель `RateUsage` и поле
  `CalculationMeta.detailed_rates_used: dict[str, RateUsage]` для расширенного
  описания использованных курсов (base_rate, effective_rate, bank_commission_percent, display);
- В `app/calculation/engine.calculate` для всех реально использованных валют
  (валюта покупки, EUR для пошлин, JPY/прочие для расходов/фрахта, USD для комиссии
  компании) заполняются:
  - `meta.rates_used["XXX_RUB"]` — числовые курсы для внутренней диагностики
    и обратной совместимости;
  - `meta.detailed_rates_used["XXX"].display` — человекочитаемая строка курса
    вида `"USD/RUB = BASE"` или `"USD/RUB = BASE + PERCENT%"` в зависимости
    от `bank_commission_percent`.
- Клиентский контракт `/api/calculate` **не менялся в ширину**: объект `meta`
  по-прежнему содержит `rates_used` как карту курсов, а дополнительные поля
  `detailed_rates_used` используются как расширенная внутренняя структура и
  источник строки для UI (WebApp/бота).

Это соответствует целям спринта: сделать комиссию «прозрачной» через meta.rates_used
и связанные метаданные, **не ломая существующий JSON-формат** и не требуя
изменений от клиентов, кроме использования готовой строки курса.

## Sprint 4.5: Unit‑тесты движка для bank_commission и effective_rate

### Новые unit‑тесты

Файл: `tests/unit/test_engine_bank_commission.py`.

Покрыто:
- `_get_bank_commission_percent` — разбор конфигурации комиссии банка:
  - отсутствие секции `bank_commission` → 0.0;
  - `enabled: false` игнорирует заданный `percent` → 0.0;
  - `enabled: true, percent: X` → X;
  - `enabled: true, meta.default_percent: X` при отсутствии `percent` → X;
  - невалидные значения `percent`/`default_percent` → безопасный fallback 0.0.
- `_effective_currency_rate` — чистая математика effective_rate:
  - 0% → `effective_rate == base_rate`;
  - положительный процент (5%, 10%, 2.5%) → `base_rate * (1 + pct/100)` с округлением до 4 знаков;
  - ра��ные валюты (USD/EUR), в том числе с нецелыми базовыми курсами.
- `_convert` и `_convert_from_rub`:
  - режим без параметра комиссии (None) использует базовый курс;
  - `bank_commission_percent=0` даёт тот же результат, что и базовый курс;
  - положительная комиссия увеличивает результат конверсии (VALUTA→RUB);
  - обратная конверсия RUB→VALUTA всегда использует базовый курс и корректно обрабатывает нулевой курс.
- `_commission` (комиссия компании):
  - базовая комиссия 1000 USD без банковской комиссии (~90k RUB при USD_RUB=90);
  - та же комиссия с банковской надбавкой (5%, 10%) → сумма в RUB возрастает;
  - исключение для ОАЭ (`uae`) — комиссия всегда 0, независимо от bank_commission;
  - переопределение комиссии по стране (например, `georgia` 750 USD) учитывает bank_commission;
  - legacy‑формат списка в RUB игнорирует bank_commission (фиксированная сумма в рублях).
- `calculate()` (сквозные сценарии с детерминированными курсами):
  - кейс без банковской комиссии (секция отключена) — `effective_rate == base_rate`, `bank_commission_percent == 0`;
  - кейс с малой комиссией (5%) — effective_rate выше base_rate, в метаданных `bank_commission_percent == 5`;
  - сравнение `total_rub` для 0%, 10% и 12.5% — монотонный рост total_rub с увеличением процента;
  - кейс ОАЭ: при 0% и 10% банковской комиссии `company_commission_rub == 0`, но итоговый `total_rub` растёт за счёт курсов.

### Фиксация инвариантов

Инварианты, защищённые новыми тестами:
- Включение/выключение `bank_commission` влияет только через изменение валютных курсов и конверсий, но не ломает конфигурацию.
- При 0% (или отключённой секции) поведение идентично режиму без банковской комиссии — базовые курсы остаются источником истины.
- Любое увеличение `bank_commission_percent` приводит к возрастанию:
  - effective_rate для всех задействованных валют;
  - компонент в RUB, зависящих от валютных расчётов (цена покупки, фрахт, расходы по стране, комиссия компании, кроме стран с нулевой комиссией).
- Особый случай ОАЭ (комиссия 0 USD) остаётся стабильным при любых настройках банковской комиссии.

### Стратегия стабилизации курсов и конфигов в тестах

- Для unit‑тестов движка используются детерминированные курсы через monkeypatch `get_effective_rates` в модуле `app.calculation.engine`:
  - фиксированные значения: `USD_RUB=90`, `EUR_RUB=100`, `JPY_RUB=0.5`;
  - поле `live_source` устанавливается в `None`.
- Конфигурация `commissions` подменяется через monkeypatch `get_configs`, при этом:
  - создаётся новый экземпляр `ConfigRegistry` с обновлённой секцией `bank_commission`;
  - поля `hash` и `loaded_at` сохраняются из оригинальной конфигурации для корректной валидации pydantic.
- Для helper‑тестов используются минимальные словари без загрузки YAML/CBR, чтобы проверки оставались локальными и быстрыми.

## Sprint 4.6: Функциональные тесты API для bank_commission и регрессия комиссий/пошлин

### Цели

- Проверить, что при **отключённой** банковской комиссии (`bank_commission.enabled=false` или отсутствие секции) поведение `/api/calculate` полностью соответствует «старому» режиму без банка.
- Проверить, что при **включённой** банковской комиссии стоимость в RUB (все валютные компоненты и `total_rub`) **возрастает**, а структура ответа и логика пошлин/утильсбора не меняются.
- Зафиксировать базовый контракт по метаданным курсов (`meta.rates_used` и `meta.detailed_rates_used`) на уровне функциональных тестов API.

### Механизм управления bank_commission в тестах

Используются два тестовых профиля комиссий в каталоге `tests/test_data/config`:

- `commissions_company_only.yml` — только комиссия компании (1000 USD, `uae` = 0), **без** секции `bank_commission`.
  - Этот профиль применяется глобально для функциональных тестов через фикстуру `_ensure_test_commissions_defaults` в `tests/conftest.py` и служит регрессионным baseline без банка.
- `commissions_with_bank.yml` — тот же формат, но с включённой секцией `bank_commission` (enabled + percent + meta).
  - В функциональных тестах bank_commission он подмешивается поверх baseline через вспомогательную фикстуру `_patch_commissions`, которая временно меняет `cfg.commissions` и затем восстанавливает исходное значение.

Таким образом, тесты могут локально переключать профиль комиссий (без банка / с банком) без изменения боевого `config/commissions.yml` и без влияния на остальные сценарии.

### Новые функциональные тесты `/api/calculate`

Файл: `tests/functional/test_api_bank_commission.py`.

#### 1. `test_calculate_without_bank_commission_regression`

- **Профиль комиссий:** `commissions_company_only.yml` (через `_patch_commissions`).
- **Payload:**
  - `country="japan"`, возраст стабильно в диапазоне 3–5 лет (год = текущий − 4, но не раньше 1990);
  - `engine_cc=1500`, `engine_power_hp=150`;
  - `purchase_price=10_000`, `currency="USD"`, `freight_type="standard"`.
- **Проверяет:**
  - наличие ключей `breakdown`, `meta`, `request`;
  - полный набор полей в `breakdown` (`purchase_price_rub`, `duties_rub`, `utilization_fee_rub`, `customs_services_rub`, `era_glonass_rub`, `freight_rub`, `country_expenses_rub`, `company_commission_rub`, `total_rub`), все ≥ 0;
  - базовые неравенства: `purchase_price_rub > 0`, `duties_rub > 0`, `total_rub > purchase_price_rub`;
  - диапазон `company_commission_rub` (условно 10–200 тыс. RUB) как грубую регрессию 1000 USD по статичному курсу;
  - наличие `USD_RUB` в `meta.rates_used` и, если `meta.detailed_rates_used` присутствует, равенство `effective_rate ≈ base_rate` и `bank_commission_percent ≈ 0`.

Это — **регрессионный тест** для режима без банковской комиссии.

#### 2. `test_calculate_with_bank_commission_increases_costs`

- **Профили комиссий:**
  - A: `commissions_company_only.yml` (без банкомиссии);
  - B: `commissions_with_bank.yml` (с ненулевым `bank_commission.percent`, сейчас 2%).
- **Payload:** тот же, что в первом тесте.
- **Проверяет:**
  - идентичность набора ключей в `breakdown` между профилями A и B;
  - рост валютно-зависимых полей при включении bank_commission:
    - `purchase_price_rub`, `country_expenses_rub`, `freight_rub`, `company_commission_rub`, `total_rub` из профиля B строго больше, чем в A;
  - инварианты по логике пошлин и возрасту: если `meta.age_category` и `meta.duty_mode` присутствуют, они совпадают между A и B (bank_commission не должна менять выбор банда по пошлинам);
  - для `USD_RUB`:
    - `base_rate` из профилей A и B совпадает с точностью до небольшого допуска;
    - `effective_rate` в профиле B строго больше, чем `effective_rate`/`base_rate` в A;
    - `bank_commission_percent` в A ≈ 0, а в B — неотрицательный (по данным конфига);
  - в списке `meta.warnings` не появляется специального кода `BANK_COMMISSION_HIGH` (текущая реализация ещё не добавляет такой warning для допустимых процентов).

Этот тест фиксирует **монотонный рост валютных компонент** и `total_rub` при включении банковской комиссии и показывает, что основная логика расчёта (пошлины, возраст, утильсбор) при этом не меняется.

#### 3. `test_calculate_with_high_bank_commission_triggers_warning`

- **Профили комиссий:**
  - A: `commissions_company_only.yml`;
  - B: `commissions_with_bank.yml`, модифицированный в фикстуре `commissions_profile_with_bank_high` так, чтобы `percent > warn_above` (например, warn_above=10.0, percent=15.0).
- **Payload:** тот же.
- **Проверяет:**
  - рост `total_rub` и `purchase_price_rub` в профиле B по сравнению с A;
  - рост `effective_rate` для `USD_RUB` при сохранении одинакового `base_rate`;
  - если `bank_commission_percent` присутствует в метаданных, он строго больше 5.0 (помогаем поймать сильно завышенные значения);
  - `meta.warnings` остаётся списком (структурно корректен), но пока **не навязывает** наличие конкретного warning-кода по банку, чтобы не фиксировать недореализованную бизнес-логику.

При появлении в движке явного warning-кода (например, `BANK_COMMISSION_HIGH`) данный тест можно будет ужесточить: проверить конкретный `code` в `meta.warnings` и диапазон рекомендуемых значений на основе `meta.*` из конфига.

### Дополнительный регрессионный тест для `/api/meta`

В `tests/functional/test_api.py` добавлен тест:

- `test_meta_notes_include_commission_info`
  - GET `/api/meta`;
  - проверяет, что в ответе есть поле `notes`, и хотя бы одна запись содержит упоминание комиссий (по подстроке `"комисс"` или `"commission"`).

Этот тест служит лёгким регрессионным якорем, что текстовая документация в API продолжает объяснять политику комиссий для пользователя.

### Связь с RPG и SPEC

- Описание `bank_commission` в `docs/SPECIFICATION.md` синхронизировано с фактическим поведением движка и тестами:
  - комиссия влияет только через надбавку к валютным курсам;
  - не добавляет новых полей breakdown в JSON;
  - её эффект виден в `breakdown.total_rub` и в полях `meta.rates_used`/`meta.detailed_rates_used`.
- В `docs/rpg.yaml` узлы `app_calculation`, `config_data` и `tests` уже отражают наличие:
  - секции `bank_commission` в `config/commissions.yml`;
  - вспомогательных тестовых конфигов `commissions_company_only.yml` и `commissions_with_bank.yml`;
  - функциональных тестов API (`tests/functional/test_api.py`, `tests/functional/test_engine.py`) и теперь — отдельного файла `tests/functional/test_api_bank_commission.py`.

### Инварианты регрессии

Новые функциональные тесты не меняют и дополнительно защищают следующие инварианты:

- Структура ответа `/api/calculate` (`breakdown`, `meta`, `request`) и состав полей `breakdown` не меняются.
- Для режима без банковской комиссии (`commissions_company_only.yml`) поведение совпадает с существующими тестами `tests/functional/test_api.py`, `tests/functional/test_engine.py` и `test_sprint4_duties.py`.
- Специальный кейс ОАЭ (`uae`): `company_commission_rub` остаётся 0 во всех профилях комиссий.
- Включение банковской комиссии не меняет выбор duty‑бандов и возрастных категорий — только пересчитывает валютные компоненты через `effective_rate`.

---

## Sprint 4.8: Документация, RPG и миграция по bank_commission

**Цель:** синхронизировать документацию и RPG‑граф с фактической реализацией банковской комиссии (`bank_commission`) и подготовить миграционные материалы.

### Задачи

1. **SPEC (docs/SPECIFICATION.md):**
   - Уточнить раздел 4.5 «Банковская комиссия (надбавка к валютному курсу)»:
     - явно зафиксировать, что `bank_commission` уже используется в `engine` (через `_get_bank_commission_percent`, `_effective_currency_rate`, `_convert`, `_commission`);
     - перечислить затронутые поля `breakdown` и инварианты (0% = режим без банка, монотонный рост `total_rub` при росте процента, особый случай `uae`).
   - Описать контракт `meta.rates_used`/`meta.detailed_rates_used` и ожидаемый формат `display` («USD/RUB = BASE [+ P%]»).

2. **Migration Guide (docs/MIGRATION_GUIDE.md):**
   - Добавить раздел «Миграция комиссий: thresholds → fixed USD → bank_commission»:
     - этап 0 — legacy v1 (`thresholds`, RUB);
     - этап 1 — v2 без банка (фиксированная 1000 USD + `by_country.uae=0`);
     - этап 2 — v2 + `bank_commission` (надбавка к курсу, без новых полей в API).
   - Описать шаги для Backend/QA/DevOps и ссылаться на тестовые конфиги (`commissions_company_only.yml`, `commissions_with_bank.yml`) и тесты (`tests/unit/test_engine_bank_commission.py`, `tests/functional/test_api_bank_commission.py`).

3. **RPG‑граф (docs/rpg.yaml):**
   - Обновить `metadata.recent_changes` и узлы `config_data`, `app_calculation`, `app_api`, `app_webapp`, `app_bot`, `tests` так, чтобы:
     - банк‑комиссия была отражена как завершённая часть ветки `bank_commission_runtime_support` (runtime‑поддержка + тесты);
     - путь `config/commissions.yml (bank_commission) → engine._effective_currency_rate/_convert → CalculationMeta.(rates_used, detailed_rates_used) → API → WebApp/Bot → tests` был явно описан в `edges.component_relationships`.

4. **CHANGELOG и README:**
   - Зафиксировать в `CHANGELOG.md` и `README.md`, что:
     - комиссии теперь считаются по v2‑схеме (фиксированная компания + опциональная банковская надбавка);
     - итоговые суммы в WebApp/боте уже включают банковскую надбавку, что видно из строки курса.

### Критерии готовности

- SPEC, MIGRATION_GUIDE и RPG обновлены и согласованы между собой.
- В RPG‑графе ветка `bank_commission_runtime_support` помечена как реализованная на уровне runtime и тестов.
- В CHANGELOG/README присутствует краткое описание поведения с учётом `bank_commission`.
