# Спринт 0: Обзор дорожной карты внедрения банковской комиссии

Этот документ — верхнеуровневый навигатор по дорожной карте внедрения банковской комиссии в расчёт стоимости автомобиля, основанный на методике RPG и разбитый на четыре отдельных спринта (1–4).

## Роль модели в этом спринте

- Модель выступает как **системный архитектор**, который держит в голове всю картину изменений и помогает не "потеряться в середине" (lost in the middle).
- Задача — не проектировать детали заново, а **собрать и связать** цели спринтов 1–4 в единую, понятную дорожную карту.

## Методика RPG

- **Роли:**
  - Конфиг (комиссии, курсы): `config/commissions.yml` + документация.
  - Движок/модели: `app/calculation/engine.py`, `app/calculation/models.py`.
  - API: `app/api/routes.py`.
  - Клиенты: WebApp (`app/webapp/**`), Telegram‑бот (`app/bot/**`).
  - Тесты и эксплуатация: `tests/**`, `docs/MIGRATION_GUIDE.md`, `CHANGELOG.md`, `docs/rpg.yaml`.
- **Процессы:**
  1. Конфиг банковской комиссии →
  2. Применение комиссии в движке и метаданных →
  3. Отражение в API и клиентах →
  4. Реализация, тестирование и ввод в эксплуатацию.
- **Границы:**
  - Спринт 0 **ничего не меняет в коде и конфигурации**.
  - Он только описывает, какие изменения будут сделаны в спринтах 1–4 и в каком порядке.
- **Артефакты:**
  - Этот документ (`sprint0_overview.md`).
  - Ссылки на спринты 1–4 как на подробные планы.

## Источники правды

- ТЗ и архитектура:
  - `docs/SPECIFICATION.md`
  - `docs/rpg_intro.txt`
  - `docs/rpg.yaml`
- Дорожная карта по спринтам:
  - `docs/sprints/sprint1_bank_commission_config.md`
  - `docs/sprints/sprint2_engine_and_meta_design.md`
  - `docs/sprints/sprint3_api_and_clients_design.md`
  - `docs/sprints/sprint4_implementation_and_tests_plan.md`

## Обзор спринтов

### Спринт 1: Конфиг и метаданные банковской комиссии

**Что делаем:**
- Проектируем конфигурацию банковской комиссии в `config/commissions.yml` (секция `bank_commission`).
- Описываем в SPEC и RPG, как конфиг связан с движком и итогами.

**Ключевые решения:**
- Где и как хранится процент комиссии (рекомендуемый диапазон 0–10%, но мягкий).
- Какое поведение по умолчанию (отсутствие секции/значения = 0%).
- Как этот конфиг будет использоваться в расчётах и как повлияет на `total_rub` и `meta.rates_used` (на уровне договорённости, без кода).

**Результат:**
- Есть формальное описание секции `bank_commission` и её связи с движком в SPEC и RPG.
- Код ещё не менялся, только договорённости и документация.

Подробнее: см. `sprint1_bank_commission_config.md`.

---

### Спринт 2: Дизайн применения комиссии в движке и метаданных

**Что делаем:**
- Проектируем алгоритм применения банковской комиссии внутри `engine.py`.
- Расширяем модель `CalculationMeta` (на уровне описания), чтобы отразить базовый курс и процент комиссии.

**Ключевые решения:**
- Используем эффективный курс: `effective_rate = base_rate * (1 + bank_commission_percent/100)` для всех релевантных валютных операций.
- Определяем, какие именно операции считаются «банковскими» (покупка авто, расходы по стране, фрахт, комиссия компании и т.д.).
- Фиксируем, что:
  - `total_rub` в будущем включает эффект банковской комиссии,
  - отдельные суммы комиссий в API/моделях **не выводятся**,
  - эффект виден только через `total_rub` и `meta.rates_used`.

**Результат:**
- В SPEC описан алгоритм и перечень точек применения комиссии.
- В `docs/rpg.yaml` обновлены узлы `engine.py` и `models.py` с учетом банковской логики.
- Код всё ещё не менялся, это дизайнерский спринт.

Подробнее: см. `sprint2_engine_and_meta_design.md`.

---

### Спринт 3: Дизайн изменений API и клиентов (WebApp, бот)

**Что делаем:**
- Проектируем, как новые договорённости о комиссии отражаются в API и интерфейсах.
- Описываем поведение WebApp и Telegram‑бота при отображении комиссии через курс валюты.

**Ключевые решения:**
- Структура JSON ответа `/api/calculate` остаётся прежней, но:
  - `breakdown.total_rub` теперь подразумевает включение банковской комиссии.
  - `CalculationMeta` дополняется данными, достаточными для отображения `BASE_RATE` или `BASE_RATE + X%`.
- В WebApp и боте:
  - пользователь **не управляет** комиссией,
  - видит только изменённый `total_rub` и курс в формате:
    - `USD/RUB = 78.95 + 1%` при ненулевой комиссии,
    - `USD/RUB = 78.95` при нулевой.

**Результат:**
- Документация API и UI чётко описывает, как должна выглядеть интеграция.
- В RPG обновлены связи: движок → API → WebApp/бот с учётом банковской комиссии.

Подробнее: см. `sprint3_api_and_clients_design.md`.

---

### Спринт 4: План реализации и тестирования

**Что делаем:**
- Составляем детальный пофайловый план реализации по всем слоям.
- Планируем автотесты и ручные сценарии, покрывающие режимы с комиссией и без.

**Ключевые задачи (на уровне плана):**
- Конфиг:
  - Реализация чтения `bank_commission` и валидации (warning при >10%).
- Движок:
  - Внедрение использования эффективного курса для нужных конвертаций.
- Модели и API:
  - Обновление `CalculationMeta` и сериализации без изменения структуры JSON.
- Клиенты:
  - Обновление WebApp и бота для работы с новым форматом `rates_used`.
- Тесты:
  - Unit‑тесты движка (0% и >0%).
  - Функциональные тесты API (`total_rub`, `rates_used`).
  - Ручные сценарии для WebApp и бота.

**Результат:**
- Есть согласованный чек‑лист изменений по файлам.
- Есть список автотестов и чек‑лист ручного тестирования.
- Можно приступать к фактической реализации, двигаясь по плану.

Подробнее: см. `sprint4_implementation_and_tests_plan.md`.

---

## Общие цели дорожной карты

1. **Ввести банковскую комиссию как конфигурируемый параметр**:
   - Процент в YAML, управляемый админом/разработчиком (без UI‑админки на первом этапе).
   - Рекомендуемый диапазон 0–10% с возможностью выставить больше (с предупреждением).
2. **Применять комиссию корректно на уровне движка**:
   - Как надбавку к курсу для всех релевантных валютных операций.
   - Так, чтобы `total_rub` включал эффект комиссии.
3. **Сделать эффект комиссии прозрачным для пользователя**:
   - Через формат отображения курса (`BASE_RATE` / `BASE_RATE + X%`).
   - Без явного вывода суммы комиссий по компонентам.
4. **Сохранить обратную совместимость и управляемость**:
   - При отсутствии `bank_commission` поведение остаётся как сейчас.
   - Код и документация развиваются синхронно по методике RPG.

Этот обзорный спринт 0 помогает быстро понять, "где мы" и "куда идём", а детали лежат в спринтах 1–4.
