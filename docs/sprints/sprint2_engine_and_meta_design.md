# Спринт 2: Дизайн применения банковской комиссии в движке и метаданных

## Роль модели

- Модель выступает как **системный архитектор расчётного движка**, который проектирует, но пока не реализует кодовую логику применения банковской комиссии.
- Требуется строго следовать методике **RPG**: чётко описать роли узлов (`engine.py`, `models.py`), процессы (конвертация валюты → RUB с учётом комиссии), границы (что трогаем/не трогаем) и артефакты (структуры в `CalculationMeta`, формат `rates_used`).

## Методика RPG

- **Роли:**
  - Расчётный движок: `app/calculation/engine.py` — место, где будет применяться банковская комиссия.
  - Модели данных/DTO: `app/calculation/models.py` — источник структуры `CalculationMeta` и `CostBreakdown`.
  - Конфиг: `config/commissions.yml` — поставщик процента банковской комиссии.
- **Процессы:**
  - `VALUTA -> RUB` с учётом базового курса CBR и процента `bank_commission`.
  - Заполнение `CalculationMeta` с информацией о базовом курсе и надбавке процента.
- **Границы:**
  - В этом спринте **не пишется код в .py файлах**, только проектные решения и документация.
  - Не меняется структура API‑ответа за пределами договорённости о `total_rub` и `meta`.
- **Артефакты:**
  - Описание алгоритма применения банковской комиссии в `docs/SPECIFICATION.md`.
  - Обновлённое RPG‑описание узлов `engine.py` и `models.py` в `docs/rpg.yaml`.

## Источники правды

- `docs/SPECIFICATION.md` — разделы о расчёте стоимости, структуре `CalculationMeta`, `CostBreakdown` и `rates_used`.
- `docs/rpg_intro.txt` — методика RPG, определения ролей и процессов.
- `docs/rpg.yaml` — текущее описание `engine.py`, `models.py`, `config/commissions.yml`.
- `app/calculation/engine.py` — фактический алгоритм расчёта (используется для анализа точек конвертации и структуры итогов).
- `app/calculation/models.py` — актуальная доменная модель (`CalculationRequest`, `CalculationMeta`, `CalculationResult`, `CostBreakdown`).

## Цели спринта

1. **Спроектировать алгоритм применения банковской комиссии в движке**:
   - Определить, что конвертация `amount, currency -> RUB` для реальных платежей использует эффективный курс:
     - `effective_rate = base_rate * (1 + bank_commission_percent/100)`,
     - где `base_rate` — курс от CBR, `bank_commission_percent` — из `config/commissions.yml`.
   - Описать, какие операции считаются «банковскими» (покупка авто, комиссия компании, фрахт, country expenses и т.д.).
2. **Зафиксировать, как банковская комиссия влияет на итог `total_rub`**:
   - `total_rub` в будущей реализации должен включать эффект банковской комиссии за счёт использования эффективных курсов.
   - Не добавлять отдельные поля `bank_commission_*` в breakdown; эффект виден только в `total_rub` и в `rates_used`.
3. **Спроектировать расширение `CalculationMeta` для отражения комиссии**:
   - Добавить в модель (на уровне документации) поле(я) для процента банковской комиссии и связи с базовым курсом:
     - пример: `bank_commission_percent`,
     - формат `rates_used`: `USD/RUB = 78.95 + 1%` при ненулевой комиссии, `USD/RUB = 78.95` при нулевой.
4. **Обновить RPG‑описание узлов движка и моделей**:
   - В `docs/rpg.yaml` зафиксировать:
     - какие функции/части `engine.py` относятся к банковским операциям,
     - как они используют конфиг `bank_commission`,
     - как наполняется `CalculationMeta` новыми данными.

## Критерии достижения целей

1. В `docs/SPECIFICATION.md` есть формальное описание алгоритма применения банковской комиссии:
   - Чётко описан расчёт эффективного курса и правило использования его для всех релевантных конвертаций `VALUTA -> RUB`.
   - Определён перечень операций (стоимость авто, расходы по стране, фрахт, комиссия компании, пошлина — при наличии валютной операции), на которые распространяется комиссия.
2. В SPEC задокументировано поведение итогов:
   - `total_rub` включает банковскую комиссию.
   - Отдельные суммы банковской комиссии **не выводятся** в API, в breakdown и UI.
3. В SPEC и/или отдельном разделе описан формат `CalculationMeta`:
   - Добавлено поле для процента банковской комиссии.
   - Объяснён формат строки для отображения курса: `BASE_RATE + PERCENT%` при ненулевой комиссии и без `+ PERCENT%` при нуле.
4. В `docs/rpg.yaml` обновлены узлы:
   - Для `engine.py` — перечень функций/блоков, использующих банковскую комиссию.
   - Для `models.py` — поля, отражающие банковскую комиссию в `CalculationMeta`.
5. По итогам спринта команда понимает **где именно в коде** будет добавляться логика комиссии, не открывая сам код на изменение.

