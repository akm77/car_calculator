# Спринт 2: Дизайн применения банковской комиссии в движке и метаданных

## Роль модели

- Модель выступает как **системный архитектор расчётного движка**, который проектирует, но пока не реализует кодовую логику применения банковской комиссии.
- Требуется строго следовать методике **RPG**: чётко описать роли узлов (`engine.py`, `models.py`), процессы (конвертация валюты → RUB с учётом комиссии), границы (что трогаем/не трогаем) и артефакты (структуры в `CalculationMeta`, формат `rates_used`).

## Методика RPG

- **Роли:**
  - Расчётный движок: `app/calculation/engine.py` — место, где будет применяться банковская комиссия.
  - Модели данных/DTO: `app/calculation/models.py` — источник структуры `CalculationMeta` и `CostBreakdown`.
  - Конфиг: `config/commissions.yml` — поставщик процента банковской комиссии.
- **Процессы:**
  - `VALUTA -> RUB` с учётом базового курса CBR и процента `bank_commission`.
  - Заполнение `CalculationMeta` с информацией о базовом курсе и надбавке процента.
- **Границы:**
  - **Изначальный план спринта 2**: не вносить изменений в `.py`‑файлы, ограничиться проектными решениями и документацией.
  - **Фактически к 2025‑12‑15**: дизайн был реализован в коде (см. раздел «Статус реализации» ниже); структура API‑ответа при этом не нарушена — изменения коснулись только внутренних расчётов и метаданных (`meta`).
- **Артефакты:**
  - Описание алгоритма применения банковской комиссии в `docs/SPECIFICATION.md`.
  - Обновлённое RPG‑описание узлов `engine.py` и `models.py` в `docs/rpg.yaml`.

## Источники правды

- `docs/SPECIFICATION.md` — разделы о расчёте стоимости, структуре `CalculationMeta`, `CostBreakdown` и `rates_used`.
- `docs/rpg_intro.txt` — методика RPG, определения ролей и процессов.
- `docs/rpg.yaml` — текущее описание `engine.py`, `models.py`, `config/commissions.yml`.
- `app/calculation/engine.py` — фактический алгоритм расчёта (используется для анализа точек конвертации и структуры итогов).
- `app/calculation/models.py` — актуальная доменная модель (`CalculationRequest`, `CalculationMeta`, `CalculationResult`, `CostBreakdown`).

## Цели спринта

1. **Спроектировать алгоритм применения банковской комиссии в движке**:
   - Определить, что конвертация `amount, currency -> RUB` для реальных платежей использует эффективный курс:
     - `effective_rate = base_rate * (1 + bank_commission_percent/100)`,
     - где `base_rate` — курс от CBR, `bank_commission_percent` — из `config/commissions.yml`.
   - Описать, какие операции считаются «банковскими» (покупка авто, комиссия компании, фрахт, country expenses и т.д.).
2. **Зафиксировать, как банковская комиссия влияет на итог `total_rub`**:
   - `total_rub` в будущей реализации должен включать эффект банковской комиссии за счёт использования эффективных курсов.
   - Не добавлять отдельные поля `bank_commission_*` в breakdown; эффект виден только в `total_rub` и в `rates_used`.
3. **Спроектировать расширение `CalculationMeta` для отражения комиссии**:
   - Добавить в модель (на уровне документации) поле(я) для процента банковской комиссии и связи с базовым курсом:
     - пример: `bank_commission_percent`,
     - формат `rates_used`: `USD/RUB = 78.95 + 1%` при ненулевой комиссии, `USD/RUB = 78.95` при нулевой.
4. **Обновить RPG‑описание узлов движка и моделей**:
   - В `docs/rpg.yaml` зафиксировать:
     - какие функции/части `engine.py` относятся к банковским операциям,
     - как они используют конфиг `bank_commission`,
     - как наполняется `CalculationMeta` новыми данными.

## Критерии достижения целей

1. В `docs/SPECIFICATION.md` есть формальное описание алгоритма применения банковской комиссии:
   - Чётко описан расчёт эффективного курса и правило использования его для всех релевантных конвертаций `VALUTA -> RUB`.
   - Определён перечень операций (стоимость авто, расходы по стране, фрахт, комиссия компании, пошлина — при наличии валютной операции), на которые распространяется комиссия.
2. В SPEC задокументировано поведение итогов:
   - `total_rub` включает банковскую комиссию.
   - Отдельные суммы банковской комиссии **не выводятся** в API, в breakdown и UI.
3. В SPEC и/или отдельном разделе описан формат `CalculationMeta`:
   - Добавлено поле для процента банковской комиссии.
   - Объяснён формат строки для отображения курса: `BASE_RATE + PERCENT%` при ненулевой комиссии и без `+ PERCENT%` при нуле.
4. В `docs/rpg.yaml` обновлены узлы:
   - Для `engine.py` — перечень функций/блоков, использующих банковскую комиссию.
   - Для `models.py` — поля, отражающие банковскую комиссию в `CalculationMeta`.
5. По итогам спринта команда понимает **где именно в коде** будет добавляться логика комиссии, не открывая сам код на изменение.

---

## Статус реализации к 2025‑12‑15

По состоянию на 15 декабря 2025 года цели спринта 2 не только спроектированы, но и реализованы в коде и спецификации.

### Движок (`app/calculation/engine.py`)

- Реализованы функции:
  - `_get_bank_commission_percent(commissions_conf)`: извлекает эффективный процент банковской комиссии из `config.commissions` с учётом `enabled`, `percent` и `meta.default_percent`.
  - `_effective_currency_rate(rates_conf, code, bank_commission_percent)`: считает `effective_rate = base_rate × (1 + bank_commission_percent/100)`.
  - Обновлённый `_convert(amount, currency, rates_conf, bank_commission_percent=None)`: поддерживает конвертацию по базовому или эффективному курсу.
- Банковская комиссия фактически применяется к операциям:
  - конвертация цены покупки (`purchase_price_rub`),
  - расходы по стране (`country_expenses_rub`),
  - фрахт (`freight_rub`),
  - **комиссия компании** (1000 USD и переопределения по странам) — при конвертации в RUB используется `effective_rate`.
- API и структура `CostBreakdown` не изменились: эффект комиссии отражён только в числах (`total_rub`, компоненты в RUB), без добавления новых полей в JSON.

### Модели (`app/calculation/models.py`)

- Добавлен класс `RateUsage`:
  - `base_rate: float`,
  - `effective_rate: float`,
  - `bank_commission_percent: float`,
  - `display: str` (формат типа `"USD/RUB = 78.95 + 1%"`).
- `CalculationMeta` расширен:
  - сохранено старое поле `rates_used: dict[str, float]` (для обратной совместимости),
  - добавлено новое поле `detailed_rates_used: dict[str, RateUsage]` — детализированная информация по использованным валютам.

### Спецификация (`docs/SPECIFICATION.md`)

- Раздел **4.5. «Банковская комиссия (надбавка к валютному курсу)**:
  - описывает структуру `bank_commission` в `config/commissions.yml` и поведение по умолчанию;
  - фиксирует формулу `effective_rate = base_rate × (1 + bank_commission_percent/100)`;
  - перечисляет точки применения комиссии, включая комиссию компании при конвертации 1000 USD в RUB;
  - описывает формат метаданных `CalculationMeta.rates_used`/`detailed_rates_used` (base, percent, effective, display).

### RPG‑описание (`docs/rpg.yaml`)

- Узлы, связанные с банковской комиссией, обновлены:
  - `config_data/commissions.yml` — содержит артефакт `bank_commission`;
  - `app_calculation_engine` — описаны функции и блоки, использующие банковскую комиссию при конвертации валют;
  - `CalculationMeta` — указано, что в `rates_used`/`detailed_rates_used` должны храниться `base_rate`, `bank_commission_percent`, `effective_rate` и человеко‑читаемое представление для UI.
- В `metadata.recent_changes` и `planned_improvements` зафиксирован прогресс по ветке `bank_commission_runtime_support`.

### Тесты

- Добавлены юнит‑тесты (`tests/unit/test_bank_commission.py`), покрывающие:
  - `_get_bank_commission_percent` (отсутствие секции, `enabled: false`, использование `meta.default_percent`, неверные значения);
  - `_effective_currency_rate` для сценариев с 0% и ненулевой комиссией, включая чувствительность к регистру кода валюты.
- Существующие функциональные тесты движка продолжают проверять целостный расчёт, включая влияние банковской комиссии через изменённые RUB‑значения и метаданные.

> Таким образом, спринт 2 можно считать **завершённым не только на уровне дизайна, но и на уровне кода и спецификации**; документ остаётся источником правды о замысле, а приведённый статус помогает сопоставить его с текущей реализацией.
