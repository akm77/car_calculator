# –ü–†–û–ú–ü–¢: –°–ü–†–ò–ù–¢ 7 ‚Äî Telegram Bot

## üé≠ –†–û–õ–¨ –ú–û–î–ï–õ–ò
–¢—ã ‚Äî **Telegram Bot Developer** —Å —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–æ–π –≤ aiogram 3.x, –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –Ω–∞ Python –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å FastAPI-–±—ç–∫–µ–Ω–¥–æ–º.

---

## üìò –ú–ï–¢–û–î–û–õ–û–ì–ò–Ø
–ò—Å–ø–æ–ª—å–∑—É–π **Repository Planning Graph (RPG)** ‚Äî –ø—Ä–æ—á—Ç–∏ `docs/rpg_intro.txt`.

**–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –¥–ª—è —ç—Ç–æ–≥–æ —Å–ø—Ä–∏–Ω—Ç–∞:**
1. **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è** ‚Äî —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è engine_power_hp –≤ –ø—Ä–∏–º–µ—Ä—ã
2. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** ‚Äî —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–µ –ª–æ–º–∞—é—Ç—Å—è
3. **–ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è** ‚Äî —Ç–µ—Å—Ç–∏—Ä—É–π –∫–∞–∂–¥—ã–π —Ö–µ–Ω–¥–ª–µ—Ä –æ—Ç–¥–µ–ª—å–Ω–æ

---

## üìä –ì–†–ê–§ –ü–†–û–ï–ö–¢–ê
**–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏** –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–ø—Ä–∏–Ω—Ç–∞: `docs/rpg.yaml`

**–î–æ–±–∞–≤—å –≤ recent_changes:**
```yaml
- date: "2025-12-08"
  description: "SPRINT 7 –∑–∞–≤–µ—Ä—à—ë–Ω: –û–±–Ω–æ–≤–ª–µ–Ω—ã Telegram Bot —Ö–µ–Ω–¥–ª–µ—Ä—ã (cmd_calc —Å engine_power_hp=110, on_webapp_data –ø–∞—Ä—Å–∏–Ω–≥ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—è, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –º–æ—â–Ω–æ—Å—Ç–∏ –∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞), —Ç–µ—Å—Ç—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º –±–æ—Ç–æ–º –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã"
```

---

## üéØ –¶–ï–õ–¨ –°–ü–†–ò–ù–¢–ê
–û–±–Ω–æ–≤–∏—Ç—å Telegram Bot –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—è `engine_power_hp`:
1. –î–æ–±–∞–≤–∏—Ç—å engine_power_hp –≤ –ø—Ä–∏–º–µ—Ä—ã —Ä–∞—Å—á—ë—Ç–∞ (/calc)
2. –ü–∞—Ä—Å–∏—Ç—å engine_power_hp –∏–∑ WebApp –¥–∞–Ω–Ω—ã—Ö
3. –û—Ç–æ–±—Ä–∞–∂–∞—Ç—å –º–æ—â–Ω–æ—Å—Ç—å –∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å –∂–∏–≤—ã–º –±–æ—Ç–æ–º

---

## üìö –ò–°–¢–û–ß–ù–ò–ö–ò –ü–†–ê–í–î–´

### –ü–µ—Ä–≤–∏—á–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ (—á–∏—Ç–∞–π –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)
1. **–ü–ª–∞–Ω —Ä–∞–±–æ—Ç**: `docs/REFACTORING_PLAN.md` (–≠—Ç–∞–ø 7, –∑–∞–¥–∞—á–∏ 7.1-7.2)
2. **Bot handlers**: `app/bot/handlers/start.py` (cmd_calc, on_webapp_data)
3. **Backend –º–æ–¥–µ–ª–∏**: `app/calculation/models.py` (CalculationRequest, CalculationResult)

### –í—Ç–æ—Ä–∏—á–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ (–¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
4. **Bot main**: `app/bot/main.py` (–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞)
5. **Messages**: `app/core/messages.py` (—Ç–µ–∫—Å—Ç—ã –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
6. **Engine**: `app/calculation/engine.py` (—Ñ—É–Ω–∫—Ü–∏—è calculate)

### –ü—Ä–æ–±–ª–µ–º–∞ ¬´Lost in the Middle¬ª
‚ö†Ô∏è **–§–æ–∫—É—Å–∏—Ä—É–π—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ start.py:**
- –ù–µ —á–∏—Ç–∞–π –≤–µ—Å—å bot/ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
- –ù–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π keyboards.py (—Ç–∞–º –Ω–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π)
- –ù–µ –ª–µ–∑—å –≤ main.py (—Ç–æ–∫–µ–Ω –∏ polling –Ω–µ –º–µ–Ω—è—é—Ç—Å—è)

---

## ‚úÖ –ö–†–ò–¢–ï–†–ò–ò –î–û–°–¢–ò–ñ–ï–ù–ò–Ø –¶–ï–õ–ò

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ (Must Have)
- [ ] **cmd_calc –æ–±–Ω–æ–≤–ª—ë–Ω** ‚Äî –ø—Ä–∏–º–µ—Ä —Ä–∞—Å—á—ë—Ç–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç `engine_power_hp=110`
- [ ] **on_webapp_data –ø–∞—Ä—Å–∏—Ç** ‚Äî `engine_power_hp = data.get("engine_power_hp")` –¥–æ–±–∞–≤–ª–µ–Ω
- [ ] **–†–µ–∑—É–ª—å—Ç–∞—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç—Å—è** ‚Äî –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –º–æ—â–Ω–æ—Å—Ç—å –≤ –∫–í—Ç –∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É—Ç–∏–ª—å—Å–±–æ—Ä–∞
- [ ] **–ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è** ‚Äî `python -m app.bot.main` –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] **Manual test –ø—Ä–æ—Ö–æ–¥–∏—Ç** ‚Äî –∫–æ–º–∞–Ω–¥–∞ /calc –∏ WebApp –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–µ (Should Have)
- [ ] **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** ‚Äî –µ—Å–ª–∏ engine_power_hp –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ WebApp –¥–∞–Ω–Ω—ã—Ö, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ–Ω—è—Ç–Ω–∞—è –æ—à–∏–±–∫–∞
- [ ] **–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–µ–ª** ‚Äî –º–æ—â–Ω–æ—Å—Ç—å –∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —á–∏—Ç–∞–µ–º–æ
- [ ] **HTML —Ä–∞–∑–º–µ—Ç–∫–∞** ‚Äî bold/italic –¥–ª—è –∞–∫—Ü–µ–Ω—Ç–æ–≤ –≤ Telegram

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ (Nice to Have)
- [ ] **Inline –∫–Ω–æ–ø–∫–∏** ‚Äî "–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –µ—â—ë" –ø–æ—Å–ª–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
- [ ] **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Äî –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Ñ–∞–∫—Ç —Ä–∞—Å—á—ë—Ç–∞ —Å –Ω–æ–≤—ã–º –ø–æ–ª–µ–º
- [ ] **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** ‚Äî —Å—á—ë—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—è

---

## üîç –ó–ê–î–ê–ß–ò (–≤ –ø–æ—Ä—è–¥–∫–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)

### –ó–∞–¥–∞—á–∞ 7.1: –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É /calc (–ø—Ä–∏–º–µ—Ä —Ä–∞—Å—á—ë—Ç–∞)

**–§–∞–π–ª:** `app/bot/handlers/start.py`

**–ù–∞–π–¥–∏ —Ñ—É–Ω–∫—Ü–∏—é:**
```python
@router.message(Command("calc"))
async def cmd_calc(message: Message):
    """–ü—Ä–∏–º–µ—Ä —Ä–∞—Å—á—ë—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (–¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è)."""
    # ...
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```python
@router.message(Command("calc"))
async def cmd_calc(message: Message):
    """
    –ü—Ä–∏–º–µ—Ä —Ä–∞—Å—á—ë—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (–¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è).
    
    NEW in v2.0: –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ engine_power_hp.
    """
    try:
        # –ü—Ä–∏–º–µ—Ä: –Ø–ø–æ–Ω–∏—è, 2021 –≥–æ–¥, 1496 cc, 110 –ª.—Å., 2.5M JPY
        req = CalculationRequest(
            country="japan",
            year=2021,
            engine_cc=1496,
            engine_power_hp=110,  # NEW: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ (–¥–æ–±–∞–≤—å —ç—Ç—É —Å—Ç—Ä–æ–∫—É)
            purchase_price=Decimal("2500000"),
            currency="JPY",
            vehicle_type="M1"
        )
        
        # –†–∞—Å—á—ë—Ç
        result = calculate(req)
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        response = _format_result(result, req)  # –∏—Å–ø–æ–ª—å–∑—É–π helper (—Å–º. –∑–∞–¥–∞—á—É 7.3)
        
        await message.answer(response, parse_mode="HTML")
        
    except Exception as e:
        logger.error("calc_command_error", error=str(e), exc_info=True)
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á—ë—Ç–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:** –ö–æ–º–∞–Ω–¥–∞ /calc —Ä–∞–±–æ—Ç–∞–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –º–æ—â–Ω–æ—Å—Ç—å—é

---

### –ó–∞–¥–∞—á–∞ 7.2: –û–±–Ω–æ–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ WebApp –¥–∞–Ω–Ω—ã—Ö

**–§–∞–π–ª:** `app/bot/handlers/start.py`

**–ù–∞–π–¥–∏ —Ñ—É–Ω–∫—Ü–∏—é:**
```python
@router.message(F.web_app_data)
async def on_webapp_data(message: Message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Telegram WebApp."""
    # ...
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```python
@router.message(F.web_app_data)
async def on_webapp_data(message: Message):
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Telegram WebApp.
    
    NEW in v2.0: –ø–∞—Ä—Å–∏–Ω–≥ engine_power_hp –∏–∑ WebApp payload.
    """
    try:
        # –ü–∞—Ä—Å–∏–Ω–≥ JSON
        data = json.loads(message.web_app_data.data)
        logger.info("webapp_data_received", data_keys=list(data.keys()))
        
        # NEW: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ–ª—è engine_power_hp
        if "engine_power_hp" not in data:
            await message.answer(
                "‚ùå <b>–û—à–∏–±–∫–∞:</b> –ù–µ —É–∫–∞–∑–∞–Ω–∞ –º–æ—â–Ω–æ—Å—Ç—å –¥–≤–∏–≥–∞—Ç–µ–ª—è.\n"
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã.",
                parse_mode="HTML"
            )
            return
        
        # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
        req = CalculationRequest(
            country=data.get("country"),
            year=int(data.get("year")),
            engine_cc=int(data.get("engine_cc")),
            engine_power_hp=int(data.get("engine_power_hp")),  # NEW: –¥–æ–±–∞–≤—å —ç—Ç—É —Å—Ç—Ä–æ–∫—É
            purchase_price=Decimal(str(data.get("purchase_price"))),
            currency=data.get("currency"),
            vehicle_type=data.get("vehicle_type", "M1"),
            freight_type=data.get("freight_type", "container"),
            sanctions_unknown=data.get("sanctions_unknown", False)
        )
        
        # –†–∞—Å—á—ë—Ç
        result = calculate(req)
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        response = _format_result(result, req)
        
        await message.answer(response, parse_mode="HTML")
        
    except ValidationError as ve:
        logger.warning("webapp_validation_error", errors=ve.errors())
        error_msgs = "\n".join([f"‚Ä¢ {e['msg']}" for e in ve.errors()])
        await message.answer(
            f"‚ùå <b>–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:</b>\n{error_msgs}",
            parse_mode="HTML"
        )
    except Exception as e:
        logger.error("webapp_data_error", error=str(e), exc_info=True)
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.")
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:** WebApp –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ ‚Üí –±–æ—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –º–æ—â–Ω–æ—Å—Ç—å—é

---

### –ó–∞–¥–∞—á–∞ 7.3: –°–æ–∑–¥–∞—Ç—å helper –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

**–§–∞–π–ª:** `app/bot/handlers/start.py`

**–î–æ–±–∞–≤—å –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é** (–ø–µ—Ä–µ–¥ —Ö–µ–Ω–¥–ª–µ—Ä–∞–º–∏):
```python
def _format_result(result: CalculationResult, req: CalculationRequest) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Ä–∞—Å—á—ë—Ç–∞ –¥–ª—è Telegram.
    
    Args:
        result: –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—á—ë—Ç–∞ –∏–∑ engine.calculate()
        req: –ò—Å—Ö–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å (–¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤)
    
    Returns:
        str: HTML-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è Telegram
    """
    breakdown = result.breakdown
    meta = result.meta
    
    # –ó–∞–≥–æ–ª–æ–≤–æ–∫
    country_emoji = {
        "japan": "üáØüáµ",
        "korea": "üá∞üá∑",
        "uae": "üá¶üá™",
        "china": "üá®üá≥",
        "georgia": "üá¨üá™"
    }.get(req.country, "üåç")
    
    msg = f"<b>üí∞ –†–∞—Å—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ä–∞—Å—Ç–∞–º–æ–∂–∫–∏</b>\n\n"
    
    # –í—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    msg += f"{country_emoji} <b>–°—Ç—Ä–∞–Ω–∞:</b> {req.country.upper()}\n"
    msg += f"üìÖ <b>–ì–æ–¥:</b> {req.year} ({meta.age_category})\n"
    msg += f"‚öôÔ∏è <b>–û–±—ä—ë–º:</b> {req.engine_cc} —Å–º¬≥\n"
    
    # NEW: –ú–æ—â–Ω–æ—Å—Ç—å
    if meta.engine_power_hp and meta.engine_power_kw:
        msg += f"üîã <b>–ú–æ—â–Ω–æ—Å—Ç—å:</b> {meta.engine_power_hp} –ª.—Å. "
        msg += f"<i>({meta.engine_power_kw:.2f} –∫–í—Ç)</i>\n"
    
    msg += f"üíµ <b>–¶–µ–Ω–∞:</b> {req.purchase_price:,.0f} {req.currency}\n"
    msg += "\n"
    
    # –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏
    msg += "<b>üìä –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è:</b>\n"
    msg += f"‚Ä¢ –¢–∞–º–æ–∂–µ–Ω–Ω–∞—è –ø–æ—à–ª–∏–Ω–∞: {breakdown.duty_rub:,.0f} ‚ÇΩ\n"
    msg += f"‚Ä¢ –£—Ç–∏–ª–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–π —Å–±–æ—Ä: {breakdown.utilization_fee_rub:,.0f} ‚ÇΩ\n"
    
    # NEW: –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É—Ç–∏–ª—å—Å–±–æ—Ä–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    if meta.utilization_coefficient is not None:
        msg += f"  <i>(–±–∞–∑–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ 20,000 ‚ÇΩ √ó –∫–æ—ç—Ñ—Ñ. {meta.utilization_coefficient})</i>\n"
    
    msg += f"‚Ä¢ –¢–∞–º–æ–∂–µ–Ω–Ω–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ: {breakdown.customs_services_rub:,.0f} ‚ÇΩ\n"
    msg += f"‚Ä¢ –§—Ä–∞—Ö—Ç: {breakdown.freight_rub:,.0f} ‚ÇΩ\n"
    msg += f"‚Ä¢ –†–∞—Å—Ö–æ–¥—ã –≤ —Å—Ç—Ä–∞–Ω–µ: {breakdown.country_expenses_rub:,.0f} ‚ÇΩ\n"
    msg += f"‚Ä¢ –ö–æ–º–∏—Å—Å–∏—è –∫–æ–º–ø–∞–Ω–∏–∏: {breakdown.company_commission_rub:,.0f} ‚ÇΩ\n"
    msg += f"‚Ä¢ –≠–†–ê-–ì–õ–û–ù–ê–°–°: {breakdown.era_glonass_rub:,.0f} ‚ÇΩ\n"
    msg += "\n"
    
    # –ò—Ç–æ–≥–æ
    msg += f"<b>üíé –ò–¢–û–ì–û: {breakdown.total_rub:,.0f} ‚ÇΩ</b>\n"
    
    # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
    if result.warnings:
        msg += "\n‚ö†Ô∏è <b>–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:</b>\n"
        for warning in result.warnings:
            msg += f"‚Ä¢ {warning.message}\n"
    
    return msg
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:** –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —á–∏—Ç–∞–µ–º—ã–π HTML –¥–ª—è Telegram

---

### –ó–∞–¥–∞—á–∞ 7.4: –û–±–Ω–æ–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

**–§–∞–π–ª:** `app/bot/handlers/start.py`

**–ü—Ä–æ–≤–µ—Ä—å –Ω–∞–ª–∏—á–∏–µ –∏–º–ø–æ—Ä—Ç–æ–≤:**
```python
import json
from decimal import Decimal
from pydantic import ValidationError

from aiogram import Router, F
from aiogram.filters import Command
from aiogram.types import Message

from app.calculation.engine import calculate
from app.calculation.models import CalculationRequest, CalculationResult
from app.bot.keyboards import main_menu
from app.struct_logger import logger
from app.core.settings import get_settings
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:** –í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–º–ø–æ—Ä—Ç—ã –Ω–∞ –º–µ—Å—Ç–µ

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### Manual Testing —Å —Ä–µ–∞–ª—å–Ω—ã–º –±–æ—Ç–æ–º

**–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:**
```bash
# 1. –£–±–µ–¥–∏—Å—å, —á—Ç–æ backend –∑–∞–ø—É—â–µ–Ω
python -m app.main  # –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ

# 2. –ó–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞
python -m app.bot.main
```

**–¢–µ—Å—Ç 1: –ö–æ–º–∞–Ω–¥–∞ /calc**
1. –û—Ç–∫—Ä–æ–π –±–æ—Ç–∞ –≤ Telegram
2. –û—Ç–ø—Ä–∞–≤—å `/calc`
3. –ü—Ä–æ–≤–µ—Ä—å –æ—Ç–≤–µ—Ç:
   - [ ] –ï—Å—Ç—å —Å—Ç—Ä–æ–∫–∞ "üîã –ú–æ—â–Ω–æ—Å—Ç—å: 110 –ª.—Å. (80.91 –∫–í—Ç)"
   - [ ] –ï—Å—Ç—å "–£—Ç–∏–ª–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–π —Å–±–æ—Ä: 5,200 ‚ÇΩ"
   - [ ] –ï—Å—Ç—å "(–±–∞–∑–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ 20,000 ‚ÇΩ √ó –∫–æ—ç—Ñ—Ñ. 0.26)"
   - [ ] –û–±—â–∞—è —Å—É–º–º–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞

**–¢–µ—Å—Ç 2: WebApp –¥–∞–Ω–Ω—ã–µ**
1. –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É "–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä" (–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç WebApp)
2. –ó–∞–ø–æ–ª–Ω–∏ —Ñ–æ—Ä–º—É:
   - –°—Ç—Ä–∞–Ω–∞: –ö–æ—Ä–µ—è
   - –ì–æ–¥: 2020
   - –û–±—ä—ë–º: 2000 cc
   - **–ú–æ—â–Ω–æ—Å—Ç—å: 150 –ª.—Å.** ‚Üê NEW
   - –¶–µ–Ω–∞: 15,000,000 KRW
3. –ù–∞–∂–º–∏ "–†–∞—Å—Å—á–∏—Ç–∞—Ç—å"
4. –ü—Ä–æ–≤–µ—Ä—å –æ—Ç–≤–µ—Ç –æ—Ç –±–æ—Ç–∞:
   - [ ] –ú–æ—â–Ω–æ—Å—Ç—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - [ ] –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É—Ç–∏–ª—å—Å–±–æ—Ä–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–∞–±–ª–∏—Ü–µ
   - [ ] –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏

**–¢–µ—Å—Ç 3: –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏**
1. –û—Ç–∫—Ä–æ–π WebApp
2. –ó–∞–ø–æ–ª–Ω–∏ —Ñ–æ—Ä–º—É, –Ω–æ **–ù–ï** –≤–≤–æ–¥–∏ –º–æ—â–Ω–æ—Å—Ç—å (–∏–ª–∏ –≤–≤–µ–¥–∏ 0)
3. –û—Ç–ø—Ä–∞–≤—å –¥–∞–Ω–Ω—ã–µ
4. –ü—Ä–æ–≤–µ—Ä—å:
   - [ ] –ë–æ—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç "‚ùå –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏"
   - [ ] –£–∫–∞–∑–∞–Ω–æ, —á—Ç–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –ø–æ–ª—è engine_power_hp

---

### Expected Output

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ –Ω–∞ /calc:**
```
üí∞ –†–∞—Å—á—ë—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ä–∞—Å—Ç–∞–º–æ–∂–∫–∏

üáØüáµ –°—Ç—Ä–∞–Ω–∞: JAPAN
üìÖ –ì–æ–¥: 2021 (3-5 –ª–µ—Ç)
‚öôÔ∏è –û–±—ä—ë–º: 1496 —Å–º¬≥
üîã –ú–æ—â–Ω–æ—Å—Ç—å: 110 –ª.—Å. (80.91 –∫–í—Ç)
üíµ –¶–µ–Ω–∞: 2,500,000 JPY

üìä –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è:
‚Ä¢ –¢–∞–º–æ–∂–µ–Ω–Ω–∞—è –ø–æ—à–ª–∏–Ω–∞: 180,500 ‚ÇΩ
‚Ä¢ –£—Ç–∏–ª–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–π —Å–±–æ—Ä: 5,200 ‚ÇΩ
  (–±–∞–∑–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ 20,000 ‚ÇΩ √ó –∫–æ—ç—Ñ—Ñ. 0.26)
‚Ä¢ –¢–∞–º–æ–∂–µ–Ω–Ω–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ: 150,000 ‚ÇΩ
‚Ä¢ –§—Ä–∞—Ö—Ç: 45,000 ‚ÇΩ
‚Ä¢ –†–∞—Å—Ö–æ–¥—ã –≤ —Å—Ç—Ä–∞–Ω–µ: 78,000 ‚ÇΩ
‚Ä¢ –ö–æ–º–∏—Å—Å–∏—è –∫–æ–º–ø–∞–Ω–∏–∏: 95,000 ‚ÇΩ
‚Ä¢ –≠–†–ê-–ì–õ–û–ù–ê–°–°: 45,000 ‚ÇΩ

üíé –ò–¢–û–ì–û: 598,700 ‚ÇΩ
```

---

## üìù –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø

### –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –∫–æ–¥–µ
```python
# app/bot/handlers/start.py

"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ Telegram –±–æ—Ç–∞.

Changelog:
- 2025-12-08: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ engine_power_hp –≤ cmd_calc –∏ on_webapp_data
- 2025-12-08: –°–æ–∑–¥–∞–Ω helper _format_result –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
"""
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ rpg.yaml
```yaml
components:
  - name: "cmd_calc"
    parent_file: "app/bot/handlers/start.py"
    type: "function"
    description: "–ö–æ–º–∞–Ω–¥–∞ /calc ‚Äî –ø—Ä–∏–º–µ—Ä —Ä–∞—Å—á—ë—Ç–∞ (NEW: —Å engine_power_hp=110)"
    testable: true
    test_priority: "medium"

  - name: "on_webapp_data"
    parent_file: "app/bot/handlers/start.py"
    type: "function"
    description: "–û–±—Ä–∞–±–æ—Ç–∫–∞ WebApp –¥–∞–Ω–Ω—ã—Ö (NEW: –ø–∞—Ä—Å–∏–Ω–≥ engine_power_hp, –≤–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–æ—â–Ω–æ—Å—Ç–∏ –∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ)"
    testable: true
    test_priority: "high"

  - name: "_format_result"
    parent_file: "app/bot/handlers/start.py"
    type: "function"
    description: "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ CalculationResult –≤ HTML –¥–ª—è Telegram (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–æ—â–Ω–æ—Å—Ç—å, –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É—Ç–∏–ª—å—Å–±–æ—Ä–∞, breakdown)"
    testable: true
    test_priority: "medium"

recent_changes:
  - date: "2025-12-08"
    description: "SPRINT 7 –∑–∞–≤–µ—Ä—à—ë–Ω: –û–±–Ω–æ–≤–ª–µ–Ω—ã Telegram Bot —Ö–µ–Ω–¥–ª–µ—Ä—ã (cmd_calc —Å engine_power_hp, on_webapp_data —Å –ø–∞—Ä—Å–∏–Ω–≥–æ–º –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π, _format_result —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –º–æ—â–Ω–æ—Å—Ç–∏ –∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞), manual tests —Å —Ä–µ–∞–ª—å–Ω—ã–º –±–æ—Ç–æ–º –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã"
```

---

## üö® –ü–†–û–ë–õ–ï–ú–´ –ò –†–ï–®–ï–ù–ò–Ø

### –ü—Ä–æ–±–ª–µ–º–∞: –ë–æ—Ç –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
**–ü—Ä–∏—á–∏–Ω–∞:** –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç BOT_TOKEN –≤ .env

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å .env —Ñ–∞–π–ª
cat .env | grep BOT_TOKEN

# –ï—Å–ª–∏ –ø—É—Å—Ç–æ, –¥–æ–±–∞–≤—å:
echo "BOT_TOKEN=YOUR_TELEGRAM_BOT_TOKEN" >> .env
```

### –ü—Ä–æ–±–ª–µ–º–∞: ValidationError –ø—Ä–∏ /calc
**–ü—Ä–∏—á–∏–Ω–∞:** Backend models.py —Ç—Ä–µ–±—É–µ—Ç engine_power_hp, –Ω–æ —Å—Ç–∞—Ä—ã–π –∫–æ–¥ –µ–≥–æ –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞–ª

**–†–µ—à–µ–Ω–∏–µ:**
- –£–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –∑–∞–¥–∞—á–µ 7.1 (–¥–æ–±–∞–≤–ª–µ–Ω `engine_power_hp=110`)
- –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –≤—Å—ë —Ä–∞–≤–Ω–æ –µ—Å—Ç—å ‚Äî –ø—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –°–ø—Ä–∏–Ω—Ç 1 (models.py) –≤—ã–ø–æ–ª–Ω–µ–Ω

### –ü—Ä–æ–±–ª–µ–º–∞: WebApp –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç engine_power_hp
**–ü—Ä–∏—á–∏–Ω–∞:** –§—Ä–æ–Ω—Ç–µ–Ω–¥ (–°–ø—Ä–∏–Ω—Ç 6) –µ—â—ë –Ω–µ –æ–±–Ω–æ–≤–ª—ë–Ω

**–†–µ—à–µ–Ω–∏–µ:**
1. –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏ –°–ø—Ä–∏–Ω—Ç 6 (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è –≤ WebApp)
2. –ó–∞—Ç–µ–º –≤–æ–∑–≤—Ä–∞—â–∞–π—Å—è –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –±–æ—Ç–∞
3. –í—Ä–µ–º–µ–Ω–Ω—ã–π workaround (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è):
   ```python
   # –í on_webapp_data:
   engine_power_hp = int(data.get("engine_power_hp", 110))  # fallback –Ω–∞ 110
   ```

### –ü—Ä–æ–±–ª–µ–º–∞: –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
**–ü—Ä–∏—á–∏–Ω–∞:** Backend –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç meta.utilization_coefficient

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –°–ø—Ä–∏–Ω—Ç 3 (engine.py) –≤—ã–ø–æ–ª–Ω–µ–Ω
- –î–æ–±–∞–≤—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤ _format_result:
  ```python
  if meta.utilization_coefficient is not None:
      msg += f"  (–∫–æ—ç—Ñ—Ñ. {meta.utilization_coefficient})\n"
  ```

---

## ‚è±Ô∏è –í–†–ï–ú–Ø –í–´–ü–û–õ–ù–ï–ù–ò–Ø
**–û—Ü–µ–Ω–∫–∞:** 1 —á–∞—Å

**Breakdown:**
- –ó–∞–¥–∞—á–∞ 7.1: 10 –º–∏–Ω—É—Ç (cmd_calc)
- –ó–∞–¥–∞—á–∞ 7.2: 20 –º–∏–Ω—É—Ç (on_webapp_data)
- –ó–∞–¥–∞—á–∞ 7.3: 20 –º–∏–Ω—É—Ç (_format_result)
- –ó–∞–¥–∞—á–∞ 7.4: 5 –º–∏–Ω—É—Ç (–∏–º–ø–æ—Ä—Ç—ã)
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: 30 –º–∏–Ω—É—Ç (manual tests —Å –±–æ—Ç–æ–º)

---

## üìû NEXT STEPS
–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–ø—Ä–∏–Ω—Ç–∞:
1. **–û–±–Ω–æ–≤–∏ rpg.yaml** (–¥–æ–±–∞–≤—å recent_changes)
2. **–ö–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π:**
   ```bash
   git add app/bot/handlers/start.py docs/rpg.yaml
   git commit -m "feat(bot): add engine_power_hp support in cmd_calc and webapp_data handler"
   ```
3. **–ü–µ—Ä–µ—Ö–æ–¥–∏ –∫ –°–ø—Ä–∏–Ω—Ç—É 8** (–¢–µ—Å—Ç—ã) ‚Äî —Å–º. `docs/sprint_prompts/SPRINT_8_TESTS.md`

---

## üîó –°–í–Ø–ó–ê–ù–ù–´–ï –§–ê–ô–õ–´
- `docs/REFACTORING_PLAN.md` ‚Äî –ø–æ–ª–Ω—ã–π –ø–ª–∞–Ω (–≠—Ç–∞–ø 7)
- `app/bot/handlers/start.py` ‚Äî —Ü–µ–ª–µ–≤–æ–π —Ñ–∞–π–ª
- `app/bot/main.py` ‚Äî –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
- `app/calculation/models.py` ‚Äî –º–æ–¥–µ–ª–∏ (CalculationRequest)
- `app/calculation/engine.py` ‚Äî —Ñ—É–Ω–∫—Ü–∏—è calculate

---

**–ê–≤—Ç–æ—Ä –ø—Ä–æ–º–ø—Ç–∞:** RPG Architect  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–î–∞—Ç–∞:** 2025-12-08

