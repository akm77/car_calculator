# –ü–†–û–ú–ü–¢: –°–ü–†–ò–ù–¢ 8 ‚Äî –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

## üé≠ –†–û–õ–¨ –ú–û–î–ï–õ–ò
–¢—ã ‚Äî **QA Engineer / Test Automation Specialist** —Å —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–æ–π –≤ pytest, –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–∞—Ö, fixtures –∏ TDD-–ø–æ–¥—Ö–æ–¥–µ.

---

## üìò –ú–ï–¢–û–î–û–õ–û–ì–ò–Ø
–ò—Å–ø–æ–ª—å–∑—É–π **Repository Planning Graph (RPG)** ‚Äî –ø—Ä–æ—á—Ç–∏ `docs/rpg_intro.txt`.

**–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –¥–ª—è —ç—Ç–æ–≥–æ —Å–ø—Ä–∏–Ω—Ç–∞:**
1. **–ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è** ‚Äî –ø–∏—à–∏ –∏ –∑–∞–ø—É—Å–∫–∞–π —Ç–µ—Å—Ç—ã –ø–æ –æ–¥–Ω–æ–º—É
2. **–¢–æ–ø–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ—Ä—è–¥–æ–∫** ‚Äî —Å–Ω–∞—á–∞–ª–∞ unit-—Ç–µ—Å—Ç—ã (—É—Ç–∏–ª—å—Å–±–æ—Ä), –∑–∞—Ç–µ–º integration (API)
3. **–°—Ç–∞–±–∏–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã** ‚Äî —Ç–µ—Å—Ç—ã –Ω–µ –ª–æ–º–∞—é—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

---

## üìä –ì–†–ê–§ –ü–†–û–ï–ö–¢–ê
**–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏** –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–ø—Ä–∏–Ω—Ç–∞: `docs/rpg.yaml`

**–î–æ–±–∞–≤—å –≤ recent_changes:**
```yaml
- date: "2025-12-08"
  description: "SPRINT 8 –∑–∞–≤–µ—Ä—à—ë–Ω: –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–µ–π—Å—ã –≤ cases.yml (–¥–æ–±–∞–≤–ª–µ–Ω–æ engine_power_hp), —Å–æ–∑–¥–∞–Ω tests/unit/test_utilization_v2.py (10 –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ –¥–ª—è _utilization_fee_v2), –æ–±–Ω–æ–≤–ª–µ–Ω—ã functional/test_engine.py (–≤—Å–µ –∫–µ–π—Å—ã –ø—Ä–æ—Ö–æ–¥—è—Ç), coverage ‚â•85%"
```

---

## üéØ –¶–ï–õ–¨ –°–ü–†–ò–ù–¢–ê
–û–±–µ—Å–ø–µ—á–∏—Ç—å –ø–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã —É—Ç–∏–ª–∏–∑–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Å–±–æ—Ä–∞:
1. –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–µ–π—Å—ã (cases.yml) —Å –ø–æ–ª–µ–º engine_power_hp
2. –°–æ–∑–¥–∞—Ç—å unit-—Ç–µ—Å—Ç—ã –¥–ª—è _utilization_fee_v2()
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
4. –î–æ—Å—Ç–∏—á—å coverage ‚â•85%

---

## üìö –ò–°–¢–û–ß–ù–ò–ö–ò –ü–†–ê–í–î–´

### –ü–µ—Ä–≤–∏—á–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ (—á–∏—Ç–∞–π –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)
1. **–ü–ª–∞–Ω —Ä–∞–±–æ—Ç**: `docs/REFACTORING_PLAN.md` (–≠—Ç–∞–ø 8, –∑–∞–¥–∞—á–∏ 8.1-8.3)
2. **–¢–µ—Å—Ç–æ–≤—ã–µ –∫–µ–π—Å—ã**: `tests/test_data/cases.yml`
3. **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã**: `tests/functional/test_engine.py`
4. **Engine**: `app/calculation/engine.py` (—Ñ—É–Ω–∫—Ü–∏—è _utilization_fee_v2)

### –í—Ç–æ—Ä–∏—á–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ (–¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
5. **–ö–æ–Ω—Ñ–∏–≥ —É—Ç–∏–ª—å—Å–±–æ—Ä–∞**: `config/rates.yml` (utilization_m1_personal)
6. **–ú–æ–¥–µ–ª–∏**: `app/calculation/models.py` (CalculationRequest)
7. **–°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è**: `docs/SPECIFICATION.md` (—Ç–∞–±–ª–∏—Ü–∞ —É—Ç–∏–ª—å—Å–±–æ—Ä–∞)

### –ü—Ä–æ–±–ª–µ–º–∞ ¬´Lost in the Middle¬ª
‚ö†Ô∏è **–ß–∏—Ç–∞–π —Ñ–∞–π–ª—ã –ø–æ –æ—á–µ—Ä–µ–¥–∏:**
- –°–Ω–∞—á–∞–ª–∞ cases.yml ‚Üí –æ–ø—Ä–µ–¥–µ–ª–∏, —Å–∫–æ–ª—å–∫–æ –∫–µ–π—Å–æ–≤ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å
- –ó–∞—Ç–µ–º test_engine.py ‚Üí –ø–æ–π–º–∏, –∫–∞–∫ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
- –¢–æ–ª—å–∫–æ –ø–æ—Ç–æ–º —Å–æ–∑–¥–∞–≤–∞–π test_utilization_v2.py

---

## ‚úÖ –ö–†–ò–¢–ï–†–ò–ò –î–û–°–¢–ò–ñ–ï–ù–ò–Ø –¶–ï–õ–ò

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ (Must Have)
- [ ] **cases.yml –æ–±–Ω–æ–≤–ª—ë–Ω** ‚Äî –≤—Å–µ 15+ –∫–µ–π—Å–æ–≤ —Å–æ–¥–µ—Ä–∂–∞—Ç –ø–æ–ª–µ `engine_power_hp`
- [ ] **test_utilization_v2.py —Å–æ–∑–¥–∞–Ω** ‚Äî 10+ unit-—Ç–µ—Å—Ç–æ–≤ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ (–æ–±—ä—ë–º √ó –º–æ—â–Ω–æ—Å—Ç—å)
- [ ] **–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç** ‚Äî `pytest tests/ -v` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 100% success
- [ ] **Coverage ‚â•85%** ‚Äî `pytest --cov=app --cov-report=term` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—ã—Å–æ–∫–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ
- [ ] **–ê—Ä—Ö–∏–≤–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –∫–µ–π—Å–æ–≤** ‚Äî —Å–æ–∑–¥–∞–Ω `cases_v1_backup_20251208.yml`

### –ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–µ (Should Have)
- [ ] **–ì—Ä–∞–Ω–∏—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è** ‚Äî —Ç–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç –º–∏–Ω–∏–º—É–º/–º–∞–∫—Å–∏–º—É–º –º–æ—â–Ω–æ—Å—Ç–∏ (1 –ª.—Å., 1500 –ª.—Å.)
- [ ] **–í—Å–µ –≤–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏** ‚Äî —Ç–µ—Å—Ç—ã –¥–ª—è lt3, 3_5, gt5
- [ ] **–í—Å–µ —Å—Ç—Ä–∞–Ω—ã** ‚Äî —Ö–æ—Ç—è –±—ã –ø–æ 1 —Ç–µ—Å—Ç—É –Ω–∞ japan, korea, uae, china, georgia
- [ ] **Edge cases** ‚Äî —Ç–µ—Å—Ç—ã –Ω–∞ –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º–∏ –æ–±—ä—ë–º–∞/–º–æ—â–Ω–æ—Å—Ç–∏

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ (Nice to Have)
- [ ] **Regression —Ç–µ—Å—Ç—ã** ‚Äî —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–π –∏ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –Ω–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] **Performance —Ç–µ—Å—Ç—ã** ‚Äî –≤—Ä–µ–º—è —Ä–∞—Å—á—ë—Ç–∞ < 100ms
- [ ] **Test fixtures** ‚Äî shared fixtures –¥–ª—è –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –¥–∞–Ω–Ω—ã—Ö

---

## üîç –ó–ê–î–ê–ß–ò (–≤ –ø–æ—Ä—è–¥–∫–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)

### –ó–∞–¥–∞—á–∞ 8.1: –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–µ–π—Å—ã

**–î–µ–π—Å—Ç–≤–∏—è:**
```bash
# –°–æ–∑–¥–∞–π –±—ç–∫–∞–ø
cp tests/test_data/cases.yml tests/test_data/cases_v1_backup_20251208.yml

# –î–æ–±–∞–≤—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ –Ω–∞—á–∞–ª–æ –±—ç–∫–∞–ø–∞
echo "# BACKUP: –°—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞ —É—Ç–∏–ª—å—Å–±–æ—Ä–∞ (—Ç–æ–ª—å–∫–æ –ø–æ –æ–±—ä—ë–º—É), –¥–∞—Ç–∞: 2025-12-08\n$(cat tests/test_data/cases_v1_backup_20251208.yml)" > tests/test_data/cases_v1_backup_20251208.yml
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:** –§–∞–π–ª `cases_v1_backup_20251208.yml` —Å–æ–∑–¥–∞–Ω

---

### –ó–∞–¥–∞—á–∞ 8.2: –û–±–Ω–æ–≤–∏—Ç—å cases.yml (–¥–æ–±–∞–≤–∏—Ç—å engine_power_hp)

**–§–∞–π–ª:** `tests/test_data/cases.yml`

**–ü—Ä–∏–Ω—Ü–∏–ø –ø–æ–¥–±–æ—Ä–∞ –º–æ—â–Ω–æ—Å—Ç–∏** (—Ç–∏–ø–∏—á–Ω—ã–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è):
- ‚â§1000 cc ‚Üí 50-70 –ª.—Å.
- 1000-1500 cc ‚Üí 70-110 –ª.—Å.
- 1500-2000 cc ‚Üí 110-150 –ª.—Å.
- 2000-3000 cc ‚Üí 150-250 –ª.—Å.
- 3000+ cc ‚Üí 250-500 –ª.—Å.

**–ü—Ä–∏–º–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–µ–π—Å–∞:**
```yaml
# BEFORE (—Å—Ç–∞—Ä—ã–π –∫–µ–π—Å)
- id: "japan_lt3_sanctions_unknown"
  request:
    country: "japan"
    year: 2022
    engine_cc: 1496
    purchase_price: 2500000
    currency: "JPY"
    sanctions_unknown: true

# AFTER (NEW: –¥–æ–±–∞–≤–ª–µ–Ω–æ engine_power_hp)
- id: "japan_lt3_sanctions_unknown"
  request:
    country: "japan"
    year: 2022
    engine_cc: 1496
    engine_power_hp: 110  # NEW: ~70-110 –ª.—Å. –¥–ª—è 1500cc
    purchase_price: 2500000
    currency: "JPY"
    sanctions_unknown: true
  expected:
    # –û–±–Ω–æ–≤–∏ expected.breakdown.utilization_fee_rub
    # –ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: 20,000 √ó –∫–æ—ç—Ñ—Ñ. –¥–ª—è (1496cc, 110hp=80.9kW)
    # –ü–æ —Ç–∞–±–ª–∏—Ü–µ: –¥–∏–∞–ø–∞–∑–æ–Ω 1001-2000cc, 73.56-95.61 kW ‚Üí –∫–æ—ç—Ñ—Ñ. 0.26 (lt3)
    breakdown:
      utilization_fee_rub: 5200  # –±—ã–ª–æ –¥—Ä—É–≥–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, —Ç–µ–ø–µ—Ä—å 20000 √ó 0.26
      # ...–æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è –Ω–µ –º–µ–Ω—è—é—Ç—Å—è (–µ—Å–ª–∏ –Ω–µ —Ç—Ä–æ–≥–∞–ª–∏ –ø–æ—à–ª–∏–Ω—ã/–∫–æ–º–∏—Å—Å–∏–∏)
```

**–î–µ–π—Å—Ç–≤–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–µ–π—Å–∞:**
1. –û–ø—Ä–µ–¥–µ–ª–∏ `engine_cc` –∫–µ–π—Å–∞
2. –ü–æ–¥–±–µ—Ä–∏ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—É—é `engine_power_hp` –ø–æ —Ç–∞–±–ª–∏—Ü–µ –≤—ã—à–µ
3. –†–∞—Å—Å—á–∏—Ç–∞–π –Ω–æ–≤—ã–π `utilization_fee_rub` –ø–æ —Ñ–æ—Ä–º—É–ª–µ:
   - –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–π –ª.—Å. ‚Üí –∫–í—Ç: `kw = hp √ó 0.7355`
   - –ù–∞–π–¥–∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –≤ `config/rates.yml` (–ø–æ –æ–±—ä—ë–º—É –∏ –º–æ—â–Ω–æ—Å—Ç–∏)
   - –£–º–Ω–æ–∂—å: `fee = 20,000 √ó coefficient`
4. –û–±–Ω–æ–≤–∏ –ø–æ–ª–µ `expected.breakdown.utilization_fee_rub`
5. –û–±–Ω–æ–≤–∏ `expected.breakdown.total_rub` (–¥–æ–±–∞–≤—å —Ä–∞–∑–Ω–∏—Ü—É –≤ —É—Ç–∏–ª—å—Å–±–æ—Ä–µ)

**–ö—Ä–∏—Ç–µ—Ä–∏–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:** –í—Å–µ –∫–µ–π—Å—ã —Å–æ–¥–µ—Ä–∂–∞—Ç `engine_power_hp`, expected values –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω—ã

---

### –ó–∞–¥–∞—á–∞ 8.3: –°–æ–∑–¥–∞—Ç—å unit-—Ç–µ—Å—Ç—ã –¥–ª—è _utilization_fee_v2

**–§–∞–π–ª:** `tests/unit/test_utilization_v2.py` (—Å–æ–∑–¥–∞–π –Ω–æ–≤—ã–π)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```python
"""
Unit-—Ç–µ—Å—Ç—ã –¥–ª—è –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã —É—Ç–∏–ª–∏–∑–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Å–±–æ—Ä–∞ (2025).

–¢–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏—è _utilization_fee_v2() –∏–∑ app/calculation/engine.py:
- –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –ª.—Å. ‚Üí –∫–í—Ç (0.7355)
- –ü–æ–∏—Å–∫ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –æ–±—ä—ë–º–∞ (5 bands)
- –ü–æ–∏—Å–∫ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –º–æ—â–Ω–æ—Å—Ç–∏ (~16 brackets per band)
- –í—ã–±–æ—Ä –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ (lt3 vs gt3)
- –†–∞—Å—á—ë—Ç: 20,000 √ó coefficient
"""

import pytest
from decimal import Decimal

from app.calculation.engine import _utilization_fee_v2
from app.core.settings import get_configs


@pytest.fixture
def rates_config():
    """–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥–æ–≤ –∏–∑ rates.yml."""
    return get_configs().rates


@pytest.mark.parametrize("age_category,engine_cc,engine_power_hp,expected_coefficient", [
    # –î–∏–∞–ø–∞–∑–æ–Ω ‚â§1000 cc
    ("lt3", 800, 50, 0.17),      # 50hp = 36.78kW ‚Üí ‚â§51.48kW ‚Üí –∫–æ—ç—Ñ—Ñ. 0.17
    ("gt5", 800, 50, 0.26),      # gt3 –∫–æ—ç—Ñ—Ñ. –≤—ã—à–µ
    
    # –î–∏–∞–ø–∞–∑–æ–Ω 1001-2000 cc
    ("lt3", 1500, 70, 0.17),     # 70hp = 51.49kW ‚Üí 51.49-73.55kW ‚Üí –∫–æ—ç—Ñ—Ñ. 0.17
    ("lt3", 1500, 110, 0.26),    # 110hp = 80.91kW ‚Üí 73.56-95.61kW ‚Üí –∫–æ—ç—Ñ—Ñ. 0.26
    ("3_5", 1500, 110, 62.2),    # gt3 (3_5 –∏–ª–∏ gt5) ‚Üí –∫–æ—ç—Ñ—Ñ. 62.2
    
    # –î–∏–∞–ø–∞–∑–æ–Ω 2001-3000 cc
    ("lt3", 2500, 180, 37.5),    # 180hp = 132.39kW ‚Üí 117.69-139.75kW ‚Üí –∫–æ—ç—Ñ—Ñ. 37.5
    ("gt5", 2500, 200, 145.9),   # 200hp = 147.1kW ‚Üí 139.76-161.82kW ‚Üí –∫–æ—ç—Ñ—Ñ. 145.9
    
    # –î–∏–∞–ø–∞–∑–æ–Ω 3001-3500 cc
    ("lt3", 3200, 250, 109.8),   # 250hp = 183.88kW ‚Üí 161.83-183.88kW ‚Üí –∫–æ—ç—Ñ—Ñ. 109.8
    
    # –î–∏–∞–ø–∞–∑–æ–Ω >3500 cc
    ("gt5", 4000, 400, 286.9),   # 400hp = 294.2kW ‚Üí ‚â•367.76kW (–ø–æ—Å–ª–µ–¥–Ω–∏–π –±—Ä—ç–∫–µ—Ç)
    
    # –ì—Ä–∞–Ω–∏—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    ("lt3", 500, 1, 0.17),       # –ú–∏–Ω–∏–º—É–º (1 –ª.—Å.)
    ("gt5", 10000, 1500, None),  # –ú–∞–∫—Å–∏–º—É–º (1500 –ª.—Å., fallback –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –±—Ä—ç–∫–µ—Ç)
])
def test_utilization_fee_calculation(
    rates_config, 
    age_category, 
    engine_cc, 
    engine_power_hp, 
    expected_coefficient
):
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ —É—Ç–∏–ª–∏–∑–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Å–±–æ—Ä–∞ –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤.
    """
    fee, coefficient = _utilization_fee_v2(
        age_category=age_category,
        engine_cc=engine_cc,
        engine_power_hp=engine_power_hp,
        rates_conf=rates_config
    )
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞
    if expected_coefficient is not None:
        assert coefficient == pytest.approx(expected_coefficient, rel=0.01), \
            f"–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–ª—è {engine_cc}cc, {engine_power_hp}hp, {age_category} –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å {expected_coefficient}, –ø–æ–ª—É—á–µ–Ω–æ {coefficient}"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É–º–º—ã (–±–∞–∑–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ √ó –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç)
    base_rate = Decimal("20000")
    expected_fee = base_rate * Decimal(str(coefficient))
    assert fee == pytest.approx(expected_fee, abs=Decimal("0.01")), \
        f"–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å {expected_fee}, –ø–æ–ª—É—á–µ–Ω–æ {fee}"


def test_utilization_fee_hp_to_kw_conversion(rates_config):
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –ª.—Å. ‚Üí –∫–í—Ç.
    """
    # 100 –ª.—Å. = 73.55 –∫–í—Ç
    fee, coefficient = _utilization_fee_v2("lt3", 1500, 100, rates_config)
    
    # –û–∂–∏–¥–∞–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω 73.56-95.61 kW –¥–ª—è 1001-2000cc
    # –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 0.26 (—Å–æ–≥–ª–∞—Å–Ω–æ —Ç–∞–±–ª–∏—Ü–µ)
    assert coefficient == 0.26


def test_utilization_fee_edge_case_boundary(rates_config):
    """
    –¢–µ—Å—Ç –Ω–∞ –≥—Ä–∞–Ω–∏—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –º–µ–∂–¥—É –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º–∏ –æ–±—ä—ë–º–∞.
    """
    # 2000cc (–≥—Ä–∞–Ω–∏—Ü–∞ 1001-2000 / 2001-3000)
    fee_2000, coef_2000 = _utilization_fee_v2("lt3", 2000, 150, rates_config)
    fee_2001, coef_2001 = _utilization_fee_v2("lt3", 2001, 150, rates_config)
    
    # –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –¥–æ–ª–∂–Ω—ã —Ä–∞–∑–ª–∏—á–∞—Ç—å—Å—è (—Ä–∞–∑–Ω—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã)
    assert coef_2000 != coef_2001, "–ì—Ä–∞–Ω–∏—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –ø–æ–ø–∞–¥–∞—Ç—å –≤ —Ä–∞–∑–Ω—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã"


def test_utilization_fee_zero_power(rates_config):
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω—É–ª–µ–≤–æ–π –º–æ—â–Ω–æ—Å—Ç–∏ (edge case).
    """
    # –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–ª—è –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
    fee, coefficient = _utilization_fee_v2("lt3", 1500, 0, rates_config)
    
    # 0 –ª.—Å. = 0 –∫–í—Ç ‚Üí –ø–µ—Ä–≤—ã–π –±—Ä—ç–∫–µ—Ç (‚â§51.48 kW) ‚Üí –∫–æ—ç—Ñ—Ñ. 0.17
    assert coefficient == 0.17


@pytest.mark.skip(reason="–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: —Ç–µ—Å—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∞–±–ª–∏—Ü—ã —É—Ç–∏–ª—å—Å–±–æ—Ä–∞")
def test_utilization_table_completeness(rates_config):
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–Ω–æ—Ç—ã —Ç–∞–±–ª–∏—Ü—ã —É—Ç–∏–ª—å—Å–±–æ—Ä–∞ (–≤—Å–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã –ø–æ–∫—Ä—ã—Ç—ã).
    """
    util = rates_config.get("utilization_m1_personal", {})
    volume_bands = util.get("volume_bands", [])
    
    # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 5 –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ –æ–±—ä—ë–º–∞
    assert len(volume_bands) == 5, "–¢–∞–±–ª–∏—Ü–∞ –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å 5 –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ –æ–±—ä—ë–º–∞"
    
    # –ö–∞–∂–¥—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å power_brackets
    for band in volume_bands:
        assert "power_brackets" in band, f"–î–∏–∞–ø–∞–∑–æ–Ω {band['volume_range']} –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç power_brackets"
        assert len(band["power_brackets"]) > 0, f"–î–∏–∞–ø–∞–∑–æ–Ω {band['volume_range']} –∏–º–µ–µ—Ç –ø—É—Å—Ç—ã–µ power_brackets"
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:** `pytest tests/unit/test_utilization_v2.py -v` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 10+ passed

---

### –ó–∞–¥–∞—á–∞ 8.4: –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã

**–î–µ–π—Å—Ç–≤–∏—è:**
```bash
# 1. –ó–∞–ø—É—Å—Ç–∏ –≤—Å–µ —Ç–µ—Å—Ç—ã
pytest tests/functional/test_engine.py -v

# 2. –ï—Å–ª–∏ –µ—Å—Ç—å –ø–∞–¥–µ–Ω–∏—è ‚Äî –∏–∑—É—á–∏ –≤—ã–≤–æ–¥:
# Expected: utilization_fee_rub = 100,000
# Actual:   utilization_fee_rub = 5,200
# ‚Üí –≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ expected value –≤ cases.yml —É—Å—Ç–∞—Ä–µ–ª

# 3. –û–±–Ω–æ–≤–∏ expected values –≤ cases.yml (—Å–º. –∑–∞–¥–∞—á—É 8.2)

# 4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ —Ç–µ—Å—Ç—ã
pytest tests/functional/test_engine.py -v

# 5. –ü–æ–≤—Ç–æ—Ä—è–π 2-4 –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ –≤—Å–µ —Ç–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ–π–¥—É—Ç
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:** `pytest tests/functional/ -v` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 100% passed

---

### –ó–∞–¥–∞—á–∞ 8.5: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å coverage

**–î–µ–π—Å—Ç–≤–∏—è:**
```bash
# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å coverage
pytest tests/ --cov=app --cov-report=term --cov-report=html

# –û—Ç–∫—Ä–æ–π –æ—Ç—á—ë—Ç
open htmlcov/index.html  # macOS

# –ü—Ä–æ–≤–µ—Ä—å coverage –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤:
# - app/calculation/engine.py ‚Üí –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å ‚â•90% (—Ñ—É–Ω–∫—Ü–∏—è _utilization_fee_v2 –ø–æ–∫—Ä—ã—Ç–∞)
# - app/calculation/models.py ‚Üí ‚â•95% (Pydantic –≤–∞–ª–∏–¥–∞—Ü–∏—è)
# - app/api/routes.py ‚Üí ‚â•85% (–≤—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã)
```

**–ï—Å–ª–∏ coverage < 85%:**
1. –û–ø—Ä–µ–¥–µ–ª–∏ –Ω–µ–ø–æ–∫—Ä—ã—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ (–≤ htmlcov/index.html)
2. –î–æ–±–∞–≤—å —Ç–µ—Å—Ç—ã –¥–ª—è –Ω–µ–ø–æ–∫—Ä—ã—Ç—ã—Ö –≤–µ—Ç–æ–∫ (if/else, try/except)
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ coverage check

**–ö—Ä–∏—Ç–µ—Ä–∏–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:** Overall coverage ‚â•85%

---

### –ó–∞–¥–∞—á–∞ 8.6: –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç –¥–ª—è API /api/calculate (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–§–∞–π–ª:** `tests/functional/test_api.py`

**–î–æ–±–∞–≤—å –Ω–æ–≤—ã–π —Ç–µ—Å—Ç:**
```python
def test_calculate_endpoint_with_engine_power(client: TestClient):
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞ POST /api/calculate —Å –Ω–æ–≤—ã–º –ø–æ–ª–µ–º engine_power_hp.
    """
    payload = {
        "country": "japan",
        "year": 2022,
        "engine_cc": 1500,
        "engine_power_hp": 110,  # NEW
        "purchase_price": 2500000,
        "currency": "JPY",
        "vehicle_type": "M1"
    }
    
    response = client.post("/api/calculate", json=payload)
    
    assert response.status_code == 200
    data = response.json()
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ—Ç–≤–µ—Ç–∞
    assert "breakdown" in data
    assert "meta" in data
    
    # NEW: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π –≤ meta
    meta = data["meta"]
    assert "engine_power_hp" in meta
    assert meta["engine_power_hp"] == 110
    assert "engine_power_kw" in meta
    assert meta["engine_power_kw"] == pytest.approx(80.91, abs=0.1)
    
    # NEW: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ —É—Ç–∏–ª—å—Å–±–æ—Ä–∞
    assert "utilization_coefficient" in meta
    assert meta["utilization_coefficient"] is not None
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ç–∏–ª–∏–∑–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Å–±–æ—Ä–∞ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –ø–æ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ)
    breakdown = data["breakdown"]
    assert breakdown["utilization_fee_rub"] > 0
    # –î–ª—è 1500cc, 110hp, lt3 ‚Üí –∫–æ—ç—Ñ—Ñ. 0.26 ‚Üí 20,000 √ó 0.26 = 5,200
    assert breakdown["utilization_fee_rub"] == pytest.approx(5200, abs=100)


def test_calculate_endpoint_missing_engine_power(client: TestClient):
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ engine_power_hp.
    """
    payload = {
        "country": "japan",
        "year": 2022,
        "engine_cc": 1500,
        # engine_power_hp –û–¢–°–£–¢–°–¢–í–£–ï–¢
        "purchase_price": 2500000,
        "currency": "JPY"
    }
    
    response = client.post("/api/calculate", json=payload)
    
    # –î–æ–ª–∂–Ω–∞ –≤–µ—Ä–Ω—É—Ç—å—Å—è –æ—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
    assert response.status_code == 422
    error_data = response.json()
    assert "detail" in error_data
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –≤ –æ—à–∏–±–∫–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è engine_power_hp
    error_messages = str(error_data["detail"]).lower()
    assert "engine_power_hp" in error_messages or "–º–æ—â–Ω–æ—Å—Ç—å" in error_messages
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:** `pytest tests/functional/test_api.py::test_calculate_endpoint_with_engine_power -v` –ø—Ä–æ—Ö–æ–¥–∏—Ç

---

## üß™ –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê

### –ß–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º —Å–ø—Ä–∏–Ω—Ç–∞

**1. Unit-—Ç–µ—Å—Ç—ã:**
```bash
pytest tests/unit/test_utilization_v2.py -v
# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: 10+ passed
```

**2. Functional-—Ç–µ—Å—Ç—ã:**
```bash
pytest tests/functional/test_engine.py -v
# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: 15+ passed (–≤—Å–µ –∫–µ–π—Å—ã –∏–∑ cases.yml)
```

**3. API-—Ç–µ—Å—Ç—ã:**
```bash
pytest tests/functional/test_api.py -v
# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: 5+ passed (–≤–∫–ª—é—á–∞—è –Ω–æ–≤—ã–µ —Ç–µ—Å—Ç—ã)
```

**4. –í—Å–µ —Ç–µ—Å—Ç—ã –≤–º–µ—Å—Ç–µ:**
```bash
pytest tests/ -v --tb=short
# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: 30+ passed, 0 failed
```

**5. Coverage:**
```bash
pytest tests/ --cov=app --cov-report=term
# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: TOTAL coverage ‚â•85%
```

---

## üìù –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø

### –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ test_utilization_v2.py
```python
"""
Unit-—Ç–µ—Å—Ç—ã –¥–ª—è –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã —É—Ç–∏–ª–∏–∑–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Å–±–æ—Ä–∞ (2025).

Changelog:
- 2025-12-08: –°–æ–∑–¥–∞–Ω –Ω–∞–±–æ—Ä —Ç–µ—Å—Ç–æ–≤ –¥–ª—è _utilization_fee_v2()
- –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç –≤—Å–µ 5 –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ –æ–±—ä—ë–º–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –ª.—Å. ‚Üí –∫–í—Ç (0.7355)
- –ì—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏ (0 –ª.—Å., 1500 –ª.—Å., –≥—Ä–∞–Ω–∏—Ü—ã –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤)

Coverage: ~95% –¥–ª—è app/calculation/engine.py (_utilization_fee_v2)
"""
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ rpg.yaml
```yaml
unit_tests:
  - target_component: "_utilization_fee_v2"
    test_file: "tests/unit/test_utilization_v2.py"
    test_functions: ["test_utilization_fee_calculation (10 cases)", "test_utilization_fee_hp_to_kw_conversion", "test_utilization_fee_edge_case_boundary"]
    coverage_status: "exists"
    notes: "–ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ –æ–±—ä—ë–º–∞ –∏ –º–æ—â–Ω–æ—Å—Ç–∏, –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ lt3/gt3"

integration_tests:
  - integration_point: "API /api/calculate ‚Üí Engine (_utilization_fee_v2)"
    test_description: "POST /api/calculate —Å engine_power_hp ‚Üí –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–∞—Å—á—ë—Ç —É—Ç–∏–ª—å—Å–±–æ—Ä–∞"
    test_file: "tests/functional/test_api.py"
    coverage_status: "exists"

recent_changes:
  - date: "2025-12-08"
    description: "SPRINT 8 –∑–∞–≤–µ—Ä—à—ë–Ω: –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ 15 –∫–µ–π—Å–æ–≤ –≤ cases.yml (engine_power_hp, –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–Ω—ã–µ expected values), —Å–æ–∑–¥–∞–Ω test_utilization_v2.py (10 unit-—Ç–µ—Å—Ç–æ–≤), –æ–±–Ω–æ–≤–ª—ë–Ω test_api.py (2 –Ω–æ–≤—ã—Ö —Ç–µ—Å—Ç–∞), –≤—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç, coverage 87%"

tests:
  test_status:
    overall: "32 passed, 0 failed"
    coverage: "87% (app/)"
```

---

## üö® –ü–†–û–ë–õ–ï–ú–´ –ò –†–ï–®–ï–ù–ò–Ø

### –ü—Ä–æ–±–ª–µ–º–∞: –¢–µ—Å—Ç—ã –ø–∞–¥–∞—é—Ç —Å "missing 1 required positional argument: 'engine_power_hp'"
**–ü—Ä–∏—á–∏–Ω–∞:** cases.yml –Ω–µ –æ–±–Ω–æ–≤–ª—ë–Ω, —Å—Ç–∞—Ä—ã–µ –∫–µ–π—Å—ã –±–µ–∑ engine_power_hp

**–†–µ—à–µ–Ω–∏–µ:**
1. –û—Ç–∫—Ä–æ–π `tests/test_data/cases.yml`
2. –ù–∞–π–¥–∏ –∫–µ–π—Å—ã –±–µ–∑ –ø–æ–ª—è `engine_power_hp`
3. –î–æ–±–∞–≤—å –ø–æ–ª–µ —Å–æ–≥–ª–∞—Å–Ω–æ –∑–∞–¥–∞—á–µ 8.2

### –ü—Ä–æ–±–ª–µ–º–∞: Expected utilization_fee_rub –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å actual
**–ü—Ä–∏—á–∏–Ω–∞:** Expected value —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –ø–æ —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º–µ

**–†–µ—à–µ–Ω–∏–µ:**
1. –ó–∞–ø—É—Å—Ç–∏ —Ç–µ—Å—Ç —Å —Ñ–ª–∞–≥–æ–º `-vv` –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞:
   ```bash
   pytest tests/functional/test_engine.py::test_calculation_cases[japan_lt3] -vv
   ```
2. –ù–∞–π–¥–∏ –≤ –≤—ã–≤–æ–¥–µ:
   ```
   Expected: utilization_fee_rub = 100,000
   Actual:   utilization_fee_rub = 5,200
   ```
3. –†–∞—Å—Å—á–∏—Ç–∞–π –Ω–æ–≤—ã–π expected value:
   - –û–±—ä—ë–º: 1500cc, –º–æ—â–Ω–æ—Å—Ç—å: 110hp (80.91kW)
   - –í–æ–∑—Ä–∞—Å—Ç: lt3
   - –ü–æ —Ç–∞–±–ª–∏—Ü–µ: –¥–∏–∞–ø–∞–∑–æ–Ω 1001-2000, 73.56-95.61kW ‚Üí –∫–æ—ç—Ñ—Ñ. 0.26
   - –°—É–º–º–∞: 20,000 √ó 0.26 = 5,200 ‚ÇΩ
4. –û–±–Ω–æ–≤–∏ `expected.breakdown.utilization_fee_rub: 5200` –≤ cases.yml
5. –ü–µ—Ä–µ—Å—á–∏—Ç–∞–π `expected.breakdown.total_rub` (–≤—ã—á—Ç–∏ —Å—Ç–∞—Ä—ã–π —É—Ç–∏–ª—å—Å–±–æ—Ä, –ø—Ä–∏–±–∞–≤—å –Ω–æ–≤—ã–π)

### –ü—Ä–æ–±–ª–µ–º–∞: Coverage < 85%
**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ –ø–æ–∫—Ä—ã—Ç—ã error handlers –∏–ª–∏ edge cases

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ù–∞–π–¥–∏ –Ω–µ–ø–æ–∫—Ä—ã—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
pytest tests/ --cov=app --cov-report=term-missing | grep "engine.py"

# –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:
# app/calculation/engine.py   85%   120-125, 180-182

# –û—Ç–∫—Ä–æ–π engine.py, —Å—Ç—Ä–æ–∫–∏ 120-125 ‚Äî —ç—Ç–æ try/except –±–ª–æ–∫
# –î–æ–±–∞–≤—å —Ç–µ—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ:

def test_utilization_fee_missing_volume_band():
    """–¢–µ—Å—Ç –Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –æ–±—ä—ë–º–∞."""
    rates_config = {"utilization_m1_personal": {"base_rate_rub": 20000, "volume_bands": []}}
    fee, coef = _utilization_fee_v2("lt3", 99999, 100, rates_config)
    assert fee == Decimal("0")  # fallback
    assert coef == 0.0
```

### –ü—Ä–æ–±–ª–µ–º–∞: Pytest –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç test_utilization_v2.py
**–ü—Ä–∏—á–∏–Ω–∞:** –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è tests/unit/ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç __init__.py

**–†–µ—à–µ–Ω–∏–µ:**
```bash
mkdir -p tests/unit
touch tests/unit/__init__.py
```

---

## ‚è±Ô∏è –í–†–ï–ú–Ø –í–´–ü–û–õ–ù–ï–ù–ò–Ø
**–û—Ü–µ–Ω–∫–∞:** 3-4 —á–∞—Å–∞

**Breakdown:**
- –ó–∞–¥–∞—á–∞ 8.1: 5 –º–∏–Ω—É—Ç (–∞—Ä—Ö–∏–≤–∞—Ü–∏—è)
- –ó–∞–¥–∞—á–∞ 8.2: 90 –º–∏–Ω—É—Ç (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ 15 –∫–µ–π—Å–æ–≤ —Å –ø–µ—Ä–µ—Å—á—ë—Ç–æ–º expected values)
- –ó–∞–¥–∞—á–∞ 8.3: 60 –º–∏–Ω—É—Ç (—Å–æ–∑–¥–∞–Ω–∏–µ test_utilization_v2.py)
- –ó–∞–¥–∞—á–∞ 8.4: 30 –º–∏–Ω—É—Ç (–ø—Ä–æ–≥–æ–Ω –∏ —Ñ–∏–∫—Å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤)
- –ó–∞–¥–∞—á–∞ 8.5: 20 –º–∏–Ω—É—Ç (coverage check)
- –ó–∞–¥–∞—á–∞ 8.6: 15 –º–∏–Ω—É—Ç (API —Ç–µ—Å—Ç—ã)
- –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: 20 –º–∏–Ω—É—Ç

---

## üìû NEXT STEPS
–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–ø—Ä–∏–Ω—Ç–∞:
1. **–û–±–Ω–æ–≤–∏ rpg.yaml** (–¥–æ–±–∞–≤—å test_status, recent_changes)
2. **–ö–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π:**
   ```bash
   git add tests/ docs/rpg.yaml
   git commit -m "test: update all test cases with engine_power_hp, add unit tests for utilization_v2"
   ```
3. **–ü–µ—Ä–µ—Ö–æ–¥–∏ –∫ –°–ø—Ä–∏–Ω—Ç—É 9** (–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è) ‚Äî —Å–º. `docs/sprint_prompts/SPRINT_9_DOCUMENTATION.md`

---

## üîó –°–í–Ø–ó–ê–ù–ù–´–ï –§–ê–ô–õ–´
- `docs/REFACTORING_PLAN.md` ‚Äî –ø–æ–ª–Ω—ã–π –ø–ª–∞–Ω (–≠—Ç–∞–ø 8)
- `tests/test_data/cases.yml` ‚Äî —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–µ–π—Å—ã (–æ–±–Ω–æ–≤–∏—Ç—å)
- `tests/unit/test_utilization_v2.py` ‚Äî –Ω–æ–≤—ã–π —Ñ–∞–π–ª (—Å–æ–∑–¥–∞—Ç—å)
- `tests/functional/test_engine.py` ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
- `tests/functional/test_api.py` ‚Äî API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
- `app/calculation/engine.py` ‚Äî —Ü–µ–ª–µ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è (_utilization_fee_v2)

---

**–ê–≤—Ç–æ—Ä –ø—Ä–æ–º–ø—Ç–∞:** RPG Architect  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–î–∞—Ç–∞:** 2025-12-08

