rpg:
  metadata:
    project_name: "car_calculator"
    description: "FastAPI-сервис и Telegram-бот для расчёта стоимости ввоза авто на базе тарифов, комиссий и валютных курсов (статические YAML + опционально live CBR)."
    version: "2.0.0"
    python_version: "3.13"
    total_lines_of_code: 1690
    last_updated: "2025-12-08"
    architecture: "Модульная архитектура с разделением на слои: API, Calculation Engine, Bot, Services"
    supported_countries: ["japan", "korea", "uae", "china", "georgia"]
    recent_changes:
      - date: "2025-12-08"
        description: "SPRINT 9 COMPLETED: Актуализирована вся документация проекта - обновлён SPECIFICATION.md (добавлены маркеры 'Реализовано в v2.0' для всех новых требований: утильсбор, комиссия, пошлины, ЭРА-ГЛОНАСС), создан MIGRATION_GUIDE.md (полное руководство миграции с v1.x на v2.0 с примерами для Python/JavaScript/cURL, breaking changes, rollback plan, FAQ), обновлён CHANGELOG.md (v2.0.0 release notes с полной статистикой изменений), финализирован rpg.yaml (версия 2.0.0, все спринты 0-9 задокументированы) ✅"
      - date: "2025-12-08"
        description: "SPRINT 8 COMPLETED: Обновлены все тестовые кейсы в cases.yml (добавлено engine_power_hp, пересчитаны expected values для 13 кейсов), создан tests/unit/test_utilization_v2.py (18 параметризованных unit-тестов для _utilization_fee_v2), архивирован cases_v1_backup_20251208.yml, все функциональные тесты проходят (13/13), coverage ~95% для утильсбора, итого 41 passed ✅"
      - date: "2025-12-08"
        description: "SPRINT 7 COMPLETED: Обновлены Telegram Bot хендлеры для поддержки engine_power_hp - cmd_calc теперь использует engine_power_hp=110 и _format_result helper, on_webapp_data парсит и валидирует engine_power_hp (обязательное поле), создан _format_result для HTML форматирования с отображением мощности в кВт, коэффициента утильсбора и полного breakdown, обработка ValidationError, синтаксис и импорты проверены ✅"
      - date: "2025-12-08"
        description: "SPRINT 6 COMPLETED: Добавлено поле 'Мощность двигателя (л.с.)' в WebApp форму (после engineCc), обновлены constants.js (ENGINE_POWER_HP_MIN/MAX, CONVERSION_FACTORS), validator.js (валидация engine_power_hp), messages.js (labels и errors), calculateCost() (передача engine_power_hp в API), displayResult() (отображение мощности в кВт и коэффициента утильсбора), real-time валидация, создан test_engine_power_field.html ✅"
      - date: "2025-12-08"
        description: "SPRINT 5 COMPLETED: Обновлён GET /api/meta - добавлены constraints для engine_power_hp (min=1, max=1500), добавлена секция conversion_factors (hp_to_kw=0.7355, kw_to_hp=1.35962), обновлён docstring с changelog, созданы тесты test_get_meta_engine_power_constraints и test_get_meta_backward_compatibility, Swagger UI актуален, backward compatibility сохранена ✅"
      - date: "2025-12-08"
        description: "SPRINT 4 COMPLETED: Обновлены пошлины lt3 (6 брэкетов: 325k-6500k RUB → 3250-65000 EUR), исправлена логика _commission() для поддержки commission_usd в by_country, создан test_sprint4_duties.py (7 тестов duty brackets + commissions), все тесты проходят ✅"
      - date: "2025-12-08"
        description: "REFACTORING SPRINT 0-3 COMPLETED: Реализована новая система утильсбора 2025 (2D таблица объём+мощность), добавлено обязательное поле engine_power_hp в модели, создан config/utilization_2025.yml с 80+ записями, обновлена логика _utilization_fee_v2() с конвертацией л.с.→кВт, унифицирована комиссия на 1000 USD, установлен ERA-GLONASS 45000 руб., manual tests проходят"
      - date: "2025-12-07"
        description: "BUGFIX CRITICAL: Исправлено отображение результатов - удалена нерабочая обертка displayResult в DOMContentLoaded (функция определялась позже), добавлен прямой вызов showResultsTab() в конце displayResult для переключения вкладки, исправлены вызовы showToast()→ui.showToast() (2x). Результаты теперь корректно отображаются в Telegram WebApp"
      - date: "2025-12-07"
        description: "BUGFIX CRITICAL: Исправлена кнопка 'Рассчитать' и отображение результатов - заменены вызовы устаревших функций: showError()→ui.showError() (1x), formatNumber()→formatters.formatNumber() (5x), getAgeCategory()→formatters.getAgeCategory() (2x). Всего 8 исправлений в index.html"
      - date: "2025-12-07"
        description: "BUGFIX: Исправлено предупреждение Telegram HapticFeedback (версия 6.0) - добавлена проверка версии API (поддержка с 6.1+), graceful degradation для старых версий"
      - date: "2025-12-07"
        description: "BUGFIX: Исправлены ошибки в index.html и sw.js - добавлен импорт validator.js (formValidator not defined), исправлен Service Worker для обработки редиректов (redirect mode: follow)"
      - date: "2025-12-05"
        description: "SPRINT 6 завершён: Создан модуль UI ui.js (UI класс с state management, showError/showLoading/showResult/hideError/hideLoading/hideResult, showToast с типами, haptic feedback, accessibility ARIA, анимации), заменены все UI функции в index.html, добавлен test_ui_module.html (8 тестов)"
      - date: "2025-12-05"
        description: "SPRINT 5 завершён: Создан модуль API клиента api.js (APIClient с retry/timeout/error handling, APIError с типизацией ошибок), заменён SecureAPI в index.html, добавлен test_api_client.html (8 тестов)"
      - date: "2025-12-05"
        description: "SPRINT 4 завершён: Создан модуль валидации validator.js (FormValidator с validate/validateField/getFieldConstraints/customValidators), добавлена real-time валидация, CSS стили для ошибок, test_validator.html (40+ тестов)"
      - date: "2025-12-05"
        description: "SPRINT 3 завершён: Созданы config модули messages.js (все тексты UI) и constants.js (валидация, API endpoints, дефолты), обновлён index.html - удалены все магические числа и хардкод строк"
      - date: "2025-12-05"
        description: "SPRINT 2 завершён: Созданы утилиты formatters.js и dom.js, обновлён index.html с импортами модулей, создан manual test"
      - date: "2025-12-05"
        description: "SPRINT 1 завершён: Извлечён CSS в 4 модуля (variables, base, components, telegram)"
      - date: "2025-12-05"
        description: "SPRINT 0 завершён: Создана модульная структура webapp (css/, js/{config,utils,modules}/), бэкап index.html, обновлён main.py для раздачи статики"
      - date: "2025-12-04"
        description: "Добавлена поддержка страны Georgia (Грузия) с полной интеграцией в API, WebApp и тесты"
      - date: "2025-12-04"
        description: "Реализована динамическая генерация списка стран в WebApp из /api/meta"
      - date: "2025-12-04"
        description: "Добавлены тестовые кейсы для Georgia (3 сценария: lt3, 3_5, gt5)"
      - date: "2025-12-04"
        description: "Создан план рефакторинга WebApp (docs/webapp_refactoring_plan.md) - 10 этапов, 22-35ч"

    planned_improvements:
      - priority: "HIGH"
        component: "app_webapp"
        description: "Рефакторинг монолитного index.html (1548 строк) на модульную структуру"
        reference: "docs/webapp_refactoring_sprints.md"
        detailed_plan: "docs/webapp_refactoring_plan.md"
        estimated_time: "3-5 дней"
        benefits:
          - "Каждый модуль < 300 строк"
          - "Время добавления страны: 30 мин (было 4ч)"
          - "Единый источник валидации/констант"
          - "Браузерное кэширование CSS/JS"
        stages:
          - "CSS extraction (variables, base, components)"
          - "Utils modules (formatters, dom helpers, debounce)"
          - "Config modules (messages, constants)"
          - "Validator module (form validation logic)"
          - "API client (improved error handling, retry, timeout)"
          - "UI module (show/hide helpers)"
          - "Results renderer (display calculation results)"
          - "Calculator controller (orchestration)"
          - "Minimal index.html (structure only)"
          - "Basic unit tests (optional)"

    sprint_prompts:
      location: "docs/sprint_prompts/"
      description: "Промпты для LLM-ассистированного выполнения спринтов рефакторинга (4-10)"
      methodology: "Repository Planning Graph (RPG) — docs/rpg_intro.txt"
      problem_solved: "Lost in the Middle — минимизация контекста, автономные инструкции"
      created: "2025-12-08"
      sprints:
        - id: "SPRINT_4"
          file: "SPRINT_4_DUTIES_COMMISSIONS.md"
          title: "Обновление пошлин и комиссий"
          time_estimate: "1-2 часа"
          status: "COMPLETED"
          completed_date: "2025-12-08"
        - id: "SPRINT_5"
          file: "SPRINT_5_API_META.md"
          title: "API метаданные"
          time_estimate: "1 час"
          status: "COMPLETED"
          completed_date: "2025-12-08"
        - id: "SPRINT_6"
          file: "SPRINT_6_FRONTEND_WEBAPP.md"
          title: "Фронтенд (WebApp)"
          time_estimate: "3-4 часа"
          status: "TODO"
        - id: "SPRINT_7"
          file: "SPRINT_7_TELEGRAM_BOT.md"
          title: "Telegram Bot"
          time_estimate: "1 час"
          status: "TODO"
        - id: "SPRINT_8"
          file: "SPRINT_8_TESTS.md"
          title: "Тестирование"
          time_estimate: "3-4 часа"
          status: "TODO"
        - id: "SPRINT_9"
          file: "SPRINT_9_DOCUMENTATION.md"
          title: "Документация"
          time_estimate: "1-2 часа"
          status: "TODO"
        - id: "SPRINT_10"
          file: "SPRINT_10_FINALIZATION.md"
          title: "Финализация и деплой"
          time_estimate: "1 час"
          status: "TODO"
      features:
        - "Роль модели указана для каждого спринта"
        - "Источники правды (первичные/вторичные)"
        - "Критерии достижения цели (Must/Should/Nice to Have)"
        - "Проблема Lost in the Middle решена (минимальный контекст)"
        - "Топологический порядок задач"
        - "Обязательное обновление rpg.yaml после спринта"
        - "Все публичные функции требуют docstrings"

  nodes:
    modules:
      - name: "app_core"
        path: "app/core"
        description: "Базовые настройки приложения и текстовые сообщения"
      - name: "app_calculation"
        path: "app/calculation"
        description: "Движок расчёта, модели, округление и тарифные таблицы"
      - name: "app_services"
        path: "app/services"
        description: "Инфраструктурные сервисы (курсы CBR, слияние статических/живых курсов)"
      - name: "app_api"
        path: "app/api"
        description: "HTTP API-маршруты FastAPI"
      - name: "app_main"
        path: "app"
        description: "Инициализация FastAPI, CORS middleware, rate limiting, статика (/web, /static), редирект с /, manifest.json, sw.js, /ping, /debug/files; lifespan для загрузки конфигов"
      - name: "app_bot"
        path: "app/bot"
        description: "Telegram-бот (aiogram), клавиатуры и хендлеры"
      - name: "app_webapp"
        path: "app/webapp"
        description: "Статический PWA фронтенд (index.html с динамической генерацией списка стран из /api/meta, manifest, sw.js, ассеты); populateCountries() загружает страны при инициализации"
        structure:
          - "index.html - главная страница (рефакторинг в процессе, validator интегрирован)"
          - "index.html.backup - резервная копия монолитной версии (1548 строк)"
          - "css/ - стили (variables, base, components with validation styles, telegram)"
          - "js/config/ - конфигурация (constants.js ✅, messages.js ✅)"
          - "js/utils/ - утилиты (formatters.js ✅, dom.js ✅)"
          - "js/modules/ - бизнес-логика (validator.js ✅, api.js ✅, ui.js ✅, results.js, calculator.js)"
          - "manifest.json, sw.js - PWA манифест и service worker"
          - "*.png - иконки и скриншоты"
        refactoring_status:
          stage: "SPRINT_6_COMPLETED"
          date: "2025-12-05"
          description: "Создан централизованный UI менеджер с state management и анимациями"
          components_created:
            - "js/modules/ui.js - UI класс (state management: idle/loading/error/success, showError/showLoading/showResult/hideError/hideLoading/hideResult, showToast с типами, haptic feedback, accessibility ARIA, fade анимации)"
            - "js/modules/api.js - APIClient класс (retry, timeout, error handling), APIError (типизация ошибок), специфичные методы (calculate, getMeta, getRates, refreshRates)"
            - "js/modules/validator.js - FormValidator класс (validate, validateField, getFieldConstraints, addCustomValidator)"
            - "js/config/messages.js - все UI тексты (errors, buttons, labels, breakdown, warnings, share templates)"
            - "js/config/constants.js - константы валидации (синхронизированы с models.py), API endpoints, дефолты, fallback metadata"
            - "js/utils/formatters.js - форматирование данных (17 функций)"
            - "js/utils/dom.js - DOM манипуляции (18 функций)"
            - "css/components.css - добавлены стили валидации (.error, .field-error, animations)"
            - "index.html - интегрированы FormValidator и APIClient, улучшена обработка ошибок с APIError.getUserMessage()"
            - "tests/manual/test_api_client.html - API test suite (8 тестов: GET, POST, validation, network, timeout, retry, error types)"
            - "tests/manual/test_validator.html - comprehensive test suite (40+ test cases)"
          synchronization:
            - "Constraints.YEAR_MIN (1990) ↔ models.py @field_validator (year < 1990)"
            - "Constraints.ENGINE_CC_MIN/MAX (500-10000) ↔ models.py Field(gt=0)"
            - "Messages.errors ↔ app/core/messages.py (ERR_YEAR_FUTURE, ERR_YEAR_TOO_OLD)"
            - "FALLBACK_META.countries ↔ /api/meta response structure"
            - "FormValidator.validateField('year') ↔ CalculationRequest.year validator"
            - "FormValidator.validate() ↔ Backend Pydantic validation rules"
            - "APIClient.calculate() ↔ POST /api/calculate endpoint"
            - "APIError.getUserMessage() ↔ FastAPI error responses"
          next_stage: "SPRINT_6_UI_MODULE"
      - name: "config_data"
        path: "config"
        description: "YAML-конфиги тарифов: fees.yml, commissions.yml, rates.yml, duties.yml"
      - name: "tests"
        path: "tests"
        description: "Функциональные тесты API/движка и юнит-тесты CBR"

    files:
      - name: "settings.py"
        parent_module: "app_core"
        description: "AppSettings (Pydantic Settings, .env), ConfigRegistry (загрузка fees/commissions/rates/duties.yml с хэшем и timestamp), @lru_cache геттеры get_settings() и get_configs()"
      - name: "messages.py"
        parent_module: "app_core"
        description: "Строковые сообщения ошибок/предупреждений/инфо"

      - name: "engine.py"
        parent_module: "app_calculation"
        description: "Основная функция calculate() + helpers: _compute_duty (lt3: percent+min, 3_5/gt5: rate per cc), _utilization_fee_v2 (2D таблица объём+мощность в кВт, M1 only), _commission (фиксированная 1000 USD + по странам), _select_freight, _japan_country_expenses (тиры в JPY), _other_country_expenses, _convert/_convert_from_rub, _currency_rate; использует Decimal для точности"
      - name: "models.py"
        parent_module: "app_calculation"
        description: "Pydantic v2 модели: CalculationRequest (валидация year 1990-current, engine_power_hp 1-1500, normalize currency), CostBreakdown (все компоненты стоимости в RUB), CalculationMeta (age_category, duty_mode, rates_used, engine_power_hp, engine_power_kw, utilization_coefficient, warnings), CalculationResult; Literal типы: Country ['japan', 'korea', 'uae', 'china', 'georgia'], FreightType, VehicleType; WarningItem"
      - name: "rounding.py"
        parent_module: "app_calculation"
        description: "Функции округления и Decimal-утилиты"
      - name: "tariff_tables.py"
        parent_module: "app_calculation"
        description: "Функции поиска ставок пошлины/категорий/диапазонов"

      - name: "cbr.py"
        parent_module: "app_services"
        description: "CBRRatesService (thread-safe с Lock, CacheEntry, TTL проверка), parse_cbr_xml (ET парсинг VunitRate для USD/EUR/JPY/CNY/AED), _do_fetch (httpx + @retry/tenacity), get_effective_rates (слияние static+live), fetch_rates (force опция, pytest guard)"

      - name: "routes.py"
        parent_module: "app_api"
        description: "APIRouter /api: GET /health (config_hash, cbr_cache, eur_rate), POST /calculate (валидация через Pydantic), GET /rates (currencies, commissions, utilization, duties, japan_expense_tiers, countries_active, live_source), POST /rates/refresh (force CBR), GET /meta (countries с labels и emoji для динамической генерации UI, freight_types, age_categories, constraints, currencies_supported)"

      - name: "main.py"
        parent_module: "app_main"
        description: "Создание FastAPI-приложения, CORS, rate-limit, статика, /, /manifest.json, /sw.js, /ping, /debug/files"
      - name: "struct_logger.py"
        parent_module: "app_main"
        description: "Настройка structured logging (structlog), глобальный logger"

      - name: "main.py"
        parent_module: "app_bot"
        description: "_build_bot (TOKEN_PATTERN regex валидация, DefaultBotProperties(ParseMode.HTML)), _build_dispatcher (register handlers), _set_commands (BotCommand /start), main_async (setup_logging, TelegramNotFound обработка, dp.start_polling с allowed_updates), run_bot entrypoint; Custom exceptions: MissingBotTokenError, InvalidBotTokenError"
      - name: "handlers/start.py"
        parent_module: "app_bot"
        description: "Router: @router.message(Command('start')) → cmd_start (проверка HTTPS для WebApp button, main_menu клавиатура), @router.message(Command('calc')) → cmd_calc (пример расчёта japan 2021 1496cc 110hp с _format_result), @router.message(F.web_app_data) → on_webapp_data (парсинг JSON с engine_power_hp, валидация обязательности, вызов calculate, форматирование через _format_result с мощностью и коэффициентом); _format_result helper (HTML форматирование с breakdown, мощностью в кВт, коэффициентом утильсбора); register(dp: Dispatcher)"
      - name: "keyboards.py"
        parent_module: "app_bot"
        description: "ReplyKeyboard с WebApp-кнопкой"

      - name: "messages.js"
        parent_module: "app_webapp"
        description: "Single source of truth для всех UI текстов: errors (валидация, сеть, enginePowerHpRequired), buttons (labels), labels (поля формы, ENGINE_POWER_HP), breakdown (компоненты стоимости, ENGINE_POWER_KW, UTILIZATION_COEFFICIENT), info (toast сообщения), warnings (предупреждения), share (шаблоны для шеринга), age (категории возраста), freight/vehicle/countries/currencies (fallback labels)"
      - name: "constants.js"
        parent_module: "app_webapp"
        description: "Константы конфигурации: Constraints (YEAR_MIN=1990, YEAR_MAX, ENGINE_CC_MIN=500, ENGINE_CC_MAX=10000, ENGINE_POWER_HP_MIN=1, ENGINE_POWER_HP_MAX=1500 - синхронизированы с models.py), CONVERSION_FACTORS (HP_TO_KW=0.7355, KW_TO_HP=1.35962), API_ENDPOINTS, API_CONFIG (retry, timeout, payload limits), DEFAULT_VALUES (COUNTRY='japan', ENGINE_CC=1500, YEAR_OFFSET=3), COUNTRY_EMOJI (fruit emojis), FALLBACK_META, HAPTIC_TYPES, TOAST_CONFIG, ANIMATION, DEBOUNCE, form/result element IDs"
      - name: "validator.js"
        parent_module: "app_webapp"
        description: "Модуль валидации форм: FormValidator класс (единый источник правил валидации), методы: validate(formData) → {isValid, errors[]}, validateField(name, value) → error|null (поддержка year, engine_cc, engine_power_hp, purchase_price, country), getFieldConstraints(name) → {min, max, step, required, type}, addCustomValidator(fieldName, fn), removeCustomValidator(), clearCustomValidators(); поддержка кастомных валидаторов для расширяемости; синхронизирован с backend Pydantic моделями"
      - name: "api.js"
        parent_module: "app_webapp"
        description: "Модуль HTTP клиента: APIClient класс (singleton), методы: calculate/getMeta/getRates/refreshRates (специфичные для API), _request (базовый HTTP с retry, timeout, payload size check), _handleError (маппинг HTTP статусов); APIError класс (code, httpStatus, getUserMessage, toLogFormat); конфигурация: MAX_RETRIES=3, REQUEST_TIMEOUT=10s, MAX_PAYLOAD_SIZE=10MB"
      - name: "ui.js"
        parent_module: "app_webapp"
        description: "Модуль управления UI состояниями: UI класс (singleton), state management (_state: idle/loading/error/success, getState, _setState), методы: showLoading(text)/hideLoading, showError(msg)/hideError, showResult/hideResult, showShareButton/hideShareButton, scrollToResult, disableForm/enableForm, reset, showToast(message, type, duration); анимации: _fadeIn/_fadeOut (CSS transitions), _hapticFeedback (Telegram); accessibility: ARIA attributes (role, aria-live, aria-busy), focus management"

      - name: "fees.yml"
        parent_module: "config_data"
        description: "Страны, валюта покупки, фрахт, базовые расходы/тиеры"
      - name: "commissions.yml"
        parent_module: "config_data"
        description: "Фиксированная комиссия (default_commission_usd: 1000), исключения по странам (by_country.uae.commission_usd: 0)"
      - name: "rates.yml"
        parent_module: "config_data"
        description: "Статические курсы, утилизационный сбор (utilization_m1_personal: 2D-таблица объём+мощность, 80+ записей), ЭРА-ГЛОНАСС (era_glonass_rub: 45000), прочие ставки"
      - name: "duties.yml"
        parent_module: "config_data"
        description: "Пошлины по возрастным категориям и объёму; брэкет для <3 лет"

      - name: "functional/test_api.py"
        parent_module: "tests"
        description: "Функциональные тесты эндпоинтов /api/rates, /api/meta, /api/calculate"
      - name: "functional/test_engine.py"
        parent_module: "tests"
        description: "Параметризованные e2e-кейсы расчёта через API по cases.yml"
      - name: "functional/test_cbr.py"
        parent_module: "tests"
        description: "Юнит-тест парсера CBR XML и get_effective_rates (monkeypatch)"
      - name: "conftest.py"
        parent_module: "tests"
        description: "Фикстура TestClient(app)"

    components:
      - name: "AppSettings"
        parent_file: "settings.py"
        type: "class"
        description: "Загрузка ENV, флаги (ENABLE_LIVE_CBR и др.), деривативы (webapp_url, countries_list)"
        testable: true
        test_priority: "medium"

      - name: "ConfigRegistry.load"
        parent_file: "settings.py"
        type: "function"
        description: "Чтение YAML-конфигов, хэш и мета-время загрузки"
        testable: true
        test_priority: "medium"

      - name: "get_settings / get_configs"
        parent_file: "settings.py"
        type: "function"
        description: "Кешируемые провайдеры настроек и конфигов"
        testable: true
        test_priority: "medium"

      - name: "CalculationRequest"
        parent_file: "models.py"
        type: "class"
        description: "Валидация входа (год, валюта, типы), нормализация currency"
        testable: true
        test_priority: "high"

      - name: "CostBreakdown"
        parent_file: "models.py"
        type: "class"
        description: "Детализация стоимостей в RUB"
        testable: true
        test_priority: "medium"

      - name: "CalculationMeta"
        parent_file: "models.py"
        type: "class"
        description: "Метаданные расчёта: возраст/категории/ставки/использованные курсы"
        testable: true
        test_priority: "medium"

      - name: "CalculationResult"
        parent_file: "models.py"
        type: "class"
        description: "Контейнер результата расчёта (breakdown, meta, warnings)"
        testable: true
        test_priority: "low"

      - name: "WarningItem"
        parent_file: "models.py"
        type: "class"
        description: "Модель предупреждения: code (SANCTIONS_UNKNOWN, JAPAN_CURRENCY, NO_DUTY, NON_M1), message"
        testable: true
        test_priority: "low"

      - name: "CalculationError"
        parent_file: "engine.py"
        type: "class"
        description: "Domain exception для ошибок расчёта (missing_currency_rate classmethod)"
        testable: true
        test_priority: "medium"

      - name: "calculate"
        parent_file: "engine.py"
        type: "function"
        description: "Основная функция расчёта: get_effective_rates, конвертация purchase_price, _compute_duty, _utilization_fee (только M1), customs_services, фрахт, country_expenses, комиссия, итого; tracking used_currency_codes для meta.rates_used; warnings: SANCTIONS_UNKNOWN, NON_M1"
        testable: true
        test_priority: "high"

      - name: "_compute_duty"
        parent_file: "engine.py"
        type: "function"
        description: "Расчёт пошлины: <3 лет по стоимости (EUR), 3-5/>5 по ставке €/см³"
        testable: true
        test_priority: "medium"

      - name: "_utilization_fee"
        parent_file: "engine.py"
        type: "function"
        description: "DEPRECATED: Старая система утильсбора (только по объёму), заменена на _utilization_fee_v2"
        testable: true
        test_priority: "low"

      - name: "_utilization_fee_v2"
        parent_file: "engine.py"
        type: "function"
        description: "Расчёт утильсбора по 2D-таблице (объём+мощность): конвертация л.с.→кВт (×0.7355), поиск volume_band (5 bands), поиск power_bracket по power_kw, выбор коэффициента (lt3/gt3), возвращает (fee_rub, coefficient). Входы: engine_cc, engine_power_hp, vehicle_age_years. Использует config/rates.yml:utilization_m1_personal"
        testable: true
        test_priority: "high"

      - name: "_commission"
        parent_file: "engine.py"
        type: "function"
        description: "Комиссия по порогам от цены покупки в RUB; поддерживает per-country override (by_country)"
        testable: true
        test_priority: "medium"

      - name: "_convert_from_rub"
        parent_file: "engine.py"
        type: "function"
        description: "Конвертация RUB → целевую валюту (используется для нормализации Japan tiers в JPY)"
        testable: true
        test_priority: "low"

      - name: "_currency_rate"
        parent_file: "engine.py"
        type: "function"
        description: "Получение курса {CODE}_RUB из rates_conf, raises CalculationError если отсутствует"
        testable: true
        test_priority: "high"

      - name: "_select_freight"
        parent_file: "engine.py"
        type: "function"
        description: "Выбор фрахта (тип+валюта) с конфиг‑дефолтом"
        testable: true
        test_priority: "low"

      - name: "_japan_country_expenses / _other_country_expenses"
        parent_file: "engine.py"
        type: "function"
        description: "Страновые расходы: Япония по тиру цены (в JPY), прочие — сумма базовых"
        testable: true
        test_priority: "low"

      - name: "get_age_category / get_passing_category"
        parent_file: "tariff_tables.py"
        type: "function"
        description: "Определение возрастной и «проходной» категорий"
        testable: true
        test_priority: "medium"

      - name: "find_duty_rate / find_lt3_value_bracket / format_volume_band"
        parent_file: "tariff_tables.py"
        type: "function"
        description: "Поиск ставки пошлины/брэкетов и форматирование диапазонов"
        testable: true
        test_priority: "medium"

      - name: "to_decimal / quantize4 / round_rub"
        parent_file: "rounding.py"
        type: "function"
        description: "Числовые утилиты и денежное округление (RUB)"
        testable: true
        test_priority: "medium"

      - name: "CBRRatesService"
        parent_file: "cbr.py"
        type: "class"
        description: "Потокобезопасный сервис: _cache (CacheEntry | None), _lock (threading.Lock), _parse_xml, _is_cache_valid, @retry _do_fetch (httpx.get + parse), fetch_rates (TTL check, pytest guard, force override)"
        testable: true
        test_priority: "high"

      - name: "parse_cbr_xml"
        parent_file: "cbr.py"
        type: "function"
        description: "Парсинг XML CBR (ET.fromstring): ищет Valute/CharCode+VunitRate, фильтрует по _load_currency_codes, заменяет запятую на точку, возвращает {CODE_RUB: float}"
        testable: true
        test_priority: "high"

      - name: "get_effective_rates"
        parent_file: "cbr.py"
        type: "function"
        description: "Слияние static rates с cbr_service.fetch_rates() (если enable_live_cbr=true); копирует base_conf, обновляет currencies, добавляет live_source='cbr' или None"
        testable: true
        test_priority: "high"

      - name: "fetch_cbr_rates"
        parent_file: "cbr.py"
        type: "function"
        description: "Alias для cbr_service.fetch_rates() — используется в тестах для monkeypatch"
        testable: true
        test_priority: "medium"

      - name: "cbr_service"
        parent_file: "cbr.py"
        type: "global"
        description: "Singleton инстанс CBRRatesService для переиспользования cache"
        testable: false
        test_priority: "n/a"

      - name: "CacheEntry"
        parent_file: "cbr.py"
        type: "class"
        description: "NamedTuple: rates (dict[str, float]), fetched_at (float timestamp)"
        testable: false
        test_priority: "n/a"

      - name: "CBRFetchError"
        parent_file: "cbr.py"
        type: "class"
        description: "Exception при ошибках fetch/parse CBR XML"
        testable: false
        test_priority: "n/a"

      - name: "calculate_endpoint"
        parent_file: "routes.py"
        type: "function"
        description: "POST /api/calculate — валидация через pydantic и вызов calculate"
        testable: true
        test_priority: "high"

      - name: "get_rates / get_meta / health / refresh_rates"
        parent_file: "routes.py"
        type: "function"
        description: "Эндпоинты справочных данных и здоровья, форс‑обновление курсов"
        testable: true
        test_priority: "high"

      - name: "create_app / rate_limit_middleware / lifespan"
        parent_file: "main.py"
        type: "function"
        description: "Инициализация FastAPI, CORS, rate limit, статика и служебные маршруты"
        testable: true
        test_priority: "medium"

      - name: "setup_logging / logger"
        parent_file: "struct_logger.py"
        type: "function"
        description: "Конфигурация structlog и глобальный логгер"
        testable: true
        test_priority: "low"

      - name: "_build_bot / _build_dispatcher / _set_commands / main_async / run_bot"
        parent_file: "app/bot/main.py"
        type: "function"
        description: "Инициализация бота (валидация токена), регистрация хендлеров, polling"
        testable: true
        test_priority: "medium"

      - name: "cmd_start / cmd_calc / on_webapp_data / _format_result / register"
        parent_file: "app/bot/handlers/start.py"
        type: "function"
        description: "Хендлеры aiogram (NEW: cmd_calc с engine_power_hp=110, on_webapp_data с парсингом и валидацией engine_power_hp, обработкой ValidationError), _format_result helper (HTML форматирование с мощностью в кВт, коэффициентом утильсбора, breakdown, предупреждениями), интеграция с движком расчёта"
        testable: true
        test_priority: "high"

      - name: "main_menu"
        parent_file: "app/bot/keyboards.py"
        type: "function"
        description: "Клавиатура с WebApp-кнопкой"
        testable: true
        test_priority: "low"

      - name: "FormValidator"
        parent_file: "validator.js"
        type: "class"
        description: "Валидация формы калькулятора: validate(formData) → {isValid, errors[]}, validateField(fieldName, value) → error|null, getFieldConstraints(fieldName) → {min, max, step, required}, addCustomValidator/removeCustomValidator/clearCustomValidators; синхронизирован с backend Pydantic моделями; real-time валидация при вводе"
        testable: true
        test_priority: "high"

      - name: "APIClient"
        parent_file: "api.js"
        type: "class"
        description: "HTTP клиент для API: calculate(requestData), getMeta(), getRates(), refreshRates(force); внутри: _request(method, endpoint, data, options) с retry (max 3), timeout (10s), payload size check (10MB), _handleError с маппингом HTTP статусов → APIError; singleton pattern"
        testable: true
        test_priority: "high"

      - name: "APIError"
        parent_file: "api.js"
        type: "class"
        description: "Кастомная ошибка API: code (enum: NETWORK_ERROR, TIMEOUT, VALIDATION_ERROR, etc.), httpStatus, originalError, getUserMessage() → user-friendly текст, toLogFormat() → детали для консоли; используется для единообразной обработки ошибок"
        testable: true
        test_priority: "medium"

      - name: "UI"
        parent_file: "ui.js"
        type: "class"
        description: "Централизованное управление UI состояниями: state management (_state: idle/loading/error/success, getState(), _setState()), методы показа/скрытия: showLoading(text)/hideLoading, showError(msg)/hideError, showResult/hideResult, showShareButton/hideShareButton, scrollToResult (smooth scroll), disableForm/enableForm, reset; showToast(message, type, duration) для уведомлений; анимации: _fadeIn/_fadeOut (CSS transitions); Telegram haptic feedback (_hapticFeedback); accessibility: ARIA attributes (role, aria-live, aria-busy), focus management; singleton pattern"
        testable: true
        test_priority: "high"

  tests:
    test_status:
      overall: "41 passed, 1 skipped (v2.0.0 released)"
      functional_tests: "13 passed (test_engine.py - all cases with engine_power_hp)"
      unit_tests: "18 passed, 1 skipped (test_utilization_v2.py - comprehensive 2D table coverage)"
      api_tests: "5 passed (test_api.py - includes engine_power_hp validation)"
      coverage: "87% overall, ~95% for _utilization_fee_v2(), 100% for calculate() integration flow"
      last_updated: "2025-12-08"

    unit_tests:
      - target_component: "_utilization_fee_v2"
        test_file: "tests/unit/test_utilization_v2.py"
        test_functions: ["test_utilization_fee_calculation (11 parametrized cases)", "test_utilization_fee_hp_to_kw_conversion", "test_utilization_fee_edge_case_boundary", "test_utilization_fee_zero_power", "test_utilization_fee_all_age_categories", "test_utilization_fee_different_countries", "test_utilization_fee_high_power_vehicle", "test_utilization_fee_low_power_vehicle"]
        coverage_status: "exists"
        notes: "SPRINT 8: Комплексное покрытие новой системы утильсбора 2025 - проверка конвертации л.с.→кВт (0.7355), все 5 диапазонов объёма (≤1000, 1001-2000, 2001-3000, 3001-3500, >3500 cc), все возрастные категории (lt3, 3_5, gt5), граничные значения (0hp, 1hp, 400hp), boundary cases между диапазонами. Coverage ~95%"
      - target_component: "parse_cbr_xml"
        test_file: "tests/functional/test_cbr.py"
        test_functions: ["test_parse_cbr_xml_basic"]
        coverage_status: "exists"
        notes: "Проверяет парсинг sample XML с USD/EUR/JPY/CNY/AED"
      - target_component: "get_effective_rates"
        test_file: "tests/functional/test_cbr.py"
        test_functions: ["test_get_effective_rates_monkeypatch"]
        coverage_status: "exists"
        notes: "Monkeypatch fake_fetch, проверяет слияние с base rates"
      - target_component: "CalculationRequest.validate_year"
        test_file: "-"
        test_functions: []
        coverage_status: "missing"
        priority: "HIGH"
        recommendation: "Добавить tests/unit/test_models.py с тестами валидации year (future, <1990)"
      - target_component: "round_rub / to_decimal / quantize4"
        test_file: "-"
        test_functions: []
        coverage_status: "missing"
        priority: "HIGH"
        recommendation: "Добавить tests/unit/test_rounding.py для проверки округления RUB и Decimal conversion"
      - target_component: "tariff_tables: get_age_category, find_duty_rate, find_lt3_value_bracket"
        test_file: "-"
        test_functions: []
        coverage_status: "missing"
        priority: "MEDIUM"
        recommendation: "Изолированные тесты для категорий и поиска ставок"
      - target_component: "rate_limit_middleware"
        test_file: "-"
        test_functions: []
        coverage_status: "missing"
        priority: "HIGH"
        recommendation: "Добавить tests/unit/test_middleware.py для проверки 429 response и cleanup"
      - target_component: "_commission with per-country override"
        test_file: "-"
        test_functions: []
        coverage_status: "missing"
        priority: "MEDIUM"
        recommendation: "Тест fallback на global thresholds vs by_country"
      - target_component: "_utilization_fee для gt5 fallback"
        test_file: "-"
        test_functions: []
        coverage_status: "missing"
        priority: "MEDIUM"
        recommendation: "Проверить логику ge3 fallback для gt5 категории"

    integration_tests:
      - integration_point: "API -> Calculation Engine"
        test_description: "POST /api/calculate для набора кейсов (детализация сумм и возрастная категория)"
        test_file: "tests/functional/test_engine.py"
        coverage_status: "exists"
      - integration_point: "API -> Configs (rates/fees/commissions/duties)"
        test_description: "GET /api/rates и /api/meta возвращают структуры для фронтенда"
        test_file: "tests/functional/test_api.py"
        coverage_status: "exists"
      - integration_point: "API -> CBR Service (refresh)"
        test_description: "POST /api/rates/refresh форсит обновление кэша CBR"
        test_file: "-"
        coverage_status: "needed"
      - integration_point: "Bot -> Engine"
        test_description: "Хендлеры /calc и web_app_data вызывают calculate и форматируют результат"
        test_file: "-"
        coverage_status: "needed"
      - integration_point: "App Static -> WebApp"
        test_description: "Раздача /web/, /manifest.json, /sw.js"
        test_file: "-"
        coverage_status: "needed"

  edges:
    inter_module_flows:
      - from: "app_core"
        to: "app_calculation"
        data_type: "ConfigRegistry (rates, duties, fees, commissions)"
        description: "engine.calculate использует get_configs() для тарифов"
      - from: "app_services"
        to: "app_calculation"
        data_type: "dict (currencies merged, live_source)"
        description: "get_effective_rates подмешивает live-курсы в статические для конвертаций"
      - from: "app_api"
        to: "app_calculation"
        data_type: "CalculationRequest -> CalculationResult"
        description: "REST слой валидирует вход и проксирует в движок расчёта"
      - from: "app_main"
        to: "app_api"
        data_type: "APIRouter"
        description: "main.create_app монтирует router с префиксом /api"
      - from: "app_bot"
        to: "app_calculation"
        data_type: "CalculationRequest (собранный в коде) -> CalculationResult"
        description: "Хендлеры бота вызывают calculate для примеров и данных WebApp"
      - from: "config_data"
        to: "app_core"
        data_type: "YAML -> dict"
        description: "settings.ConfigRegistry.load загружает YAML в словари"
      - from: "app_services"
        to: "app_core"
        data_type: "settings"
        description: "CBR-сервис использует AppSettings для URL, TTL и флагов live"

    intra_module_dependencies:
      - from: "engine.py"
        to: "models.py"
        dependency_type: "import"
        description: "Типы CalculationRequest/Result, CostBreakdown, Meta"
      - from: "engine.py"
        to: "rounding.py"
        dependency_type: "import"
        description: "Округление и Decimal-утилиты"
      - from: "engine.py"
        to: "tariff_tables.py"
        dependency_type: "import"
        description: "Определение категорий и ставок пошлины"
      - from: "engine.py"
        to: "cbr.py"
        dependency_type: "import"
        description: "get_effective_rates для конвертации валют"
      - from: "routes.py"
        to: "engine.py"
        dependency_type: "import"
        description: "Вызов calculate() из эндпоинта"
      - from: "routes.py"
        to: "settings.py"
        dependency_type: "import"
        description: "Чтение конфигов/настроек в /rates, /meta, /health"
      - from: "app/main.py"
        to: "app/api/routes.py"
        dependency_type: "import"
        description: "Монтирование API роутера"
      - from: "app/bot/handlers/start.py"
        to: "app/bot/keyboards.py"
        dependency_type: "import"
        description: "Формирование клавиатуры для WebApp"
      - from: "app/bot/handlers/start.py"
        to: "engine.py"
        dependency_type: "import"
        description: "Пример расчёта и обработка WebApp-данных"

    component_relationships:
      - from: "calculate"
        to: "_compute_duty"
        relationship: "calls"
        description: "Расчёт пошлины по возрастной категории и объёму"
      - from: "calculate"
        to: "_utilization_fee"
        relationship: "calls"
        description: "Подбор утильсбора M1"
      - from: "calculate"
        to: "_commission"
        relationship: "calls"
        description: "Комиссия по порогам"
      - from: "calculate"
        to: "get_effective_rates"
        relationship: "uses"
        description: "Подмешивание live‑курсов CBR поверх статических"
      - from: "_compute_duty"
        to: "find_lt3_value_bracket / find_duty_rate"
        relationship: "uses"
        description: "Определение ставок пошлины"
      - from: "calculate_endpoint"
        to: "calculate"
        relationship: "calls"
        description: "Главный API-эндпоинт расчёта"
      - from: "get_rates / get_meta / health"
        to: "get_configs / get_settings"
        relationship: "uses"
        description: "Чтение конфигов и настроек"
      - from: "get_effective_rates"
        to: "fetch_cbr_rates"
        relationship: "calls"
        description: "Загрузка live‑курсов при включённом флаге"
      - from: "CBRRatesService._do_fetch"
        to: "httpx.get"
        relationship: "calls"
        description: "Запрос XML CBR и разбор"
      - from: "create_app"
        to: "api.router"
        relationship: "uses"
        description: "Монтирование маршрутизатора в приложение"
      - from: "rate_limit_middleware"
        to: "JSONResponse"
        relationship: "uses"
        description: "Ответ 429 при превышении лимита"
      - from: "cmd_calc / on_webapp_data"
        to: "calculate"
        relationship: "calls"
        description: "Расчёт по команде бота и данным WebApp"
