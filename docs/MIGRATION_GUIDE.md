# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ v2.0

**–î–∞—Ç–∞ —Ä–µ–ª–∏–∑–∞:** 2025-12-08  
**–í–µ—Ä—Å–∏—è:** 2.0.0  
**Breaking Changes:** –î–ê (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ engine_power_hp)

---

## üéØ –ß—Ç–æ –Ω–æ–≤–æ–≥–æ –≤ v2.0

### 1. –ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —É—Ç–∏–ª–∏–∑–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Å–±–æ—Ä–∞
- **2D-—Ç–∞–±–ª–∏—Ü–∞** (–æ–±—ä—ë–º –¥–≤–∏–≥–∞—Ç–µ–ª—è + –º–æ—â–Ω–æ—Å—Ç—å –≤ –∫–í—Ç)
- **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ:** `engine_power_hp` (1-1500 –ª.—Å.)
- **–ë–∞–∑–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞:** 20,000 —Ä—É–±. √ó –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∏–∑ —Ç–∞–±–ª–∏—Ü—ã

### 2. –ï–¥–∏–Ω–∞—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è
- **1000 USD** –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω (–±—ã–ª–æ: –≥—Ä–∞–¥–∞—Ü–∏—è –ø–æ –ø–æ—Ä–æ–≥–∞–º)
- **–ò—Å–∫–ª—é—á–µ–Ω–∏–µ:** –û–ê–≠ = 0 USD

### 3. –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã 2025
- –≠–†–ê-–ì–õ–û–ù–ê–°–°: 45,000 —Ä—É–±.
- –ü–æ—à–ª–∏–Ω—ã lt3: –Ω–æ–≤—ã–µ –±—Ä—ç–∫–µ—Ç—ã (325k-6500k RUB)

---

## üö® Breaking Changes

### API Endpoints

#### POST /api/calculate

**–ë–´–õ–û (v1.x):**
```json
{
  "country": "japan",
  "year": 2022,
  "engine_cc": 1500,
  "purchase_price": 2500000,
  "currency": "JPY"
}
```

**–°–¢–ê–õ–û (v2.0):**
```json
{
  "country": "japan",
  "year": 2022,
  "engine_cc": 1500,
  "engine_power_hp": 110,
  "purchase_price": 2500000,
  "currency": "JPY"
}
```

**–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø–æ–ª—è:**
```json
{
  "detail": [
    {
      "loc": ["body", "engine_power_hp"],
      "msg": "field required",
      "type": "value_error.missing"
    }
  ]
}
```

---

#### Response Structure Changes

**–ù–æ–≤—ã–µ –ø–æ–ª—è –≤ `meta`:**
```json
{
  "meta": {
    "engine_power_hp": 110,
    "engine_power_kw": 80.91,
    "utilization_coefficient": 0.26
  }
}
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `breakdown`:**
- `utilization_fee_rub` ‚Äî —Ç–µ–ø–µ—Ä—å —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø–æ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ (–∑–Ω–∞—á–µ–Ω–∏—è –∏–∑–º–µ–Ω–∏–ª–∏—Å—å)
- `company_commission_rub` ‚Äî —Ç–µ–ø–µ—Ä—å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞–≤–∫–∞ 1000 USD
- `era_glonass_rub` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–æ –¥–æ 45,000 —Ä—É–±.

---

### Configuration Files

#### config/rates.yml

**–î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è —Å–µ–∫—Ü–∏—è:**
```yaml
utilization_m1_personal:
  base_rate_rub: 20000
  volume_bands:
    - volume_range: [0, 1000]
      power_brackets:
        - {power_kw_max: 51.48, coefficient_lt3: 0.17, coefficient_gt3: 0.26}
        # ...80+ –∑–∞–ø–∏—Å–µ–π
```

**–û–±–Ω–æ–≤–ª–µ–Ω–æ:**
```yaml
era_glonass_rub: 45000  # –±—ã–ª–æ: 0 –∏–ª–∏ —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
```

#### config/commissions.yml

**–ë–´–õ–û:**
```yaml
thresholds:
  - max_price: 1500000
    amount: 40000
  - max_price: 3000000
    amount: 60000
  # ...
```

**–°–¢–ê–õ–û:**
```yaml
default_commission_usd: 1000

by_country:
  uae:
    commission_usd: 0
```

---

## üìã –ß–µ–∫–ª–∏—Å—Ç –º–∏–≥—Ä–∞—Ü–∏–∏

### –î–ª—è Backend —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

- [ ] **–û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞ API:**
  - –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `engine_power_hp` –≤–æ –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∫ `/api/calculate`
  - –û–±–Ω–æ–≤–∏—Ç—å —Ç–∏–ø—ã (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è TypeScript/Pydantic)
  
- [ ] **–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è –≤ response:**
  - `meta.engine_power_hp`, `meta.engine_power_kw`, `meta.utilization_coefficient`
  
- [ ] **–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –æ–∂–∏–¥–∞–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ —Ç–µ—Å—Ç–∞—Ö:**
  - –£—Ç–∏–ª–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–π —Å–±–æ—Ä –∏–∑–º–µ–Ω–∏–ª—Å—è (–Ω–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞)
  - –ö–æ–º–∏—Å—Å–∏—è –∏–∑–º–µ–Ω–∏–ª–∞—Å—å (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞–≤–∫–∞)
  
- [ ] **–û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
  - –î–æ–±–∞–≤–∏—Ç—å `config/rates.yml` (–Ω–æ–≤–∞—è —Å–µ–∫—Ü–∏—è utilization)
  - –û–±–Ω–æ–≤–∏—Ç—å `config/commissions.yml` (–Ω–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)

### –î–ª—è Frontend —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

- [ ] **–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ –≤ —Ñ–æ—Ä–º—É:**
  ```html
  <input type="number" name="enginePowerHp" min="1" max="1500" required>
  ```
  
- [ ] **–û–±–Ω–æ–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é:**
  ```javascript
  if (!enginePowerHp || enginePowerHp < 1 || enginePowerHp > 1500) {
    showError('–í–≤–µ–¥–∏—Ç–µ –º–æ—â–Ω–æ—Å—Ç—å –¥–≤–∏–≥–∞—Ç–µ–ª—è (1-1500 –ª.—Å.)');
  }
  ```
  
- [ ] **–û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ:**
  ```javascript
  –ú–æ—â–Ω–æ—Å—Ç—å: ${result.meta.engine_power_hp} –ª.—Å. (${result.meta.engine_power_kw} –∫–í—Ç)
  –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É—Ç–∏–ª—å—Å–±–æ—Ä–∞: ${result.meta.utilization_coefficient}
  ```

### –î–ª—è DevOps

- [ ] **–ë—ç–∫–∞–ø —Ç–µ–∫—É—â–∏—Ö –∫–æ–Ω—Ñ–∏–≥–æ–≤:**
  ```bash
  cp config/rates.yml config/rates_v1_backup.yml
  cp config/commissions.yml config/commissions_v1_backup.yml
  ```
  
- [ ] **–î–µ–ø–ª–æ–π –Ω–æ–≤—ã—Ö –∫–æ–Ω—Ñ–∏–≥–æ–≤:**
  ```bash
  # –ü—Ä–æ–≤–µ—Ä–∫–∞ YAML –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏
  yamllint config/*.yml
  
  # –î–µ–ø–ª–æ–π
  rsync -avz config/ production:/app/config/
  ```
  
- [ ] **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:**
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –Ω–∞ –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
  - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ response time (–¥–æ–ª–∂–Ω–æ –æ—Å—Ç–∞—Ç—å—Å—è < 200ms)
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç—Ä–∏–∫: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ 422 –æ—à–∏–±–æ–∫ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 0 –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤)

---

## üîÑ Rollback Plan

### –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:

**1. –ë—ã—Å—Ç—Ä—ã–π –æ—Ç–∫–∞—Ç –∫–æ–Ω—Ñ–∏–≥–æ–≤ (5 –º–∏–Ω—É—Ç):**
```bash
# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏
cp config/rates_v1_backup.yml config/rates.yml
cp config/commissions_v1_backup.yml config/commissions.yml

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å
systemctl restart car_calculator
```

**2. –û—Ç–∫–∞—Ç –∫–æ–¥–∞ (10 –º–∏–Ω—É—Ç):**
```bash
# –û—Ç–∫–∞—Ç–∏—Ç—å –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–µ–ª–∏–∑
git revert --no-commit HEAD~20..HEAD
git commit -m "revert: rollback to v1.x due to production issues"
git push origin main

# –î–µ–ø–ª–æ–π
./scripts/deploy.sh
```

**3. –û—Ç–∫–∞—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å –º–∏–≥—Ä–∞—Ü–∏—è):**
```sql
-- –í–µ—Ä–Ω—É—Ç—å engine_power_hp –≤ nullable (–µ—Å–ª–∏ —Ö—Ä–∞–Ω–∏–ª–∏ –≤ –ë–î)
ALTER TABLE calculations ALTER COLUMN engine_power_hp DROP NOT NULL;
```

---

## üßæ –ú–∏–≥—Ä–∞—Ü–∏—è –∫–æ–º–∏—Å—Å–∏–π: thresholds ‚Üí fixed USD ‚Üí bank_commission

### –≠—Ç–∞–ø 0 ‚Äî Legacy v1: –ø–æ—Ä–æ–≥–∏ –≤ RUB (`thresholds`)

–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏ –∫–æ–º–∏—Å—Å–∏—è –∑–∞–¥–∞–≤–∞–ª–∞—Å—å —á–µ—Ä–µ–∑ —Å–ø–∏—Å–æ–∫ –ø–æ—Ä–æ–≥–æ–≤ –≤ —Ä—É–±–ª—è—Ö –≤ `config/commissions.yml`:

```yaml
thresholds:
  - max_price: 1500000
    amount: 40000
  - max_price: 3000000
    amount: 60000
  # ...
```

- –õ–æ–≥–∏–∫–∞: –≤—ã–±–æ—Ä —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—É–º–º—ã RUB –ø–æ –ø–æ—Ä–æ–≥—É —Å—Ç–æ–∏–º–æ—Å—Ç–∏.
- –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏: —Å–ª–æ–∂–Ω–µ–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å, –∑–∞–≤—è–∑–∫–∞ –Ω–∞ –∫—É—Ä—Å—ã, —Ö—É–∂–µ —á–∏—Ç–∞–µ–º–æ—Å—Ç—å –¥–ª—è –±–∏–∑–Ω–µ—Å–∞.
- –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã: `config/commissions_v1_backup_20251208.yml`.

### –≠—Ç–∞–ø 1 ‚Äî v2 –±–µ–∑ –±–∞–Ω–∫–∞: —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è –∫–æ–º–ø–∞–Ω–∏–∏ –≤ USD

–¶–µ–ª–µ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç v2 (—É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ä–∞–Ω—Ç–∞–π–º–µ):

```yaml
default_commission_usd: 1000

by_country:
  uae:
    commission_usd: 0
```

- –î–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω, –∫—Ä–æ–º–µ –û–ê–≠, –∫–æ–º–∏—Å—Å–∏—è –∫–æ–º–ø–∞–Ω–∏–∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞: **1000 USD**.
- –î–ª—è `uae` –∫–æ–º–∏—Å—Å–∏—è –≤—Å–µ–≥–¥–∞ 0 USD (–∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç, –ø–æ–∫—Ä—ã—Ç—ã–π —Ç–µ—Å—Ç–∞–º–∏).
- –ö–æ–º–∏—Å—Å–∏—è –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤ `company_commission_rub` –ø–æ –∫—É—Ä—Å—É USD/RUB (—Å —É—á—ë—Ç–æ–º `bank_commission`, –µ—Å–ª–∏ –æ–Ω –≤–∫–ª—é—á—ë–Ω).

**–®–∞–≥–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞ —Å thresholds:**

1. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª –∫–∞–∫ –±—ç–∫–∞–ø (–µ—Å–ª–∏ –µ—â—ë –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω):
   ```bash
   cp config/commissions.yml config/commissions_v1_backup_$(date +%Y%m%d).yml
   ```
2. –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å `config/commissions.yml` –≤ v2‚Äë—Ñ–æ—Ä–º–∞—Ç (`default_commission_usd` + `by_country`), –æ–ø–∏—Ä–∞—è—Å—å –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –¢–ó –∏ –ø—Ä–∏–º–µ—Ä –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.
3. –û–±–Ω–æ–≤–∏—Ç—å –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã, –µ—Å–ª–∏ –≤ –ø—Ä–æ–µ–∫—Ç–µ –µ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä—É–±–ª—ë–≤—ã–µ —Å—É–º–º—ã –∫–æ–º–∏—Å—Å–∏–∏ (—Å–º. `tests/functional/test_api.py`, `test_sprint4_duties.py`).
4. –ü—Ä–æ–≥–Ω–∞—Ç—å —Ç–µ—Å—Ç—ã:
   ```bash
   poetry run pytest tests/functional/test_api.py
   ```

### –≠—Ç–∞–ø 2 ‚Äî v2 + bank_commission: –Ω–∞–¥–±–∞–≤–∫–∞ –∫ –∫—É—Ä—Å—É

–í—Ç–æ—Ä–æ–π —à–∞–≥ ‚Äî –≤–∫–ª—é—á–µ–Ω–∏–µ `bank_commission` –∫–∞–∫ –Ω–∞–¥–±–∞–≤–∫–∏ –∫ –∫—É—Ä—Å—É, –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ API.

**–ù–æ–≤—ã–π –±–ª–æ–∫ –≤ `config/commissions.yml`:**

```yaml
bank_commission:
  enabled: false
  percent: 0.0
  meta:
    recommended_min: 0.0
    recommended_max: 10.0
    warn_above: 10.0
    default_percent: 0.0
```

–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

- `0‚Äì10%` ‚Äî ¬´–∑–µ–ª—ë–Ω—ã–π¬ª –¥–∏–∞–ø–∞–∑–æ–Ω (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π, –±–µ–∑ –∂—ë—Å—Ç–∫–∏—Ö –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –≤ –∫–æ–¥–µ).
- `>10%` ‚Äî –¥–æ–ø—É—Å—Ç–∏–º–æ, –Ω–æ –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏ (–ª–æ–≥–∞–º–∏/–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π; warning‚Äë–∫–æ–¥ –≤ –¥–≤–∏–∂–∫–µ –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω).

**–ö–∞–∫ —ç—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–∞—Å—á—ë—Ç—ã:**

- –ú–µ–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤–∞–ª—é—Ç–Ω–æ‚Äë–∑–∞–≤–∏—Å–∏–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (`purchase_price_rub`, `country_expenses_rub`, `freight_rub`, `company_commission_rub`) –∏, –∫–∞–∫ —Å–ª–µ–¥—Å—Ç–≤–∏–µ, `breakdown.total_rub`.
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ `breakdown` –∏ –≤—ã–±–æ—Ä duty/age –Ω–µ –º–µ–Ω—è—é—Ç—Å—è.
- –í `meta.rates_used`/`meta.detailed_rates_used` –ø–æ—è–≤–ª—è–µ—Ç—Å—è –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞–¥–±–∞–≤–∫–∏ (`display: "USD/RUB = BASE [+ P%]"`).

### –ü–æ—à–∞–≥–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ bank_commission

#### –î–ª—è Backend

1. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∫–æ–¥ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏:
   - `app/calculation/engine.py` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `_get_bank_commission_percent`, `_effective_currency_rate`, `_convert`, `_commission`.
   - `CalculationMeta` —Å–æ–¥–µ—Ä–∂–∏—Ç `rates_used` –∏ `detailed_rates_used` (—Å–º. `app/calculation/models.py`).
2. –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏ (—É–∂–µ –µ—Å—Ç—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏):
   - `tests/test_data/config/commissions_company_only.yml` ‚Äî baseline –±–µ–∑ `bank_commission`.
   - `tests/test_data/config/commissions_with_bank.yml` ‚Äî –ø—Ä–æ—Ñ–∏–ª—å —Å –≤–∫–ª—é—á—ë–Ω–Ω–æ–π `bank_commission`.
3. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã –æ—Ç—Ä–∞–∂–∞—é—Ç –æ–±–∞ —Ä–µ–∂–∏–º–∞:
   - `tests/functional/test_api_bank_commission.py` ‚Äî —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –±–µ–∑/—Å –∫–æ–º–∏—Å—Å–∏–µ–π.
   - –†–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã `/api/calculate` –±–µ–∑ –±–∞–Ω–∫–∞ (–≤ `tests/functional/test_api.py`, `tests/functional/test_engine.py`) –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç—å.
4. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–æ–±–∞–≤–∏—Ç—å –∏–ª–∏ –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å unit‚Äë—Ç–µ—Å—Ç—ã –¥–ª—è:
   - `_get_bank_commission_percent`, `_effective_currency_rate`, `_convert`, `_commission` –≤ `tests/unit/test_engine_bank_commission.py`.

#### –î–ª—è QA

1. –°–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å –Ω–∞–±–æ—Ä —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤:
   - –ë–∞–∑–æ–≤—ã–π –∫–µ–π—Å –±–µ–∑ –±–∞–Ω–∫–∞: `commissions_company_only.yml` + —Ç–∏–ø–æ–≤–æ–π –∑–∞–ø—Ä–æ—Å `/api/calculate`.
   - –¢–æ—Ç –∂–µ –∫–µ–π—Å —Å –±–∞–Ω–∫–æ–º: `commissions_with_bank.yml` —Å –º–∞–ª—ã–º –ø—Ä–æ—Ü–µ–Ω—Ç–æ–º (1‚Äì2%).
   - –í—ã—Å–æ–∫–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, 15%) ‚Äî –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–æ–Ω–æ—Ç–æ–Ω–Ω–æ—Å—Ç–∏ —Ä–æ—Å—Ç–∞ `total_rub` –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è `display`.
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã:
   - –ü—Ä–∏ –æ—Ç–∫–ª—é—á—ë–Ω–Ω–æ–º –±–∞–Ω–∫–µ (`enabled=false` –∏–ª–∏ —Å–µ–∫—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç) –ø–æ–≤–µ–¥–µ–Ω–∏–µ –∏–¥–µ–Ω—Ç–∏—á–Ω–æ —Å—Ç–∞—Ä–æ–º—É (–±–µ–∑ –±–∞–Ω–∫–∞).
   - –ü—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ `percent` –ø—Ä–∏ –ø—Ä–æ—á–∏—Ö —Ä–∞–≤–Ω—ã—Ö `total_rub` –º–æ–Ω–æ—Ç–æ–Ω–Ω–æ —Ä–∞—Å—Ç—ë—Ç.
   - –î–ª—è `uae` `company_commission_rub` –æ—Å—Ç–∞—ë—Ç—Å—è 0 –ø—Ä–∏ –ª—é–±—ã—Ö –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö, –Ω–æ `total_rub` –º–æ–∂–µ—Ç —Ä–∞—Å—Ç–∏ –∏–∑‚Äë–∑–∞ –¥—Ä—É–≥–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–æ—Ç–æ–≤—ã–µ —Ç–µ—Å—Ç—ã –∫–∞–∫ –æ–ø–æ—Ä–Ω—ã–µ:
   - `tests/functional/test_api_bank_commission.py`.
   - `tests/unit/test_engine_bank_commission.py`.

#### –î–ª—è DevOps

1. **–ë—ç–∫–∞–ø —Ç–µ–∫—É—â–∏—Ö –∫–æ–Ω—Ñ–∏–≥–æ–≤:**
   ```bash
   cp config/commissions.yml config/commissions_backup_$(date +%Y%m%d).yml
   ```
2. **–í–∫–ª—é—á–µ–Ω–∏–µ bank_commission –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏:**
   - –ù–∞ –ø–µ—Ä–≤–æ–º —ç—Ç–∞–ø–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤–∫–ª—é—á–∞—Ç—å –∫–æ–º–∏—Å—Å–∏—é –ø–æ—ç—Ç–∞–ø–Ω–æ:
     - Stage: `enabled: true`, `percent: 0.0` (–ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –ª–æ–≥–∏–∫–∞ –Ω–µ –ª–æ–º–∞–µ—Ç—Å—è –ø—Ä–∏ –≤–∫–ª—é—á—ë–Ω–Ω–æ–π —Å–µ–∫—Ü–∏–∏).
     - –ó–∞—Ç–µ–º –ø–æ–¥–Ω—è—Ç—å –¥–æ 1‚Äì2% –∏ –∑–∞–º–µ—Ä–∏—Ç—å –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –∏—Ç–æ–≥–æ–≤—ã–µ —Å—É–º–º—ã.
3. **–î–µ–ø–ª–æ–π –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞:**
   - –ü—Ä–∏–º–µ–Ω–∏—Ç—å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π `config/commissions.yml`.
   - –ü—Ä–æ–≥–Ω–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ç–∏–≤ staging‚Äë–æ–∫—Ä—É–∂–µ–Ω–∏—è (–º–∏–Ω–∏–º—É–º: —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏–∑ `tests/functional/test_api_bank_commission.py`).
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ª–æ–≥–∏/–º–µ—Ç—Ä–∏–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ—Å–ª–µ –≤–∫–ª—é—á–µ–Ω–∏—è –Ω–µ–Ω—É–ª–µ–≤–æ–π –∫–æ–º–∏—Å—Å–∏–∏.

### –†–µ–∂–∏–º—ã —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

- **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–≤–µ–¥–µ–Ω–∏—è —Å—Ç–∞—Ä–æ–≥–æ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞:**
  - –ù–µ –¥–æ–±–∞–≤–ª—è—Ç—å —Å–µ–∫—Ü–∏—é `bank_commission` –∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å `enabled: false`/`percent: 0.0`.
  - –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –≤—Å–µ –∫—É—Ä—Å—ã –∏ —Å—É–º–º—ã —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å —Ä–µ–∂–∏–º–æ–º ¬´–±–µ–∑ –±–∞–Ω–∫–∞¬ª.
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ:**
  - –ù–∞—á–∞—Ç—å —Å –º–∞–ª–æ–≥–æ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ (1‚Äì2%), —Å–≤–µ—Ä–∏–≤ —Ä–∞–∑–Ω–∏—Ü—É `total_rub` –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–∏–ø–æ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤.
  - –û–ø–∏—Ä–∞—Ç—å—Å—è –Ω–∞ –≥–æ—Ç–æ–≤—ã–µ —Ç–µ—Å—Ç—ã –∫–∞–∫ –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã.

---

## üìä –ü—Ä–∏–º–µ—Ä—ã –º–∏–≥—Ä–∞—Ü–∏–∏

### Python (requests)

**–ë–´–õ–û:**
```python
import requests

response = requests.post("https://api.example.com/api/calculate", json={
    "country": "japan",
    "year": 2022,
    "engine_cc": 1500,
    "purchase_price": 2500000,
    "currency": "JPY"
})
```

**–°–¢–ê–õ–û:**
```python
import requests

response = requests.post("https://api.example.com/api/calculate", json={
    "country": "japan",
    "year": 2022,
    "engine_cc": 1500,
    "engine_power_hp": 110,  # NEW: –¥–æ–±–∞–≤–∏—Ç—å
    "purchase_price": 2500000,
    "currency": "JPY"
})

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π
result = response.json()
print(f"–ú–æ—â–Ω–æ—Å—Ç—å: {result['meta']['engine_power_hp']} –ª.—Å.")
print(f"–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç: {result['meta']['utilization_coefficient']}")
```

### JavaScript (fetch)

**–ë–´–õ–û:**
```javascript
const response = await fetch('/api/calculate', {
  method: 'POST',
  body: JSON.stringify({
    country: 'japan',
    year: 2022,
    engine_cc: 1500,
    purchase_price: 2500000,
    currency: 'JPY'
  })
});
```

**–°–¢–ê–õ–û:**
```javascript
const response = await fetch('/api/calculate', {
  method: 'POST',
  body: JSON.stringify({
    country: 'japan',
    year: 2022,
    engine_cc: 1500,
    engine_power_hp: 110,  // NEW
    purchase_price: 2500000,
    currency: 'JPY'
  })
});

const result = await response.json();
console.log(`–ú–æ—â–Ω–æ—Å—Ç—å: ${result.meta.engine_power_hp} –ª.—Å.`);
console.log(`–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç: ${result.meta.utilization_coefficient}`);
```

### cURL

**–ë–´–õ–û:**
```bash
curl -X POST "https://api.example.com/api/calculate" \
  -H "Content-Type: application/json" \
  -d '{
    "country": "japan",
    "year": 2022,
    "engine_cc": 1500,
    "purchase_price": 2500000,
    "currency": "JPY"
  }'
```

**–°–¢–ê–õ–û:**
```bash
curl -X POST "https://api.example.com/api/calculate" \
  -H "Content-Type: application/json" \
  -d '{
    "country": "japan",
    "year": 2022,
    "engine_cc": 1500,
    "engine_power_hp": 110,
    "purchase_price": 2500000,
    "currency": "JPY"
  }'
```

---

## ‚ùì FAQ

### Q: –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ª–∏ —É–∫–∞–∑—ã–≤–∞—Ç—å engine_power_hp?
**A:** –î–∞, —ç—Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ —Å –≤–µ—Ä—Å–∏–∏ 2.0. –ë–µ–∑ –Ω–µ–≥–æ API –≤–µ—Ä–Ω—ë—Ç –æ—à–∏–±–∫—É 422.

### Q: –ì–¥–µ –≤–∑—è—Ç—å –º–æ—â–Ω–æ—Å—Ç—å –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö?
**A:** –¢–∏–ø–∏—á–Ω—ã–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è:
- 1000-1500 cc ‚Üí 70-110 –ª.—Å.
- 1500-2000 cc ‚Üí 110-150 –ª.—Å.
- 2000-3000 cc ‚Üí 150-250 –ª.—Å.

–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—å–Ω—ã–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ (specifications –ø–æ VIN).

### Q: –ò–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ —É—Ç–∏–ª–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–π —Å–±–æ—Ä –¥–ª—è –º–æ–µ–≥–æ –∞–≤—Ç–æ?
**A:** –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –¥–∞. –ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —É—á–∏—Ç—ã–≤–∞–µ—Ç –º–æ—â–Ω–æ—Å—Ç—å, –ø–æ—ç—Ç–æ–º—É –¥–∞–∂–µ –ø—Ä–∏ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–º –æ–±—ä—ë–º–µ —Å—É–º–º–∞ –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è.

### Q: –ú–æ–∂–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞—Ä–æ–µ API?
**A:** –ù–µ—Ç, v1.x API —Å–Ω—è—Ç —Å –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å 2025-12-08. –í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã –¥–æ–ª–∂–Ω—ã –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ v2.0.

### Q: –ö–∞–∫–æ–π grace period –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏?
**A:** –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è. –ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.

### Q: –ö–∞–∫ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –º–æ—â–Ω–æ—Å—Ç—å –∏–∑ –ª.—Å. –≤ –∫–í—Ç?
**A:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç 0.7355: `kW = HP √ó 0.7355`

### Q: –ß—Ç–æ –µ—Å–ª–∏ –º–Ω–µ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∫–í—Ç –æ–±—Ä–∞—Ç–Ω–æ –≤ –ª.—Å.?
**A:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–±—Ä–∞—Ç–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç 1.35962: `HP = kW √ó 1.35962`

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

**–í–æ–ø—Ä–æ—Å—ã –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏:**  
- Email: support@example.com
- Telegram: @support_bot
- GitHub Issues: https://github.com/your-repo/issues

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**  
- API Docs: https://api.example.com/docs
- Changelog: [CHANGELOG.md](../CHANGELOG.md)
- Specification: [SPECIFICATION.md](./SPECIFICATION.md)
- API Result Flow: [API_RESULT_FLOW.md](./API_RESULT_FLOW.md)

---

## üìö –°–º. —Ç–∞–∫–∂–µ

- [SPECIFICATION.md](./SPECIFICATION.md) ‚Äî –ü–æ–ª–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã
- [CHANGELOG.md](../CHANGELOG.md) ‚Äî –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
- [API_RESULT_FLOW.md](./API_RESULT_FLOW.md) ‚Äî –°—Ç—Ä—É–∫—Ç—É—Ä–∞ API –æ—Ç–≤–µ—Ç–æ–≤
- [REFACTORING_PLAN.md](./REFACTORING_PLAN.md) ‚Äî –ü–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞
- [REFACTORING_PROGRESS.md](./REFACTORING_PROGRESS.md) ‚Äî –ü—Ä–æ–≥—Ä–µ—Å—Å —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-12-08  
**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 1.0
